<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八字輕重計算器</title>
    <!-- Load Configuration first -->
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cnchar/cnchar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cnchar-trad/cnchar.trad.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bazi-red': '#B91C1C', // Deep red
                        'bazi-gray': '#F3F4F6', // Light gray bg
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            color: #333;
            background-color: #fcfbf9;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='12' viewBox='0 0 20 12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 12c0-.622-.095-1.221-.27-1.785A5.982 5.982 0 0 0 10 12c1.654 0 3.153-.67 4.27-1.785A5.998 5.998 0 0 0 14 12h2a7.994 7.994 0 0 1-4.002-6.9ch-4.002A7.995 7.995 0 0 1 4 12H6z' fill='%23b91c1c' fill-opacity='0.04' fill-rule='evenodd'/%3E%3C/svg%3E");
            background-attachment: fixed;
        }

        .serif-font {
            font-family: 'Noto Serif TC', serif;
        }

        /* Custom Checkbox/Radio Styles */
        input[type="radio"] {
            accent-color: #B91C1C;
        }

        .form-input {
            border: 1px solid #D1D5DB;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            text-align: center;
        }

        .dashed-line {
            border-bottom: 1px dashed #E5E7EB;
            margin: 1.5rem 0;
        }

        .red-border-box {
            border-top: 2px solid #B91C1C;
            border-bottom: 2px solid #B91C1C;
            background-color: #FAFAFA;
        }
    </style>
</head>

<body class="min-h-screen py-8 px-4 flex justify-center items-start">
    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[100] hidden flex items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-red-800 mb-4"></div>
            <p class="text-gray-700 font-medium tracking-widest text-sm">請稍等...</p>
        </div>
    </div>

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-2xl p-8 md:p-16 relative mx-auto">

        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-8">
            <button onclick="switchTab('bazi')" id="tab-btn-bazi"
                class="flex-1 py-4 text-center font-bold text-red-800 border-b-2 border-red-800 transition-colors">
                八字批算
            </button>
            <button onclick="switchTab('name')" id="tab-btn-name"
                class="flex-1 py-4 text-center font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600 hover:bg-gray-50 transition-colors">
                姓名批算
            </button>
        </div>

        <!-- Bazi Content -->
        <div id="tab-bazi" class="animate-[fadeIn_0.5s_ease-out]">

            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold mb-2 text-black">八字批算</h1>
                <p class="text-gray-500 text-sm tracking-widest">知命而後立命，運籌帷幄之中</p>
            </div>

            <!-- Form Section -->
            <div class="max-w-2xl mx-auto mb-16">



                <!-- Gender Selection -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2 text-sm">性別</label>
                    <div class="flex gap-6 items-center">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="gender" value="male" checked
                                class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300">
                            <span class="ml-2 text-sm">男</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="gender" value="female"
                                class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300">
                            <span class="ml-2 text-sm">女</span>
                        </label>
                    </div>
                </div>

                <!-- Birth Date Selection -->
                <div class="mb-8">
                    <label class="block text-gray-700 font-medium mb-2 text-sm">國歷出生時間</label>
                    <div class="flex flex-wrap items-center gap-2">
                        <div class="relative w-40">
                            <select id="inputYear"
                                class="w-full form-input appearance-none bg-white pr-6 cursor-pointer text-sm py-1.5 focus:outline-none focus:border-red-800">
                            </select>
                            <span class="absolute right-2 top-1.5 text-xs text-gray-400 pointer-events-none">▼</span>
                        </div>
                        <span class="text-sm text-gray-500">年</span>

                        <div class="relative w-16">
                            <select id="inputMonth"
                                class="w-full form-input appearance-none bg-white pr-4 cursor-pointer text-sm py-1.5 focus:outline-none focus:border-red-800 text-center">
                            </select>
                        </div>
                        <span class="text-sm text-gray-500">月</span>

                        <div class="relative w-16">
                            <select id="inputDay"
                                class="w-full form-input appearance-none bg-white pr-4 cursor-pointer text-sm py-1.5 focus:outline-none focus:border-red-800 text-center">
                            </select>
                        </div>
                        <span class="text-sm text-gray-500">日</span>

                        <div class="relative w-28">
                            <select id="inputTime"
                                class="w-full form-input appearance-none bg-white pr-6 cursor-pointer text-sm py-1.5 focus:outline-none focus:border-red-800 text-center">
                                <option value="zi">子 (23-01)</option>
                                <option value="chou">丑 (01-03)</option>
                                <option value="yin">寅 (03-05)</option>
                                <option value="mao">卯 (05-07)</option>
                                <option value="chen">辰 (07-09)</option>
                                <option value="si">巳 (09-11)</option>
                                <option value="wu">午 (11-13)</option>
                                <option value="wei">未 (13-15)</option>
                                <option value="shen">申 (15-17)</option>
                                <option value="you">酉 (17-19)</option>
                                <option value="xu">戌 (19-21)</option>
                                <option value="hai">亥 (21-23)</option>
                            </select>
                            <span class="absolute right-2 top-1.5 text-xs text-gray-400 pointer-events-none">▼</span>
                        </div>
                        <span class="text-sm text-gray-500">時</span>
                    </div>
                </div>

                <!-- Car and Phone Inputs -->
                <div class="flex gap-4 mt-8 mb-2">
                    <div class="flex-1 text-left">
                        <label class="block text-gray-700 font-medium mb-1 text-sm">車牌號碼 <span
                                class="text-xs text-gray-400 font-normal">(選填)</span></label>
                        <input type="text" id="inputCarNumber"
                            class="w-full form-input py-2 focus:border-red-800 outline-none text-center tracking-widest placeholder-gray-300"
                            placeholder="請輸入車牌" maxlength="10">
                    </div>
                    <div class="flex-1 text-left">
                        <label class="block text-gray-700 font-medium mb-1 text-sm">電話號碼 <span
                                class="text-xs text-gray-400 font-normal">(選填)</span></label>
                        <input type="text" id="inputPhoneNumber"
                            class="w-full form-input py-2 focus:border-red-800 outline-none text-center tracking-widest placeholder-gray-300"
                            placeholder="請輸入手機" maxlength="20">
                    </div>
                </div>

                <button onclick="handleCalculate()"
                    class="w-full mt-4 bg-gradient-to-r from-red-800 to-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl hover:from-red-700 hover:to-red-500 transition-all flex items-center justify-center group overflow-hidden relative">
                    <span
                        class="absolute w-64 h-64 mt-12 group-hover:-rotate-45 group-hover:-mt-24 transition-all duration-1000 ease-out -left-10 bg-white opacity-10 rotate-45"></span>
                    <span class="relative flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 animate-pulse" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        開始批算
                    </span>
                </button>

                <button onclick="handleReload()"
                    class="w-full mt-3 bg-gray-100 border border-gray-200 text-gray-500 hover:bg-gray-200 hover:text-gray-700 font-medium py-2.5 rounded shadow-sm transition-all text-sm">
                    重置
                </button>

                <p class="text-xs text-center text-gray-400 mt-4 leading-relaxed">
                    測算結果僅反映先天的運勢，不代表最終定論。<br>人生充滿變數，積極作為才是改變命運的核心。
                </p>
            </div>

            <div class="border-t border-gray-100 my-10"></div>

            <!-- Result Area -->
            <div id="resultArea" class="hidden mx-auto space-y-12 animate-[fadeIn_0.5s_ease-out]">

                <!-- 1. Four Pillars Section (Data + Analysis) -->
                <div class="text-center mb-6 mt-2">
                    <span class="text-lg font-bold text-gray-400 tracking-widest">四柱命盤淺析</span>
                </div>

                <div class="grid grid-cols-4 gap-4">
                    <div class="bg-gray-50 rounded p-4 text-center">
                        <div class="text-xs text-gray-400 mb-1">年柱</div>
                        <div class="font-bold text-gray-800 text-lg font-serif" id="pillarYear">- -</div>
                    </div>
                    <div class="bg-gray-50 rounded p-4 text-center">
                        <div class="text-xs text-gray-400 mb-1">月柱</div>
                        <div class="font-bold text-gray-800 text-lg font-serif" id="pillarMonth">- -</div>
                    </div>
                    <div class="bg-gray-50 rounded p-4 text-center">
                        <div class="text-xs text-gray-400 mb-1">日柱</div>
                        <div class="font-bold text-gray-800 text-lg font-serif" id="pillarDay">- -</div>
                    </div>
                    <div class="bg-gray-50 rounded p-4 text-center">
                        <div class="text-xs text-gray-400 mb-1">時柱</div>
                        <div class="font-bold text-gray-800 text-lg font-serif" id="pillarTime">- -</div>
                    </div>
                </div>

                <!-- 2. Four Pillars Plain Analysis Section -> Refactored to Comprehensive Analysis -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6" id="fourPillarsPlain">
                    <!-- Character Card -->
                    <!-- Character Card (Blue Theme) -->
                    <div
                        class="bg-gradient-to-br from-white to-blue-50 border border-blue-100 rounded-xl p-6 shadow-md relative overflow-hidden group">
                        <div
                            class="absolute top-0 right-0 w-24 h-24 bg-blue-100 rounded-bl-full -mr-10 -mt-10 opacity-60 group-hover:bg-blue-200 transition-colors">
                        </div>
                        <h5 class="text-blue-700 font-bold mb-1 text-base flex items-center">
                            <span class="w-2 h-6 bg-blue-700 mr-2 rounded-full"></span>
                            性格特質
                        </h5>
                        <p class="text-xs text-gray-400 mb-4">個性優勢 | 盲點 | 行事風格</p>
                        <div class="space-y-3">
                            <p class="text-sm text-gray-700 leading-relaxed text-justify font-medium"
                                id="analysisCharacter">
                                <!-- Dynamic Content -->
                            </p>
                        </div>
                    </div>

                    <!-- Wealth Card -->
                    <!-- Wealth Card (Emerald/Green Theme) -->
                    <div
                        class="bg-gradient-to-br from-white to-emerald-50 border border-emerald-100 rounded-xl p-6 shadow-md relative overflow-hidden group">
                        <div
                            class="absolute top-0 right-0 w-24 h-24 bg-emerald-100 rounded-bl-full -mr-10 -mt-10 opacity-60 group-hover:bg-emerald-200 transition-colors">
                        </div>
                        <h5 class="text-emerald-700 font-bold mb-1 text-base flex items-center">
                            <span class="w-2 h-6 bg-emerald-700 mr-2 rounded-full"></span>
                            財運運勢
                        </h5>
                        <p class="text-xs text-gray-400 mb-4">正財偏財 | 理財建議 | 財富來源</p>
                        <div class="space-y-3">
                            <p class="text-sm text-gray-700 leading-relaxed text-justify font-medium"
                                id="analysisWealth">
                                <!-- Dynamic Content -->
                            </p>
                        </div>
                    </div>

                    <!-- Career Pillar -->
                    <div
                        class="bg-gradient-to-br from-white to-red-50 border border-red-100 rounded-xl p-6 shadow-md relative overflow-hidden group md:col-span-2">
                        <div
                            class="absolute top-0 right-0 w-24 h-24 bg-red-100 rounded-bl-full -mr-10 -mt-10 opacity-60">
                        </div>
                        <h5 class="text-red-700 font-bold mb-1 text-lg flex items-center">
                            <span class="w-2 h-6 bg-red-700 mr-2 rounded-full"></span>
                            事業運勢
                        </h5>
                        <p class="text-xs text-gray-400 mb-4">職涯方向 | 適合領域 | 成功關鍵</p>
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm text-gray-700 leading-relaxed text-justify font-medium"
                                    id="analysisCareer">
                                    <!-- Dynamic Content -->
                                </p>
                            </div>
                            <div id="analysisCareerExtra" class="mt-2 text-justify">
                                <!-- Dynamic Careers List -->
                            </div>
                        </div>
                    </div>

                    <!-- Love Pillar -->
                    <!-- Love Pillar (Pink/Rose Theme) -->
                    <div
                        class="bg-gradient-to-br from-white to-pink-50 border border-pink-100 rounded-xl p-6 shadow-md relative overflow-hidden group md:col-span-2">
                        <div
                            class="absolute top-0 right-0 w-24 h-24 bg-pink-100 rounded-bl-full -mr-10 -mt-10 opacity-60 group-hover:bg-pink-200 transition-colors">
                        </div>
                        <h5 class="text-pink-700 font-bold mb-1 text-base flex items-center">
                            <span class="w-2 h-6 bg-pink-700 mr-2 rounded-full"></span>
                            感情人際
                        </h5>
                        <p class="text-xs text-gray-400 mb-4">桃花運勢 | 相處之道 | 人際魅力</p>
                        <div class="space-y-3">
                            <p class="text-sm text-gray-700 leading-relaxed text-justify font-medium" id="analysisLove">
                                <!-- Dynamic -->
                            </p>
                        </div>
                    </div>
                </div>



                <div class="dashed-line"></div>

                <!-- 3. Weight Display + Poem & Analysis (Yuan Tiangang) -->
                <div class="space-y-12">
                    <!-- Weight Display -->
                    <div class="text-center">
                        <h3 class="text-red-700 text-xs font-bold mb-2 tracking-wider">袁天罡稱骨</h3>
                        <div class="text-6xl font-serif text-gray-800 mb-3" id="totalWeightDisplay">
                            <!-- Calculated Weight -->
                        </div>
                        <p class="text-xs text-gray-400">
                            基數 :
                            年<span id="yearW"></span> +
                            月<span id="monthW"></span> +
                            日<span id="dayW"></span> +
                            時<span id="timeW"></span>
                        </p>
                    </div>

                    <!-- Poem Box -->
                    <div class="red-border-box p-6 text-center">
                        <p id="mainPoem" class="text-xl md:text-xl text-gray-700 leading-loose font-serif">
                            <!-- Poem goes here -->
                        </p>
                    </div>

                    <!-- Detailed Explanations -->
                    <div class="space-y-2">
                        <div class="text-center mb-8">
                            <span class="text-lg font-bold text-gray-400 tracking-widest">歌訣詳解</span>
                        </div>

                        <!-- Analysis Items (Generated from Poem) -->
                        <div id="poemAnalysis" class="space-y-8">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </div>

                <!-- 4. Character Analysis -->


                <div class="mt-8 bg-[#FAFAFA] border-l-[6px] border-[#B91C1C] p-6">
                    <h4 class="text-[#B91C1C] font-bold mb-4 text-lg tracking-wider">給此命格的建議</h4>
                    <div id="descAdvice" class="space-y-3 text-gray-700 text-sm leading-relaxed text-justify">
                        <!-- Dynamic List -->
                    </div>
                </div>

                <div class="border-b border-dashed border-gray-200 my-6"></div>

                <!-- 2.5 Five Elements & Crystal Section (Moved to Bottom) -->
                <div class="space-y-6">
                    <div class="text-center mb-4">
                        <span class="text-lg font-bold text-gray-400 tracking-widest">五行盈缺與水晶建議</span>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-6 border border-gray-100" id="fiveElementsContainer">
                        <!-- Dynamic Content -->
                    </div>
                </div>

                <!-- AI Analysis Button (Zen Ink Style) -->
                <!-- AI Analysis Button (Updated Style) -->
                <button onclick="handleAIAnalysis()" id="aiBtn"
                    class="w-full mb-6 mt-4 bg-gradient-to-r from-red-800 to-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl hover:from-red-700 hover:to-red-500 transition-all flex items-center justify-center group overflow-hidden relative">
                    <span
                        class="absolute w-64 h-64 mt-12 group-hover:-rotate-45 group-hover:-mt-24 transition-all duration-1000 ease-out -left-10 bg-white opacity-10 rotate-45"></span>
                    <span class="relative flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 animate-pulse" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                        八字AI總結
                    </span>
                </button>

                <!-- AI Result Section (Zen Ink Style) -->
                <div id="aiResultArea" class="hidden mb-6 relative animate-[fadeIn_1s_ease-out]">
                    <div class="bg-white border-y-4 border-stone-900 py-10 px-8 relative shadow-xl">
                        <div
                            class="absolute -top-10 -left-10 w-40 h-40 bg-stone-100 rounded-full opacity-50 mix-blend-multiply filter blur-xl pointer-events-none">
                        </div>

                        <div class="flex flex-col items-center mb-10 relative z-10">
                            <h5
                                class="text-stone-900 font-serif text-2xl tracking-[0.3em] font-light border-b border-stone-300 pb-4">
                                禪 機 一 語</h5>
                        </div>

                        <div id="aiContent"
                            class="relative z-10 text-base text-stone-800 leading-8 text-justify font-serif tracking-wide px-2 whitespace-pre-wrap">
                        </div>

                        <div id="aiLoading"
                            class="hidden flex flex-col items-center justify-center py-12 relative z-10">
                            <div class="w-3 h-3 bg-stone-800 rounded-full animate-ping mb-6"></div>
                            <span class="text-sm text-stone-500 font-serif tracking-[0.5em]">靜 心 候 教 ...</span>
                        </div>
                    </div>
                </div>

                <button onclick="handleReload()"
                    class="w-full bg-gray-100 border border-gray-200 text-gray-500 hover:bg-gray-200 hover:text-gray-700 font-medium py-3 rounded shadow-sm transition-all text-sm tracking-widest">
                    重置
                </button>
            </div>
        </div> <!-- End tab-bazi -->

        <!-- Name Content -->
        <div id="tab-name" class="hidden animate-[fadeIn_0.5s_ease-out]">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold mb-2 text-black">姓名批算</h1>
                <p class="text-gray-500 text-sm tracking-widest">名不正則言不順，言不順則事不成</p>
            </div>

            <div class="max-w-2xl mx-auto mb-16">
                <div class="flex gap-4 mb-6">
                    <div class="flex-1">
                        <label class="block text-gray-700 font-medium mb-2 text-sm">姓氏</label>
                        <input type="text" id="inputSurname"
                            class="w-full form-input py-2.5 focus:border-red-800 outline-none" placeholder="輸入姓氏">
                    </div>
                    <div class="flex-1">
                        <label class="block text-gray-700 font-medium mb-2 text-sm">名字</label>
                        <input type="text" id="inputName"
                            class="w-full form-input py-2.5 focus:border-red-800 outline-none" placeholder="輸入名字">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2 text-sm">性別</label>
                    <div class="flex gap-6 items-center ">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="genderName" value="male" checked
                                class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300">
                            <span class="ml-2 text-sm">男</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="genderName" value="female"
                                class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300">
                            <span class="ml-2 text-sm">女</span>
                        </label>
                    </div>
                </div>

                <!-- Birth Date Selection (Name Analysis) -->
                <div class="mb-8">
                    <label class="block text-gray-700 font-medium mb-2 text-sm">國歷出生時間</label>
                    <div class="flex flex-wrap items-center gap-2">
                        <div class="relative w-40">
                            <select id="inputNameYear"
                                class="w-full form-input appearance-none bg-white pr-6 cursor-pointer text-sm py-1.5 focus:outline-none focus:border-red-800">
                            </select>
                            <span class="absolute right-2 top-1.5 text-xs text-gray-400 pointer-events-none">▼</span>
                        </div>
                        <span class="text-sm text-gray-500">年</span>

                        <div class="relative w-16">
                            <select id="inputNameMonth"
                                class="w-full form-input appearance-none bg-white pr-4 cursor-pointer text-sm py-1.5 focus:outline-none focus:border-red-800 text-center">
                            </select>
                        </div>
                        <span class="text-sm text-gray-500">月</span>

                        <div class="relative w-16">
                            <select id="inputNameDay"
                                class="w-full form-input appearance-none bg-white pr-4 cursor-pointer text-sm py-1.5 focus:outline-none focus:border-red-800 text-center">
                            </select>
                        </div>
                        <span class="text-sm text-gray-500">日</span>

                        <div class="relative w-28">
                            <select id="inputNameTime"
                                class="w-full form-input appearance-none bg-white pr-6 cursor-pointer text-sm py-1.5 focus:outline-none focus:border-red-800 text-center">
                                <option value="zi">子 (23-01)</option>
                                <option value="chou">丑 (01-03)</option>
                                <option value="yin">寅 (03-05)</option>
                                <option value="mao">卯 (05-07)</option>
                                <option value="chen">辰 (07-09)</option>
                                <option value="si">巳 (09-11)</option>
                                <option value="wu">午 (11-13)</option>
                                <option value="wei">未 (13-15)</option>
                                <option value="shen">申 (15-17)</option>
                                <option value="you">酉 (17-19)</option>
                                <option value="xu">戌 (19-21)</option>
                                <option value="hai">亥 (21-23)</option>
                            </select>
                            <span class="absolute right-2 top-1.5 text-xs text-gray-400 pointer-events-none">▼</span>
                        </div>
                        <span class="text-sm text-gray-500">時</span>
                    </div>
                </div>

                <!-- Direct AI Analysis Button -->
                <button onclick="handleDirectNameAI()" id="aiNameBtn"
                    class="w-full mt-4 bg-gradient-to-r from-red-800 to-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl hover:from-red-700 hover:to-red-500 transition-all flex items-center justify-center group overflow-hidden relative">
                    <span
                        class="absolute w-64 h-64 mt-12 group-hover:-rotate-45 group-hover:-mt-24 transition-all duration-1000 ease-out -left-10 bg-white opacity-10 rotate-45"></span>
                    <span class="relative flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 animate-pulse" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        開始批算
                    </span>
                </button>

                <button onclick="handleReload()"
                    class="w-full mt-3 bg-gray-100 border border-gray-200 text-gray-500 hover:bg-gray-200 hover:text-gray-700 font-medium py-2.5 rounded shadow-sm transition-all text-sm">
                    重置
                </button>

                <p class="text-xs text-center text-gray-400 mt-6 leading-relaxed">
                    名字是父母給的第一份禮物，但人生是自己走出來的路。<br>此分析旨在探索姓名特質，希望提供一些有趣的視角，而非絕對的定義。
                </p>

                <!-- Name Result Area (AI Only) -->
                <div id="nameResultArea" class="hidden mt-3 space-y-6">
                    <div id="aiNameResultArea" class="hidden relative">
                        <!-- Content Box -->
                        <div class="prose prose-red max-w-none bg-gray-50 p-6 rounded-lg shadow-inner text-sm leading-relaxed text-gray-700"
                            id="aiNameContent">
                            <!-- AI Content -->
                        </div>

                        <!-- Loading State (Yin Yang Pulse) -->
                        <div id="aiNameLoading"
                            class="absolute inset-0 bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center z-10 hidden transition-all duration-300">
                            <div class="relative w-24 h-24 mb-6 animate-[spin_4s_linear_infinite]">
                                <div class="absolute inset-0 rounded-full border-4 border-gray-200"></div>
                                <div
                                    class="absolute inset-0 rounded-full border-t-4 border-l-4 border-black box-border opacity-80">
                                </div>
                                <div
                                    class="absolute top-1/2 left-1/2 w-4 h-4 bg-black rounded-full -translate-x-1/2 -translate-y-3 shadow-lg">
                                </div>
                                <div
                                    class="absolute top-1/2 left-1/2 w-4 h-4 bg-white border border-gray-200 rounded-full -translate-x-1/2 translate-y-[-0.2rem]">
                                </div>
                            </div>
                            <p class="text-gray-800 font-serif text-lg tracking-[0.3em] animate-pulse font-medium">
                                運算中...</p>
                        </div>
                    </div>

                    <button onclick="handleReload()" id="nameAiResetBtn"
                        class="w-full mt-6 bg-gray-100 border border-gray-200 text-gray-500 hover:bg-gray-200 hover:text-gray-700 font-medium py-3 rounded shadow-sm transition-all text-sm tracking-widest">
                        重置
                    </button>
                </div>
            </div>

            <!-- Grid for Ge -->

        </div>
    </div>
    </div>
    </div>

    <script>
        // --- DATA & LOGIC ---
        // (Reusing existing logic logic with updated DOM targets)
        const jiaZi = [
            "甲子", "乙丑", "丙寅", "丁卯", "戊辰", "己巳", "庚午", "辛未", "壬申", "癸酉",
            "甲戌", "乙亥", "丙子", "丁丑", "戊寅", "己卯", "庚辰", "辛巳", "壬午", "癸未",
            "甲申", "乙酉", "丙戌", "丁亥", "戊子", "己丑", "庚寅", "辛卯", "壬辰", "癸巳",
            "甲午", "乙未", "丙申", "丁酉", "戊戌", "己亥", "庚子", "辛丑", "壬寅", "癸卯",
            "甲辰", "乙巳", "丙午", "丁未", "戊申", "己酉", "庚戌", "辛亥", "壬子", "癸丑",
            "甲寅", "乙卯", "丙辰", "丁巳", "戊午", "己未", "庚申", "辛酉", "壬戌", "癸亥"
        ];

        // Simplified weights for demo
        const yearWeightsMap = {
            "甲子": 12, "丙子": 16, "戊子": 15, "庚子": 7, "壬子": 5,
            "乙丑": 9, "丁丑": 8, "己丑": 7, "辛丑": 7, "癸丑": 7,
            "丙寅": 6, "戊寅": 8, "庚寅": 9, "壬寅": 9, "甲寅": 12,
            "丁卯": 7, "己卯": 19, "辛卯": 12, "癸卯": 12, "乙卯": 8,
            "戊辰": 12, "庚辰": 12, "壬辰": 10, "甲辰": 8, "丙辰": 8,
            "己巳": 5, "辛巳": 6, "癸巳": 7, "乙巳": 7, "丁巳": 6,
            "庚午": 9, "壬午": 8, "甲午": 15, "丙午": 13, "戊午": 19,
            "辛未": 8, "癸未": 7, "乙未": 6, "丁未": 5, "己未": 6,
            "壬申": 7, "甲申": 5, "丙申": 5, "戊申": 14, "庚申": 8,
            "癸酉": 8, "乙酉": 15, "丁酉": 14, "己酉": 5, "辛酉": 16,
            "甲戌": 15, "丙戌": 6, "戊戌": 14, "庚戌": 9, "壬戌": 10,
            "乙亥": 9, "丁亥": 16, "己亥": 9, "辛亥": 17, "癸亥": 6
        };
        const monthWeights = [6, 7, 18, 9, 5, 16, 9, 15, 18, 8, 9, 5];
        const dayWeights = [5, 10, 8, 15, 16, 15, 8, 16, 8, 16, 9, 17, 8, 17, 10, 8, 9, 18, 5, 15, 10, 9, 8, 9, 15, 18, 7, 8, 16, 6];
        const timeWeights = { "zi": 16, "chou": 6, "yin": 7, "mao": 10, "chen": 9, "si": 16, "wu": 10, "wei": 8, "shen": 8, "you": 9, "xu": 6, "hai": 6 };

        const poems = {
            male: {
                21: "短命非業謂大凶，平生災難事重重，兇禍頻臨限逆境，終世困苦事不成",
                22: "身寒骨冷苦伶仃，此命推來行乞人，勞勞碌碌無度日，中年打拱過平生",
                23: "此命推來骨輕輕，求謀做事事難成，妻兒兄弟應難許，別處他鄉作散人",
                24: "此命推來福祿無，門庭困苦總難榮，六親骨肉皆無靠，流到他鄉作老人",
                25: "此命推來祖業微，門庭營度似希奇，六親骨肉如水炭，一世勤勞自把持",
                26: "平生一路苦中求，獨自營謀事不休，離祖出門宜早計，晚來衣祿自無憂",
                27: "一生做事少商量，難靠祖宗作主張，獨馬單槍空作去，早年晚歲總無長",
                28: "一生作事似飄蓬，祖宗產業在夢中，若不過房並改姓，也當移徒二三通",
                29: "初年運限未曾亨，縱有功名在後成，須過四旬方可上，移居改姓使為良",
                30: "勞勞碌碌苦中求，東走西奔何日休，若能終身勤與儉，老來稍可免憂愁",
                31: "忙忙碌碌苦中求，何日雲開見日頭，難得祖基家可立，中年衣食漸無憂",
                32: "初年運錯事難謀，漸有財源如水流，到的中年衣食旺，那時名利一齊來",
                33: "早年做事事難成，百計徒勞枉費心，半世自如流水去，後來運到始得金",
                34: "此命福氣果如何，僧道門中衣祿多，離祖出家方得妙，終朝拜佛念彌陀",
                35: "生平福量不周全，祖業根基覺少傳，營事生涯宜守舊，時來衣食勝從前",
                36: "不須勞碌過平生，獨自成家福不輕，早有福星常照命，任君行去百般成",
                37: "此命般般事不成，弟兄少力自孤成，雖然祖業須微有，來的明時去的暗",
                38: "一生骨肉最清高，早入學門姓名標，待看年將三十六，藍衣脫去換紅袍",
                39: "此命終身運不通，勞勞做事盡皆空，苦心竭力成家計，到得那時在夢中",
                40: "平生衣祿是綿長，件件心中自主張，前面風霜都受過，從來必定享安泰",
                41: "此命推來事不同，為人能幹異凡庸，中年還有逍遙福，不比前年雲未通",
                42: "得寬懷處且寬懷，何用雙眉總不開，若使中年命運濟，那時名利一齊來",
                43: "為人心性最聰明，做事軒昂近貴人，衣祿一生天數定，不須勞碌是豐亨",
                44: "來事由天莫苦求，須知福祿勝前途，當年財帛難如意，晚景欣然便不憂",
                45: "福中取貴格求真，明敏才華志自伸，福祿壽全家道吉，桂蘭毓秀晚榮臻",
                46: "東西南北盡皆通，出姓移名更覺隆，衣祿無虧天數定，中年晚景一般同",
                47: "此命推來旺末年，妻榮子貴自怡然，平生原有滔滔福，可有財源如水流",
                48: "幼年運道未曾享，苦是蹉跎再不興，兄弟六親皆無靠，一身事業晚年成",
                49: "此命推來福不輕，自立自成顯門庭，從來富貴人親近，使婢差奴過一生",
                50: "為利為名終日勞，中年福祿也多遭，老來是有財星照，不比前番目下高",
                51: "一世榮華事事通，不須勞碌自亨通，兄弟叔侄皆如意，家業成時福祿宏",
                52: "一世亨通事事能，不須勞思自然能，宗施欣然心皆好，家業豐亨自稱心",
                53: "此格推來氣象真，興家發達在其中，一生福祿安排定，卻是人間一富翁",
                54: "此命推來厚且清，詩書滿腹看功成，豐衣足食自然穩，正是人間有福人",
                55: "走馬揚鞭爭名利，少年做事廢籌論，一朝福祿源源至，富貴榮華顯六親",
                56: "此格推來禮儀通，一生福祿用無窮，甜酸苦辣皆嚐過，財源滾滾穩且豐",
                57: "福祿盈盈萬事全，一生榮耀顯雙親，名揚威震人欽敬，處世逍遙似遇春",
                58: "平生福祿自然來，名利兼全福祿偕，雁塔提名為貴客，紫袍金帶走金鞋",
                59: "細推此格妙且清，必定才高禮儀通，甲第之中應有分，揚鞭走馬顯威榮",
                60: "一朝金榜快題名，顯祖榮宗立大功，衣食定然原欲足，田園財帛更豐盈",
                61: "不做朝中金榜客，定為世上一財翁，聰明天賦經書熟，名顯高克自是榮",
                62: "此名生來福不窮，讀書必定顯親榮，紫衣金帶為卿相，富貴榮華皆可同",
                63: "命主為官福祿長，得來富貴定非常，名題金塔傳金榜，定中高科天下揚",
                64: "此格權威不可當，紫袍金帶坐高堂，榮華富貴誰能及，積玉堆金滿儲倉",
                65: "細推此命福不輕，安國安邦極品人，文繡雕樑政富貴，威聲照耀四方聞",
                66: "此格人間一福人，堆金積玉滿堂春，從來富貴由天定，正笏垂紳謁聖君",
                67: "此名生來福自宏，田園家業最高隆，平生衣祿豐盈足，一世榮華萬事通",
                68: "富貴由天莫苦求，萬金家計不須謀，十年不比前番事，祖業根基水上舟",
                69: "君是人間衣祿星，一生福貴眾人欽，縱然福祿由天定，安享榮華過一生",
                70: "此命推來福不輕，不須愁慮苦勞心，一生天定衣與祿，富貴榮華過一生",
                71: "此名生來大不同，公侯卿相在其中，一生自有逍遙福，富貴榮華極品隆",
                72: "此格世界罕有生，十代積善產此人，天上紫微來照命，統治萬民樂太平"
            },
            female: {
                21: "短命非業謂大空，平生災難事重重。兇禍頻臨陷逆境，終世困苦事不成。",
                22: "此命孤冷有淒伶，此命推來路乞人。操心煩腦度平日，一生育苦度光陰。",
                23: "此命推來骨肉輕，求財謀事事難成。弟妹六親無有靠，繁鞝家事難以持。",
                24: "此命推來福祿無，家務辛苦難以扶。丈夫兒女皆無靠，流落他鄉作游孤。",
                25: "此命推來八字輕，六庭艱辛多苦淒。娘家六友冷如灰，一生操勞多憂心。",
                26: "平生衣祿苦尋求，女命生來帶憂愁。辛酸苦辣他嚐過，晚年衣缽本無憂。",
                27: "竹平做事少間量，難靠夫君做主張。心問口來口問心，自做主張過光陰。",
                28: "女命生來八字經，得善做事一無情。你把別人當親生，別人對你假殷情。",
                29: "花枝要來性情硬，自奔自立不求人。若向求財方可止，有苦有甜度光陰。",
                30: "此命推來比郎強，婚姻大事礙無防。中年走過坎坷運，末年漸比先前強。",
                31: "早年行運在忙碌，勞碌奔波苦中求。自奔自愁把家立，後來晚景無憂愁。",
                32: "時逢吉神在運中，縱有兇處不為兇。真變假來假變真，結拜弟妹當親生。",
                33: "八字命來張張薄，勤儉持家皆可過。年華巴如流水過，末年運至受福祿。",
                34: "矮巴勾棗難撈枝，好人尋命不投機。謀望獻身最費力，婚姻同移總是虛。",
                35: "女子走冰怕冰薄，交易出行犯琢磨。婚姻周郎休此意，官司口舌須要知。",
                36: "憂愁常鎖兩眉間，女命萬緒掛心頭。從今以後防口角，任意行而不相天。",
                37: "此命來時運費多，此作推車受折磨。山路崎嶇吊下耳，左插右安安不著。",
                38: "鳳鳴岐山聞四方，女命逢之大吉昌。走失夫君音有信，晚年衣祿人財多。",
                39: "此命推來運不通，勞碌奔波一場空。好像俊鳥關籠中，中年末限起秋風。",
                40: "目上月令如運關，千心萬苦受煎熬。女子苦難受過來，晚年福康比花艷。",
                41: "此命推來普普通通，女子為人很非凡。中年逍遙多自在，晚年更比中年強。",
                42: "枯井破廢已多年，一朝泉水出來鮮。資生濟竭人稱美，來運轉喜自然時。",
                43: "推車靠涯道路趕，女命求財也費難。婚姻出行無陰礙，疾病口舌多安寧。",
                44: "夜夢金銀醒來空，女子謀事運不能。婚姻難成交易獲，夫君走失不見蹤。",
                45: "此命終身駁雜多，六親骨肉不相助。命中男婦都難養，勞碌辛苦還奔波。",
                46: "孤舟得水離沙灘，女命出外早遠家。是非口舌皆無礙，婚姻合夥更不差。",
                47: "時來運轉吉氣發，多年枯木又開花。枝葉重生多茂盛，凡人見了凡人夸。",
                48: "一朵鮮花鏡中開，看著極好取不來。勸你休把鏡花想，女命推業主可怪。",
                49: "此命推來福不輕，女子隨君顯門庭。容貌美滿熱人愛，銀錢富足過一生。",
                50: "馬氏太公不相和，好命逢之尤凝多。恩人無義反成怨，是非平地起風波。",
                51: "肥羊失群入山崗，餓虎逢之把口張。適口充腸心歡喜，女名八安大吉昌。",
                52: "順風行舟扯起棚，上天又助一順風。不用費力逍遙去，任意而行大亨通。",
                53: "此命相貌眉活秀，文武雙全功名成。一生衣祿皆無愁，可算世上有福人。",
                54: "學問滿腹運氣強，謀望求財大吉祥。交易出行大得意，是非口舌皆無妨。",
                55: "吉祥平安志量高，女命求財任逍遙。交易婚姻大有意，夫君在外有音耗。",
                56: "明珠書士離埃來，女命口角消散開。走失郎君當兩歸，交易有成水無災。",
                57: "游魚戲水被網驚，跳過龍門秧化龍。三根楊柳垂金線，萬朵桃花顯價能。",
                58: "此命推來閒逛悠，時運未來莫強求。幸得今日重反點，自有好運在後頭。",
                59: "雨雪載途泥濘至，交易不定難出行。疾病還拉慢婚姻，謀望求財事不成。",
                60: "女命八字喜氣和，謀望求財吉慶多。口舌漸消疾病少，夫君走失歸老窩。",
                61: "緣木求魚事多端，雖不得魚無後害。若是行險弄巧地，事不遂心枉安排。",
                62: "指日升高氣象新，走失待人有音信。好命遇事遂心好，伺病口舌皆除根。",
                63: "五官脫運難抬頭，女命須當把財求。交易少行有人助，疾病口舌不須愁。",
                64: "俊鳥曾得出籠中，脫離災難顯威風。一朝得意福立至，東南西北任意行。",
                65: "此命推來福不輕，慈善為事受人敬。天降文王開基業，富貴榮華八百年。",
                66: "時來運轉銳氣周，賢惠淑女君子求。釧鼓樂之大吉慶，女名逢之吉悠悠。",
                67: "亂絲無頭定有頭，碰著閒磨且暫推。交易出有無好處，謀事求財心不遂。",
                68: "水庭明月不可撈，女命早限命不高。交易出行難獲得，末限命運漸漸好。",
                69: "太公封祖不非凡，女子求財穩如山。交易合夥大吉慶，疾病口角消除安。",
                70: "此命推來喜氣新，郎君遇著多遂心。女命交了順當運，富貴衣祿平樂生。",
                71: "此命推來鴻運交，再不需愁來苦勞。一生身有衣祿福，按享榮華在其中。"
            }
        };

        // Lunar Calendar Helper (Legacy compressed data)
        const lunarInfo = [0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2, 0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977, 0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970, 0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950, 0x04da0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557, 0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5d0, 0x14573, 0x052d0, 0x0a9a8, 0x0e950, 0x06aa0, 0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0, 0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b5a0, 0x195a6, 0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570, 0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0, 0x0c960, 0x0d954, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5, 0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930, 0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530, 0x05aa0, 0x076a3, 0x096d0, 0x04bd7, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45, 0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0, 0x14b63];

        function getLunarYearDays(y) {
            let i, sum = 348;
            for (i = 0x8000; i > 0x8; i >>= 1) sum += (lunarInfo[y - 1900] & i) ? 1 : 0;
            return (sum + leapDays(y));
        }
        function leapDays(y) {
            if (leapMonth(y)) return ((lunarInfo[y - 1900] & 0x10000) ? 30 : 29);
            else return (0);
        }
        function leapMonth(y) {
            return (lunarInfo[y - 1900] & 0xf);
        }
        function monthDays(y, m) {
            return ((lunarInfo[y - 1900] & (0x10000 >> m)) ? 30 : 29);
        }
        function solarToLunar(objDate) {
            let i, leap = 0, temp = 0;
            let offset = (Date.UTC(objDate.getFullYear(), objDate.getMonth(), objDate.getDate()) - Date.UTC(1900, 0, 31)) / 86400000;
            let dayCyl = offset + 40;
            let monCyl = 14;
            for (i = 1900; i < 2051 && offset > 0; i++) { temp = getLunarYearDays(i); offset -= temp; monCyl += 12; }
            if (offset < 0) { offset += temp; i--; monCyl -= 12; }
            let year = i;
            let yearCyl = i - 1864;
            leap = leapMonth(i);
            let isLeap = false;
            for (i = 1; i < 13 && offset > 0; i++) {
                if (leap > 0 && i == (leap + 1) && isLeap == false) { --i; isLeap = true; temp = leapDays(year); }
                else { temp = monthDays(year, i); }
                if (isLeap == true && i == (leap + 1)) isLeap = false;
                offset -= temp;
                if (isLeap == false) monCyl++;
            }
            if (offset == 0 && leap > 0 && i == leap + 1) { if (isLeap) { isLeap = false; } else { isLeap = true; --i; --monCyl; } }
            if (offset < 0) { offset += temp; --i; --monCyl; }
            return { y: year, m: i, d: offset + 1, isLeap: isLeap };
        }

        // Init
        window.onload = function () {
            checkExpiration();
            populateYears('inputYear');
            populateMonths('inputMonth');
            populateDays('inputDay');

            // Populate Name Analysis Tab inputs as well
            populateYears('inputNameYear');
            populateMonths('inputNameMonth');
            populateDays('inputNameDay');

            // Re-bind listeners (Removed to prevent resetting date on calendar switch)
            // document.querySelectorAll('input[name="calendarType"]').forEach(el => { ... });
        };

        function checkExpiration() {
            if (typeof CONFIG === 'undefined' || !CONFIG.EXPIRATION_DATE) return;

            const today = new Date();
            const expDate = new Date(CONFIG.EXPIRATION_DATE);
            // Allow the entire expiration day (set to end of day)
            expDate.setHours(23, 59, 59, 999);

            if (today > expDate) {
                document.body.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-gray-100 font-sans">
                        <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-sm mx-auto border-t-4 border-red-600">
                            <div class="text-red-600 mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">出現未知錯誤</h2>
                            <p class="text-gray-500 text-sm mt-2">錯誤碼: 1135</p>
                        </div>
                    </div>
                 `;
                throw new Error("Application Expired");
            }
        }

        function populateYears(elementId) {
            const select = document.getElementById(elementId);
            if (!select) return;
            select.innerHTML = '';
            for (let i = 1900; i <= 2050; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                if (i >= 1912) {
                    opt.text = `民國 ${i - 1911} 年 (${i})`;
                } else {
                    opt.text = `民前 ${1912 - i} 年 (${i})`;
                }
                if (i === 1990) opt.selected = true;
                select.appendChild(opt);
            }
        }
        function populateMonths(elementId) {
            const select = document.getElementById(elementId);
            if (!select) return;
            select.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                let opt = document.createElement('option');
                opt.value = i;
                opt.text = i < 10 ? '0' + i : i;
                select.appendChild(opt);
            }
        }
        function populateDays(elementId) {
            const select = document.getElementById(elementId);
            if (!select) return;
            select.innerHTML = '';
            for (let i = 1; i <= 31; i++) {
                let opt = document.createElement('option');
                opt.value = i;
                opt.text = i < 10 ? '0' + i : i;
                select.appendChild(opt);
            }
        }

        function showLoading(callback) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('hidden');
            // Small delay to ensure CSS transition can play if enabled, or just visual feedback time
            setTimeout(() => {
                if (callback) callback();
                // If it's not a reload, we define when to hide it.
                // For calculation, we hide it after processing.
                if (callback && callback.name !== 'reloadPage') {
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                    }, 500); // 0.5s visual delay for 'calculation' feeling
                }
            }, 300);
        }

        function handleCalculate() {
            showLoading(() => {
                calculateBazi();
            });
        }

        function handleReload() {
            showLoading(() => {
                // If in Name tab, clear name fields
                const nameTab = document.getElementById('tab-name');
                if (!nameTab.classList.contains('hidden')) {
                    document.getElementById('inputSurname').value = '';
                    document.getElementById('inputName').value = '';
                    document.getElementById('nameResultArea').classList.add('hidden');
                    return;
                }
                // If in Bazi tab, checking reload
                location.reload();
            });
        }

        // --- TAB LOGIC ---
        function switchTab(tab) {
            const baziTab = document.getElementById('tab-bazi');
            const nameTab = document.getElementById('tab-name');
            const baziBtn = document.getElementById('tab-btn-bazi');
            const nameBtn = document.getElementById('tab-btn-name');

            if (tab === 'bazi') {
                baziTab.classList.remove('hidden');
                nameTab.classList.add('hidden');

                baziBtn.className = "flex-1 py-4 text-center font-bold text-red-800 border-b-2 border-red-800 transition-colors";
                nameBtn.className = "flex-1 py-4 text-center font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600 hover:bg-gray-50 transition-colors";
            } else {
                baziTab.classList.add('hidden');
                nameTab.classList.remove('hidden');

                nameBtn.className = "flex-1 py-4 text-center font-bold text-red-800 border-b-2 border-red-800 transition-colors";
                baziBtn.className = "flex-1 py-4 text-center font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600 hover:bg-gray-50 transition-colors";
            }
        }

        // --- NAME ANALYSIS LOGIC ---

        // 五行 helper
        function getWuXing(num) {
            const n = num % 10;
            if (n === 1 || n === 2) return { type: "木", icon: "🌲", color: "text-green-600" };
            if (n === 3 || n === 4) return { type: "火", icon: "🔥", color: "text-red-500" };
            if (n === 5 || n === 6) return { type: "土", icon: "⛰️", color: "text-yellow-600" };
            if (n === 7 || n === 8) return { type: "金", icon: "🪙", color: "text-gray-500" };
            return { type: "水", icon: "💧", color: "text-blue-500" }; // 9, 0
        }

        // 三才配置邏輯 (Success & Foundation)
        function getSanCaiDesc(tian, ren, di) {
            const wT = getWuXing(tian).type;
            const wR = getWuXing(ren).type;
            const wD = getWuXing(di).type;

            // 五行生剋關係表 (Generative: 1, Destructive: -1, Same: 0)
            const relations = {
                "木木": 0, "木火": 1, "木土": -1, "木金": -1, "木水": 1, // 水生木(Rev), 木生火
                "火木": 1, "火火": 0, "火土": 1, "火金": -1, "火水": -1,
                "土木": -1, "土火": 1, "土土": 0, "土金": 1, "土水": -1,
                "金木": -1, "金火": -1, "金土": 1, "金金": 0, "金水": 1,
                "水木": 1, "水火": -1, "水土": -1, "水金": 1, "水水": 0
            };

            // Note: In San Cai:
            // Upper (Tian) -> Middle (Ren) : Success Luck (Can Ren be supported by Tian?)
            // Middle (Ren) -> Lower (Di) : Foundation Luck (Can Ren support Di? Or implies stability)

            // Check Success (Tian vs Ren)

            let successScore = "";
            let foundationScore = "";

            // Simplified Relationship Logic for Demo
            // Success (Ren vs Tian)
            const relRT = relations[wR + wT];

            const combo = wT + wR + wD;

            // Specific famous combinations (Demo subset)
            const specificCombos = {
                "木木木": { t: "大吉", d: "配置甚佳，基礎安泰，希望達利，且得長壽。" },
                "木火土": { t: "大吉", d: "向上進取，容易成功而富貴，基礎安穩，心身獲得長壽。" },
                "火土金": { t: "吉", d: "得祖徒之陰德，惠澤深厚，成功順達，無障礙而向上發展。" },
                "金水木": { t: "大吉", d: "成功運佳，境遇安盛，健康長壽。" },
                "水木火": { t: "大吉", d: "流動順暢，成功運佳，基礎安定，心身健全。" },
            };

            if (specificCombos[combo]) {
                return {
                    combo: `${wT} - ${wR} - ${wD}`,
                    result: specificCombos[combo].t,
                    desc: specificCombos[combo].d
                };
            }

            // Generic Logic
            // 1. Foundation (Ren -> Di)
            let fText = "基礎運一般。";
            if (relations[wR + wD] === 1) fText = "基礎安泰，能得下屬或晚輩擁護。";
            else if (relations[wR + wD] === -1) fText = "基礎不穩，易生變動，需防下屬或家庭問題。";
            else if (relations[wR + wD] === 0) fText = "基礎穩固，但稍顯單調。";

            // 2. Success (Ren -> Tian)
            let sText = "成功運平平。";
            if (relations[wT + wR] === 1) sText = "得上級提拔，成功順利。"; // Tian generates Ren
            else if (relations[wR + wT] === 1) sText = "能因長上之助而成功。"; // Ren generates Tian
            else if (relations[wT + wR] === -1 || relations[wR + wT] === -1) sText = "與長輩或上司不和，成功受阻。";

            return {
                combo: `${wT} - ${wR} - ${wD}`,
                result: (fText.includes("不穩") || sText.includes("受阻")) ? "平/凶" : "吉",
                desc: `${sText} ${fText} (此為五行生剋推演)`
            };
        }

        const STROKE_81 = {
            1: { t: "吉", d: "宇宙起源，天地開泰，大展鴻圖。", detail: "這是萬物起源之數，象徵著巨大的創造力與生命力。擁有此數者，意志堅強，具備領導才能，能夠白手起家，成就一番大事業。身體健康，名利雙收，是極佳的首領運。" },
            2: { t: "凶", d: "混沌未定，分離破敗，無力回天。", detail: "此數象徵動盪不安，運勢起伏不定。雖然看似努力，但往往事倍功半，難以達成目標。六親緣薄，易陷於孤獨無助之境，需培養堅強的毅力以補不足。" },
            3: { t: "吉", d: "陰陽和合，萬物化育，名利雙收。", detail: "陰陽調和的吉祥數理。象徵著順利、發達與成功。擁有此數者，才智過人，處事圓融，容易得到貴人相助，在社會上能夠立足並獲得眾人的敬仰，財運與名聲兼備。" },
            4: { t: "凶", d: "破壞滅亡，前途坎坷，多病多災。", detail: "此數暗示著破壞與變動，人生充滿了艱難與挑戰。易遭遇挫折、病痛或意外，身心俱疲。意志薄弱者難以承受，需特別注意身體健康，並修身養性以化解戾氣。" },
            5: { t: "吉", d: "福祿長壽，德行廣大，陰陽和合。", detail: "五行之數，中正平和。象徵著圓滿、穩健與富貴。性格溫和敦厚，人緣極佳，能夠在穩定的環境中發展事業，獲得長輩與上司的提拔，一生平安順遂，晚年得享天倫之樂。" },
            6: { t: "吉", d: "安穩餘慶，家道興隆，天降幸運。", detail: "此數象徵著天之賜福，運勢平穩安樂。為人豪爽，信守承諾，能夠繼承家業或得長輩庇蔭。雖然未必是大富大貴的驚人成就，但生活富足，名利安穩，是一生無憂的吉祥數。" },
            7: { t: "吉", d: "剛毅果斷，勇往直前，必獲成功。", detail: "陽剛之氣極強的數理。象徵著意志堅定，不畏艱難，具備排除萬難的勇氣與決心。適合獨立創業或從事開創性的工作，雖然過程可能充滿挑戰，但終能獲得巨大的成功。" },
            8: { t: "吉", d: "意志堅強，貫徹始終，大器晚成。", detail: "象徵著如鐵石般的堅強意志。雖然早年可能較為辛苦，面臨諸多考驗，但只要能堅持到底，不輕言放棄，中年過後運勢將逐漸開展，獲得遲來的成功與榮譽。" },
            9: { t: "凶", d: "興盡無力，財力難望，孤獨困苦。", detail: "此數雖然暗示著才華洋溢，但運勢卻如窮途末路。往往有才無命，懷才不遇。易陷入孤獨、貧困或病痛的困境，人生的大起大落較為劇烈，需防意外之災。" },
            10: { t: "凶", d: "萬事終局，空虛無力，雪上加霜。", detail: "數理中最凶之數之一，象徵著黑暗與空虛。努力往往徒勞無功，事業難成，家運不濟。容易遭遇連串的不幸與打擊，需特別注意心理健康，尋求心靈的寄託。" },
            11: { t: "吉", d: "草木逢春，枝葉沾露，穩健著實。", detail: "如旱地逢甘霖，象徵著復甦與生機。性格冷靜沉著，做事循序漸進，不急躁。雖然進展可能較緩慢，但基礎穩固，能夠一步一腳印地邁向成功，得享富貴榮華。" },
            12: { t: "凶", d: "薄弱無力，孤立無援，外祥內苦。", detail: "此數暗示著意志薄弱，缺乏決斷力。雖然外表看似風光，但內心常感孤獨與無助。易受他人影響，隨波逐流，難以從事獨立性的工作，宜依附強者或與人合作。" },
            13: { t: "吉", d: "才藝多能，智謀奇略，忍柔當事。", detail: "充滿智慧與才華的數理。擁有此數者，頭腦靈活，反應敏捷，具備多方面的才能。擅長謀略，能夠應對各種複雜的局勢，在學術、藝術或技藝方面易獲得成就。" },
            14: { t: "凶", d: "忍得苦難，必有後福，是成是敗。", detail: "此數為勞碌之數，人生充滿了考驗。雖然具備才華，但運勢往往不濟，容易遭遇挫折與失敗。若能培養超人的毅力，忍受常人所不能忍，或許能在大難之後獲得成功。" },
            15: { t: "吉", d: "謙恭做事，外得人和，大事成就。", detail: "最大的吉祥數之一。象徵著謙虛、圓融與德行。為人謙和有禮，深受他人喜愛與敬重，能夠匯聚人氣，獲得貴人提拔。事業順利，家庭美滿，富貴榮華之運。" },
            16: { t: "吉", d: "能獲眾望，成就大業，名利雙收。", detail: "具備領袖氣質的數理。擁有此數者，胸懷大志，氣度恢弘，能夠領導眾人，成就一番大事業。因得人心，故能集聚眾望，在社會上享有崇高的地位與名聲。" },
            17: { t: "吉", d: "排除萬難，有貴人助，把握時機。", detail: "象徵著突破與剛毅。雖然個性較為固執，容易得罪人，但因具備堅強的意志與不屈不撓的精神，能夠突破重重困難。若能修正過於剛硬的個性，善用貴人助力，定能獲得成功。" },
            18: { t: "吉", d: "經商做事，順利昌隆，如能慎始。", detail: "此數為權力與智謀的象徵。擁有此數者，意志堅定，具備謀略，適合從事公職或管理工作。雖然可能會經歷一些波折，但最終能夠克服困難，達成目標，功成名就。" },
            19: { t: "凶", d: "成功雖早，慎防空虧，內外不和。", detail: "此數暗示著聰明反被聰明誤。雖然早年可能展露頭角，獲得一時的成功，但因缺乏定性與人和，容易中途夭折或陷入困境。需防意外之災與病痛。" },
            20: { t: "凶", d: "智高志大，歷盡艱難，焦心憂勞。", detail: "雖然志向遠大，才華橫溢，但運勢卻如逆水行舟，困難重重。往往付出多而收穫少，內心常感焦慮與不安。易陷入進退兩難的局面，需防精神衰弱。" },
            21: { t: "吉", d: "專心經營，善用智慧，霜雪梅花。", detail: "象徵著如梅花般傲雪凌霜的精神。擁有此數者，獨立心強，不依賴他人，能夠憑藉自己的實力開創事業。雖然是女性的孤寡數，但對於事業發展卻是極佳的數理。" },
            22: { t: "凶", d: "秋草逢霜，懷才不遇，憂愁怨苦。", detail: "此數暗示著才華雖高，但機運不佳。如秋草逢霜，滿腹才華無處施展。容易遭遇挫折，內心充滿怨氣與不滿。人生多波折，需修身養性，培養樂觀的心態。" },
            23: { t: "吉", d: "旭日東升，名顯四方，漸次進展。", detail: "如旭日東升般氣勢磅礡的吉祥數。象徵著充滿活力與希望。擁有此數者，氣度非凡，具備領導才能，能夠在激烈的競爭中脫穎而出，成就偉大的事業。但女性需防過於強勢。" },
            24: { t: "吉", d: "錦繡前程，須靠自力，多用智謀。", detail: "白手起家的吉祥數理。象徵著聰明才智與勤奮努力。雖然起步可能一無所有，但憑藉著智慧與雙手，能夠逐步累積財富，晚年大富大貴，子孫滿堂。" },
            25: { t: "吉", d: "天時地利，再得人和，講信修睦。", detail: "資性英敏，具有獨特的才能。為人怪癖，不與人同流合汙，但因具備真才實學，仍能獲得他人的尊重。若能收斂高傲的個性，善與人處，成功指日可待。" },
            26: { t: "凶", d: "波瀾起伏，千變萬化，凌駕萬難。", detail: "此數為波瀾萬丈之象，人生充滿了變數與傳奇。雖然具備俠義心腸與英雄氣概，但運勢起伏過於劇烈，成敗往往在一線之間。需經得起大風大浪的考驗，方能有所成就。" },
            27: { t: "凶", d: "一成一敗，一盛一衰，惟靠謹慎。", detail: "此數暗示著自我中心，容易因固執己見而招致失敗。雖然中途可能獲得成功，但因缺乏人和，往往難以此持久。易受誹謗與攻擊，需多聽取他人意見，修正自己的缺失。" },
            28: { t: "凶", d: "魚臨旱地，難逃惡運，此數大凶。", detail: "數理極凶，象徵著災難與不幸。雖然豪氣干雲，但往往因行事魯莽而招致禍端。家庭運不佳，六親緣薄，易陷於孤獨。宜修身養性，行善積德，以求化解。" },
            29: { t: "吉", d: "如龍得水，青雲直上，智謀奮進。", detail: "大吉大利之數。象徵著才華橫溢，智謀過人。擁有此數者，如龍得水，能夠在社會上大展拳腳。適合從事政治、商業或與權力有關的工作，名利雙收，權勢顯達。" },
            30: { t: "凶", d: "吉凶參半，得失相伴，投機取巧。", detail: "此數為浮沉不定之象。吉凶難料，成敗全憑機運。擁有此數者，往往好賭成性，喜歡投機取巧。人生大起大落，缺乏安全感。需腳踏實地，戒除貪念。" },
            31: { t: "吉", d: "此數大吉，名利雙收，漸進向上。", detail: "智勇兼備的吉祥數理。象徵著腳踏實地，穩步向前。擁有此數者，意志堅定，做事有計劃，能夠排除萬難，達成目標。人際關係良好，家庭美滿，晚年運勢更佳。" },
            32: { t: "吉", d: "池中之龍，風雲際會，一躍上天。", detail: "如困龍得水，一飛沖天。象徵著機遇與幸運。擁有此數者，往往能在偶然的機會下獲得成功。貴人運極佳，能夠得到有力的提拔與幫助，事業發展迅速。" },
            33: { t: "吉", d: "意氣用事，人和必失，如能慎始。", detail: "此數為極剛之數，象徵著權威與果斷。擁有此數者，才華出眾，自信滿滿。但因個性過於剛烈，容易得罪人，導致人和不佳。需學習謙虛與包容，方能長保富貴。" },
            34: { t: "凶", d: "災難不絕，難望成功，此數大凶。", detail: "數理極凶，象徵著破壞與毀滅。人生充滿了災難與不幸，病痛纏身，家庭破碎。雖然可能具備才華，但運勢極差，難有發揮之地。宜改名換運，修德積福。" },
            35: { t: "吉", d: "處事嚴謹，進退保守，學智兼具。", detail: "溫和文雅的吉祥數理。象徵著文學、藝術與學術的成就。擁有此數者，性格內向，喜愛思考，適合從事靜態的工作。雖然缺乏開創性，但能在穩定的領域中獲得成功。" },
            36: { t: "凶", d: "波瀾重疊，常陷窮困，動不如靜。", detail: "此數暗示著捨己救人，但往往好心沒好報。人生波折不斷，辛苦勞碌卻所獲無幾。易陷於財務困境或感情糾紛。宜安分守己，避免冒險。" },
            37: { t: "吉", d: "逢凶化吉，吉人天相，以德取眾。", detail: "象徵著忠誠與信義。擁有此數者，意志堅定，為人正直，深得他人信任。雖然早年可能較為辛苦，但中年過後運勢大開，事業有成，名利雙收。" },
            38: { t: "凶", d: "名雖可得，利則難獲，藝界發展。", detail: "此數為技藝之數。擁有此數者，心靈手巧，在藝術或技藝方面有獨特的天賦。但財運較差，往往名氣大而實利少。適合從事創作、設計等工作。" },
            39: { t: "吉", d: "雲開見月，雖有勞碌，光明坦途。", detail: "象徵著否極泰來。雖然早年可能遭遇困難與阻礙，但因具備堅強的意志與奮鬥精神，終能撥雲見日，獲得成功。晚年運勢極佳，福壽雙全。" },
            40: { t: "凶", d: "一盛一衰，浮沉不定，知難而退。", detail: "此數暗示著運勢起伏劇烈。好運時令人羨慕，壞運時令人同情。因為缺乏定性與智謀，容易因一時的衝動而招致失敗。需謹慎行事，保守為宜。" },
            40: { t: "凶/吉", d: "一盛一衰，運勢不穩，知難而退。", detail: "此數暗示著運勢起伏劇烈。好運與壞運交替出現。因為可能缺乏定性，容易因一時的衝動而招致失敗。需謹慎行事，保守為宜。" },
            41: { t: "吉", d: "天賦吉運，德望兼備，繼續努力。", detail: "德高望重的吉祥數理。象徵著博愛與寬容。擁有此數者，心胸寬廣，樂於助人，受人敬仰。事業發展順利，財源廣進，是一生福氣滿滿的數理。" },
            42: { t: "凶", d: "事業不專，博而不精，專心進取。", detail: "【博而不精】興趣廣泛，但可能缺乏持久力與專注力，往往樣樣通樣樣鬆。事業多變動，難以有大成就。需培養專一的精神，方能有所突破。" },
            43: { t: "凶", d: "外祥內苦，需防誘惑，忍耐自重。", detail: "外表看似光鮮亮麗，內心卻可能有不為人知的苦楚。象徵著虛有其表。易遭遇金錢或感情的誘惑，需潔身自愛，防範未然。晚年運勢需多規劃。" },
            44: { t: "凶", d: "費盡心機，事難遂願，需改心性。", detail: "【需防失誤】此數暗示著過於算計可能反招致失敗。往往因小失大。雖然可能獲得一時的利益，但終將得不償失。需誠信待人，方能扭轉命運。" },
            45: { t: "吉", d: "楊柳遇春，綠葉發枝，衝破難關。", detail: "象徵著順應自然，生機勃勃。擁有此數者，智慧過人，處事圓滑，能夠克服一切困難，達成目標。事業發展順利，名利雙收，是一生幸運的數理。" },
            46: { t: "凶", d: "坎坷不平，艱難重重，磨練心志。", detail: "【懷才不遇】才華雖高，但生不逢時，運勢多舛。易面臨生活壓力或親友無助的狀況。需培養堅強的意志，忍辱負重，在逆境中尋求生機。" },
            47: { t: "吉", d: "有貴人助，可成大業。", detail: "【開花結果】象徵收穫與成功。為人誠實，做事負責，深得信賴。能獲貴人提拔，在事業上取得巨大成就。家庭美滿，子孫賢孝。" },
            48: { t: "吉", d: "美化豐實，名利俱全。", detail: "【青松立鶴】才德兼備的吉祥數。象徵高貴與優雅。氣質出眾，才華洋溢，能在社會上脫穎而出。名利雙收，富貴榮華。" },
            49: { t: "凶/吉", d: "吉凶未定，浮沉多端，惟靠謹慎。", detail: "【吉凶參半】此數為吉凶混合之數。運勢的好壞全憑環境與心境而定。若能心存善念，行善積德，則能逢凶化吉；反之，則易招致問題。需謹言慎行，修身養性。" },
            50: { t: "凶/吉", d: "吉凶互見，一成一敗。", detail: "【大起大落】此數暗示著大起大落。雖然可能獲得一時成功，但往往曇花一現，難以持久。晚年運勢需多加注意，宜未雨綢繆，積穀防饑。" },
            51: { t: "凶", d: "一盛一衰，運勢起伏，需養定性。", detail: "【不穩定】運勢好壞參半。做事容易虎頭蛇尾，缺乏恆心。雖然偶有好運，但難以把握。需培養定性，堅持到底，方能有所成就。" },
            52: { t: "吉", d: "草木逢春，雨過天晴。", detail: "【先苦後甘】先苦後甘的吉祥數。具備遠見與卓識。眼光獨到，能洞燭機先，抓住機會。雖然早年可能較辛苦，但晚年運勢極佳，名利雙收。" },
            53: { t: "凶", d: "盛衰參半，外祥內苦。", detail: "【金玉其外】此數暗示著金玉其外，敗絮其中。外表光鮮，內心卻充滿憂愁。早年運勢尚可，但晚年容易陷入困境。需防晚景淒涼，宜早作規劃。" },
            54: { t: "凶", d: "雖傾全力，難望成功，宜守不宜進。", detail: "【考驗重重】數理較弱，象徵孤獨與阻礙。人生充滿挑戰，身體健康需注意。雖然努力奮鬥，但回報可能不如預期。宜心存善念，多行善事以改運。" },
            55: { t: "凶", d: "外觀隆昌，內隱隱憂，需防危機。", detail: "【外強中乾】此數為外強中乾之象。表面成功，實則危機四伏。意志稍弱，缺乏決斷力，易受人左右。需培養獨立自主精神，方能化險為夷。" },
            56: { t: "凶", d: "事與願違，欲速不達，腳踏實地。", detail: "【缺乏實力】此數暗示著主觀願望與客觀實力有差距。心比天高，但執行力需加強。做事避免眼高手低，難以達成目標。需腳踏實地，量力而為。" },
            57: { t: "吉", d: "努力經營，花開富貴。", detail: "【苦盡甘來】苦盡甘來的吉祥數。象徵堅忍不拔的毅力。能忍受常人所不能忍的痛苦，最終獲得成功。晚年運勢極佳，得享天倫之樂。" },
            58: { t: "吉", d: "半兇半吉，始凶終吉。", detail: "【先難後易】此數為先難後易之象。早年運勢波折，面臨考驗。但只要堅持下去，中年過後運勢好轉，獲得成功與幸福。" },
            59: { t: "凶", d: "遇事猶疑，難望成事，需斷毅力。", detail: "【意志薄弱】此數暗示著意志薄弱，缺乏決斷力。做事猶豫不決，錯失良機。易受他人影響，隨波逐流。需培養自信心與決斷力，方能有所成就。" },
            60: { t: "凶", d: "前路未明，心迷意亂，尋求指引。", detail: "【迷失方向】數理較凶，象徵混亂與迷失。人生似失去方向，不知何去何從。做事反覆無常，難以取信於人。宜尋求明師或長輩指點，重拾信心。" },
            61: { t: "吉", d: "雲遮半月，應自謹慎。", detail: "【名利雙收】象徵名利雙收。聰明才智，具備領導才能。雖然可能經歷風波與修煉，但最終獲得成功與榮譽。需防驕傲自滿，以免招致失敗。" },
            62: { t: "凶", d: "煩惱懊悔，事業難成，需築基礎。", detail: "【基礎薄弱】此數暗示著基礎薄弱，缺乏信譽。做事容易半途而廢，難以達成目標。人際關係不佳，易受孤立。需加強修養，建立良好人際關係。" },
            63: { t: "吉", d: "萬物化育，專心一意。", detail: "【吉祥如意】吉祥如意之數。象徵順利與成功。心地善良，樂於助人，深得他人喜愛。事業發展順利，家庭美滿，是一生幸福的數理。" },
            64: { t: "凶", d: "見異思遷，徒勞無功，培養耐心。", detail: "【缺乏恆心】此數暗示著缺乏恆心與毅力。做事三分鐘熱度，難以持久。容易因為小挫折就放棄，導致一事無成。需培養恆心與毅力，方能有所成就。" },
            65: { t: "吉", d: "吉運自來，能享盛名。", detail: "【福運雙全】福運雙全的吉祥數。象徵富貴與長壽。運勢極佳，做事順利，容易獲得成功。家庭和睦，子孫賢孝，晚年得享清福。" },
            66: { t: "凶", d: "困頓難行，內外不和，尋求突破。", detail: "【內憂外患】此數暗示著內憂外患。家庭不和，親友無助，事業受阻。人生充滿艱難與挑戰，心情常感壓抑。需保持樂觀心態，主動尋求解決之道。" },
            67: { t: "吉", d: "獨營事業，功成名就。", detail: "【通達順利】象徵通達與順利。頭腦靈活，善於交際，能左右逢源。事業發展迅速，財源廣進，是一生富貴的數理。" },
            68: { t: "吉", d: "思慮周詳，不失先機。", detail: "【智謀出眾】智謀出眾的吉祥數。象徵聰明與智慧。思考縝密，做事有計劃，不打沒把握的仗。能抓住機會，獲得成功。" },
            69: { t: "凶", d: "動搖不安，不得時運，守成為上。", detail: "【運勢坎坷】此數暗示著運勢坎坷，波折不斷。雖然努力奮鬥，但往往事倍功半。易遭遇小病痛或挫折，身心俱疲。需防意外，多行善積德。" },
            70: { t: "凶", d: "慘淡經營，運勢衰退，宜守不宜進。", detail: "【險阻重重】數理較凶，象徵衰退。人生充滿挑戰，可能面臨家庭或健康的考驗。雖然具備才華，但環境限制發揮。宜保守經營，尋求轉機。" },
            71: { t: "凶", d: "吉凶參半，惟賴勇氣，堅持到底。", detail: "【勞苦耕耘】此數為勞苦之數。付出很多，但收穫甚微。內心常感空虛與無奈。需培養堅強意志，忍受孤獨，堅持到底方有一線生機。" },
            72: { t: "凶", d: "外強中乾，得而復失，戒除驕傲。", detail: "【外表光鮮】此數暗示著外表光鮮，內心空虛。雖然可能獲得一時成功，但難以持久。容易因為驕傲自滿而招致失敗。晚年運勢較差，需防孤獨與貧困。" },
            73: { t: "吉", d: "安樂自來，力行不懈。", detail: "【平平安安】平平安安的吉祥數。象徵小康與知足。雖無大富大貴，但生活無憂，家庭和睦。性格溫和，樂天知命，晚年得享清福。" },
            74: { t: "凶", d: "利不及費，坐食山空，需勤奮起。", detail: "【需勤需儉】此數暗示著可能缺乏進取心，整日無所事事，坐吃山空。晚年容易陷入經濟困難。需振作精神，努力工作，方能改變命運。" },
            75: { t: "凶", d: "吉中帶凶，欲速不達，保守平安。", detail: "【退守平安】此數為退守之數。運勢平平，難有大發展。若強求名利，反而容易招致失敗。宜安分守己，保守經營，方保平安。" },
            76: { t: "凶", d: "運勢傾頹，破產之象，急流勇退。", detail: "【傾家蕩產】數理極凶，象徵財運不佳。人生充滿挫折與失敗，財散人離。雖然可能具備才華，但時運不濟，難以翻身。宜保守理財，尋求新生。" },
            77: { t: "吉/凶", d: "先苦後甘，如能守成。", detail: "【過山車】半凶半吉之數。運勢如過山車般起伏不定。早年可能辛苦，但晚年運勢好轉；或早年風光，晚年淒涼。全憑個人造化與努力。" },
            78: { t: "凶", d: "有得有失，華而不實，養成儲蓄。", detail: "【財來財去】此數暗示著財來財去，難以積聚。雖然可能賺得不少錢財，但往往因為各種原因而流失。晚年容易陷入貧困。需養成儲蓄習慣，量入為出。" },
            79: { t: "凶", d: "前途未明，希望渺茫，尋求信仰。", detail: "【黑暗絕望】數理較凶，象徵迷茫與無助，看不到未來。易遭遇災難與不幸，身心俱疲。宜尋求宗教信仰，寄託心靈，以求平靜。" },
            80: { t: "凶", d: "得而復失，枉費心機，修身養性。", detail: "【徒勞無功】此數暗示著徒勞無功。雖然付出了很多努力，但最終卻是一場空。健康運較差，易生病痛。需看淡名利，修身養性，方保平安。" },
            81: { t: "吉", d: "最極之數，能得繁業。", detail: "【圓滿回歸】大吉大利之數。象徵圓滿與回歸。經歷九九八十一難，終於修成正果。福壽雙全，名利雙收，是一生最完美的結局。" }
        };

        function getLuck(num) {
            const n = num > 81 ? num % 81 || 81 : num;
            return STROKE_81[n] || { t: "平", d: "吉凶未定", detail: "此數理含義較為中性，需視配合而定。" };
        }

        function getStrokes(char) {
            try {
                // Try traditional count first via cnchar api if available
                let n = cnchar.stroke(char);
                return n > 0 ? n : 1;
            } catch (e) {
                return 1;
            }
        }

        // New function to handle everything in one go
        function handleDirectNameAI() {
            const surname = document.getElementById('inputSurname').value.trim();
            const name = document.getElementById('inputName').value.trim();

            if (!surname || !name) {
                alert("請輸入姓氏與名字");
                return;
            }

            // Ensure cnchar is loaded
            if (typeof cnchar === 'undefined') {
                alert("字庫資源載入中，請稍後再試...");
                return;
            }

            showLoading(async () => {
                try {
                    // 1. Calculate Strokes
                    const sChars = surname.split('');
                    const nChars = name.split('');

                    const s1 = getStrokes(sChars[0]);
                    const s2 = sChars.length > 1 ? getStrokes(sChars[1]) : null;
                    const n1 = getStrokes(nChars[0]);
                    const n2 = nChars.length > 1 ? getStrokes(nChars[1]) : null;

                    // 2. Define 5 Gates (Wu-Ge)
                    let tian, ren, di, wai, zong;

                    if (!s2 && !n2) { // Single S, Single N
                        tian = s1 + 1; ren = s1 + n1; di = n1 + 1; wai = 2; zong = s1 + n1;
                    } else if (!s2 && n2) { // Single S, Double N
                        tian = s1 + 1; ren = s1 + n1; di = n1 + n2; wai = n2 + 1; zong = s1 + n1 + n2;
                    } else if (s2 && !n2) { // Double S, Single N
                        tian = s1 + s2; ren = s2 + n1; di = n1 + 1; wai = s1 + 1; zong = s1 + s2 + n1;
                    } else { // Double S, Double N
                        tian = s1 + s2; ren = s2 + n1; di = n1 + n2; wai = s1 + n2; zong = s1 + s2 + n1 + n2;
                    }

                    // 3. Get Luck (Logic needed for AI context, but no UI update)
                    const tianL = getLuck(tian);
                    const renL = getLuck(ren);
                    const diL = getLuck(di);
                    const waiL = getLuck(wai);
                    const zongL = getLuck(zong);

                    // 4. San Cai
                    const sanCai = getSanCaiDesc(tian, ren, di);

                    // 5 NO UI Update for Local Results anymore

                    // 6. Bazi Context for AI
                    let y = parseInt(document.getElementById('inputNameYear').value);
                    let m = parseInt(document.getElementById('inputNameMonth').value);
                    let d = parseInt(document.getElementById('inputNameDay').value);
                    const timeKey = document.getElementById('inputNameTime').value;

                    // Validate Date
                    if (isNaN(y) || isNaN(m) || isNaN(d)) {
                        const now = new Date();
                        y = now.getFullYear(); m = now.getMonth() + 1; d = now.getDate();
                    }

                    const genderElements = document.getElementsByName('genderName');
                    let gender = 'male';
                    for (const el of genderElements) { if (el.checked) gender = el.value; }

                    const timeMap = { "zi": 0, "chou": 2, "yin": 4, "mao": 6, "chen": 8, "si": 10, "wu": 12, "wei": 14, "shen": 16, "you": 18, "xu": 20, "hai": 22 };
                    const hour = timeMap[timeKey] !== undefined ? timeMap[timeKey] : 12;

                    let solar = Solar.fromYmdHms(y, m, d, hour, 0, 0);
                    const lunar = solar.getLunar();
                    const bazi = lunar.getBaZi();

                    window.latestNameContext = {
                        surname: surname,
                        name: name,
                        gender: gender,
                        birthDate: `${y}年${m}月${d}日 ${timeKey}時`,
                        bazi: bazi,
                        wuge: {
                            tian: { val: tian, wx: getWuXing(tian).type },
                            ren: { val: ren, wx: getWuXing(ren).type },
                            di: { val: di, wx: getWuXing(di).type },
                            wai: { val: wai, wx: getWuXing(wai).type },
                            zong: { val: zong, wx: getWuXing(zong).type }
                        },
                        sancai: sanCai
                    };

                    // Show Result Area but keep specific content logic to AI Handler
                    document.getElementById('nameResultArea').classList.remove('hidden');

                    // Trigger AI Analysis
                    await window.handleNameAIAnalysis();

                } catch (e) {
                    console.error("Calculation/AI Error:", e);
                    alert("分析過程發生錯誤: " + e.message);
                }
            });
        }

        window.handleNameAIAnalysis = async function () {
            if (!window.latestNameContext) {
                alert("請先輸入姓名並點擊分析！");
                return;
            }

            let apiKey = '';
            if (typeof CONFIG !== 'undefined' && CONFIG.GEMINI_API_KEY && !CONFIG.GEMINI_API_KEY.includes('在此貼上')) {
                apiKey = CONFIG.GEMINI_API_KEY;
            }
            if (!apiKey) apiKey = localStorage.getItem('gemini_api_key');

            if (!apiKey) {
                showApiKeyModal();
                return;
            }

            const resultArea = document.getElementById('aiNameResultArea');
            const loading = document.getElementById('aiNameLoading');
            const content = document.getElementById('aiNameContent');
            const aiBtn = document.getElementById('aiNameBtn');
            const resetBtn = document.getElementById('nameAiResetBtn');

            resultArea.classList.remove('hidden');
            resultArea.classList.add('min-h-[400px]'); // Ensure height for loading animation
            loading.classList.remove('hidden');
            if (resetBtn) resetBtn.classList.add('hidden'); // Hide reset button during loading

            content.innerHTML = "";
            aiBtn.disabled = true;
            aiBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const ctx = window.latestNameContext;
            const prompt = `
你是一位精通姓名學與八字命理的大師。請結合「八字命盤」與「姓名五格」，為命主進行姓名吉凶鑒定。

【命主資料】
- 姓名：${ctx.surname}${ctx.name}
- 性別：${ctx.gender === 'male' ? '男' : '女'}
- 出生：${ctx.birthDate}
- 八字：${ctx.bazi.join(' ')} (年 月 日 時)

【姓名格局】
- 五行配置：天格(${ctx.wuge.tian.wx})、人格(${ctx.wuge.ren.wx})、地格(${ctx.wuge.di.wx})、外格(${ctx.wuge.wai.wx})、總格(${ctx.wuge.zong.wx})
- 三才配置：${ctx.sancai.combo} (${ctx.sancai.result})

【分析要求】
請嚴格按照以下 HTML 結構輸出內容，**不要**使用 Markdown，直接輸出 HTML 代碼。
重點部分或關鍵吉凶判斷，請使用 <span class="text-red-700 font-bold">重點文字</span> 包裹。
**請勿**使用綠色或其他顏色標註負面詞彙，統一使用紅色標註重點即可。

請依序輸出以下四個區塊，保持排版現代且結構化，**除此之外不要輸出任何其他內容**：

<!-- 1. 三才五格簡析 (儀表板佈局) -->
<div class="mb-8">
    <h3 class="flex items-center text-xl font-bold text-gray-800 mb-4 pb-2 border-b border-gray-200">
        <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">1</span>
        三才五格格局簡析
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-bold text-gray-700 mb-2">基礎個性</h4>
            <p class="text-sm text-gray-600 leading-relaxed">(在此分析三才靈動數對命主內在性格的影響)</p>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-bold text-gray-700 mb-2">事業發展</h4>
            <p class="text-sm text-gray-600 leading-relaxed">(分析人格與地格對工作的影響)</p>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-bold text-gray-700 mb-2">財運分析</h4>
            <p class="text-sm text-gray-600 leading-relaxed">(分析總格與外格對財運的靈動力)</p>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-bold text-gray-700 mb-2">人際與婚姻</h4>
            <p class="text-sm text-gray-600 leading-relaxed">(分析对外格與地格的影響)</p>
        </div>
    </div>
</div>

<!-- 2. 八字與姓名配合度 (卡片列表樣式) -->
<div class="mb-8">
    <h3 class="flex items-center text-xl font-bold text-gray-800 mb-4 pb-2 border-b border-gray-200">
        <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">2</span>
        命盤與姓名配合度
    </h3>
    <div class="space-y-4">
        <div class="border border-gray-200 rounded-lg overflow-hidden">
            <div class="bg-slate-100 px-4 py-2 font-bold text-slate-700 border-b border-gray-200">八字格局強弱與喜用</div>
            <div class="p-4 text-gray-700 leading-relaxed bg-white">
                (分析命盤強弱及所需的五行喜用神，內容要白話易懂，**不要使用斜體**)
            </div>
        </div>
        <div class="border border-gray-200 rounded-lg overflow-hidden">
            <div class="bg-slate-100 px-4 py-2 font-bold text-slate-700 border-b border-gray-200">姓名五行補救作用</div>
            <div class="p-4 text-gray-700 leading-relaxed bg-white">
                (詳細說明名字是否補足了八字缺失，有無相剋？內容要白話易懂，**不要使用斜體**)
            </div>
        </div>
         <div class="border border-gray-200 rounded-lg overflow-hidden">
            <div class="bg-slate-100 px-4 py-2 font-bold text-slate-700 border-b border-gray-200">綜合配合度判斷</div>
            <div class="p-4 text-gray-700 leading-relaxed bg-white">
                (總結姓名對此命盤是加分還是減分，內容要白話易懂，**不要使用斜體**)
            </div>
        </div>
    </div>
</div>

<!-- 3. 方向建議 (溫馨信箋樣式) -->
<div class="mb-4">
    <h3 class="flex items-center text-xl font-bold text-gray-800 mb-4 pb-2 border-b border-gray-200">
        <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">3</span>
        方向建議
    </h3>
    <div class="bg-amber-50 rounded-xl p-6 relative">
        <span class="absolute top-4 left-4 text-4xl text-amber-200 leading-none">❝</span>
        <div class="pl-8 pt-2 space-y-4">
             <div>
                <span class="font-bold text-amber-900 block mb-2">適合產業方向：</span>
                <ul class="list-disc pl-5 space-y-1 text-gray-700">
                    <li>(列表項目：適合產業1)</li>
                    <li>(列表項目：適合產業2)</li>
                    <li>(列表項目：適合產業3)</li>
                </ul>
            </div>
            <div>
                <span class="font-bold text-amber-900 block mb-2">水晶建議：</span>
                <ul class="list-disc pl-5 space-y-1 text-gray-700">
                    <li>(列表項目：適合水晶1)</li>
                    <li>(列表項目：適合水晶2)</li>
                </ul>
             </div>
             <div>
                <span class="font-bold text-amber-900 block mb-2">勉勵：</span>
                <p class="text-gray-700 leading-relaxed">
                   (給予心態勉勵與正能量祝福，**不要使用斜體**)
                </p>
            </div>
        </div>
    </div>
</div>

語氣請專業、客觀，用「你」稱呼命主，內容務必白話易懂，**嚴禁使用斜體**。
            `;

            try {
                const analysis = await window.callGeminiAPI(apiKey, prompt);
                const cleanText = analysis.replace(/```html/g, '').replace(/```/g, '');
                content.innerHTML = cleanText;
            } catch (error) {
                console.error(error);
                if (error.message.includes('API key not valid') || error.message.includes('400')) {
                    localStorage.removeItem('gemini_api_key');
                    showApiKeyModal("金鑰失效，請重新輸入");
                }
                content.innerHTML = `<span class="text-red-500">分析發生錯誤：${error.message}</span>`;
            } finally {
                loading.classList.add('hidden');
                resultArea.classList.remove('min-h-[400px]'); // Remove fixed height to fit content
                aiBtn.disabled = false;
                aiBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                const resetBtn = document.getElementById('nameAiResetBtn');
                if (resetBtn) resetBtn.classList.remove('hidden');
            }
        };

        function calculateBazi() {

            // Retrieve selected gender
            const genderElements = document.getElementsByName('gender');
            let gender = 'male'; // Default
            for (const el of genderElements) {
                if (el.checked) {
                    gender = el.value;
                    break;
                }
            }

            let y = parseInt(document.getElementById('inputYear').value);
            let m = parseInt(document.getElementById('inputMonth').value);
            let d = parseInt(document.getElementById('inputDay').value);
            const timeKey = document.getElementById('inputTime').value;

            try {
                // 1. Unified Time Handling with Lunar.js
                //    We convert everything to a Solar object first to standardize the timestamp,
                //    then get the Lunar object from it.
                // 1. Unified Time Handling with Lunar.js
                //    Input is always treated as SOLAR (Gregorian)
                let solar = Solar.fromYmd(y, m, d);

                // Time mapping (middle of the shichen)
                const timeMap = {
                    "zi": 0, "chou": 2, "yin": 4, "mao": 6, "chen": 8, "si": 10,
                    "wu": 12, "wei": 14, "shen": 16, "you": 18, "xu": 20, "hai": 22
                };
                const hour = timeMap[timeKey];

                // Create precise Solar object with time
                solar = Solar.fromYmdHms(solar.getYear(), solar.getMonth(), solar.getDay(), hour, 0, 0);

                // Get the Master Lunar Object
                const lunar = solar.getLunar();

                // 2. Extract Data for Pillars Display
                const bazi = lunar.getBaZi();
                const lunarYearGZ = bazi[0]; // Accurate Year Pillar (GanZhi)

                document.getElementById('pillarYear').innerText = bazi[0];
                document.getElementById('pillarMonth').innerText = bazi[1];
                document.getElementById('pillarDay').innerText = bazi[2];
                document.getElementById('pillarTime').innerText = bazi[3];

                // 3. Extract Data for Bone Weight Calculation
                // Yuan Tian Gang Bone Weight is based on:
                // Year: GanZhi (e.g. "甲子")
                // Month: Lunar Month Number (1-12)
                // Day: Lunar Day Number (1-30)
                // Time: Shichen (already known as timeKey)

                // Note: lunar.js Ganzhi matches our keys ("甲子", etc.)
                // Note: lunar.getMonth() might return negative for leap months? 
                // lunar.js documentation: getMonth() returns 1-12. If leap, strictly speaking we treat it as the month regular.
                // We use Math.abs just in case implementation varies, but standard lunar.js is 1-12.

                let wYearKey = lunarYearGZ;
                let finalM = Math.abs(lunar.getMonth());
                let finalD = lunar.getDay();

                const wYear = yearWeightsMap[wYearKey] || 0;
                const wMonth = monthWeights[finalM - 1] || 0;
                const wDay = dayWeights[finalD - 1] || 0;
                const wTime = timeWeights[timeKey] || 0;
                const totalQian = wYear + wMonth + wDay + wTime;

                const liang = Math.floor(totalQian / 10);
                const qian = totalQian % 10;

                // Update UI - Weight
                document.getElementById('totalWeightDisplay').innerText = `${liang}兩 ${qian}錢`;
                // document.getElementById('adviceWeightDisplay').innerText = `${liang}兩${qian}錢`;
                document.getElementById('yearW').innerText = (wYear / 10).toFixed(1);
                document.getElementById('monthW').innerText = (wMonth / 10).toFixed(1);
                document.getElementById('dayW').innerText = (wDay / 10).toFixed(1);
                document.getElementById('timeW').innerText = (wTime / 10).toFixed(1);

                // 4. Poem & Analysis Logic
                let poemText = "暫無此重量之批註。";
                if (gender === 'male' && poems.male[totalQian]) poemText = poems.male[totalQian];
                else if (gender === 'female' && poems.female[totalQian]) poemText = poems.female[totalQian];

                poemText = poemText.replace(/。/g, "，");
                const parts = poemText.split("，").filter(p => p.trim() !== "");

                document.getElementById('mainPoem').innerText = parts.join("，") + "。";

                const analysisContainer = document.getElementById('poemAnalysis');
                analysisContainer.innerHTML = '';

                parts.forEach((line, index) => {
                    if (!line) return;
                    const div = document.createElement('div');
                    let explanation = getPoemLineExplanation(line, index);
                    div.innerHTML = `
                                <h4 class="text-red-700 font-bold mb-2 text-sm">${line}</h4>
                                <p class="text-gray-600 text-sm leading-relaxed">${explanation}</p>
                                ${index < parts.length - 1 ? '<div class="border-b border-dashed border-gray-200 my-1.5"></div>' : ''}
                                `;
                    analysisContainer.appendChild(div);
                });

                // Detailed Analysis
                const yearZhi = bazi[0].substring(1, 2);
                const dayGan = bazi[2].substring(0, 1);
                const detail = getDetails(totalQian / 10, yearZhi, dayGan, lunar);

                // Render Comprehensive Analysis (replacing Four Pillars Analysis)
                renderFourPillarsAnalysis(detail, lunar);

                // 4. Five Elements Analysis
                analyzeFiveElements(bazi, lunar); // Pass lunar for Zodiac calculation

                // Render Advice List
                const adviceContainer = document.getElementById('descAdvice');
                adviceContainer.innerHTML = '';
                const adviceList = Array.isArray(detail.advice) ? detail.advice : [detail.advice];

                adviceList.forEach((item, idx) => {
                    const p = document.createElement('div');
                    if (item.includes("：")) {
                        const parts = item.split("：");
                        p.innerHTML = `<span class="font-bold text-gray-900">${idx + 1}. ${parts[0]}：</span>${parts[1]}`;
                    } else {
                        p.innerText = `${idx + 1}. ${item}`;
                    }
                    adviceContainer.appendChild(p);
                });

                // Save Data for AI Analysis
                window.latestBaziData = {
                    gender: gender,
                    solarDate: `${y}年${m}月${d}日 ${document.getElementById('inputTime').options[document.getElementById('inputTime').selectedIndex].text}`,
                    bazi: bazi,
                    weight: `${liang}兩 ${qian}錢`,
                    poem: poemText,
                    detail: detail,
                    advice: adviceList
                };

                const resArea = document.getElementById('resultArea');
                resArea.classList.remove('hidden');
                resArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (e) {
                console.error("Calculation Error:", e);
                alert("日期計算發生錯誤：" + e.message);
            }
        }

        // --- INTERPRETATION ENGINE ---
        // --- UNIQUE INTERPRETATION GENERATOR ---

        const zodiacTraits = {
            "子": { adj: "機靈敏銳", noun: "智者", advice: "多與人合作" },
            "丑": { adj: "腳踏實地", noun: "耕耘者", advice: "保持彈性" },
            "寅": { adj: "充滿行動力", noun: "開拓者", advice: "避免過衝" },
            "卯": { adj: "溫和細膩", noun: "協調者", advice: "果斷決策" },
            "辰": { adj: "志向遠大", noun: "領袖", advice: "聽取建言" },
            "巳": { adj: "深思熟慮", noun: "謀略家", advice: "打開心扉" },
            "午": { adj: "熱情奔放", noun: "先鋒", advice: "培養耐心" },
            "未": { adj: "外柔內剛", noun: "守護者", advice: "勇於表達" },
            "申": { adj: "多才多藝", noun: "發明家", advice: "專注目標" },
            "酉": { adj: "追求完美", noun: "鑑賞家", advice: "放寬標準" },
            "戌": { adj: "忠誠可靠", noun: "執行者", advice: "建立信任" },
            "亥": { adj: "樂觀豁達", noun: "哲學家", advice: "積極進取" }
        };



        const weightTemplates = {
            low: { // < 3.5
                char: ["性格堅毅，有著不服輸的韌性。", "為人樸實，能夠吃苦耐勞。", "個性獨立，習慣靠自己解決問題。"],
                career: ["早年需經歷一番磨練，屬大器晚成之格。", "事業起步較緩，但基礎穩固。", "適合專精一技之長，靠實力說話。"],
                wealth: ["財運如涓涓細流，需積少成多。", "前半生財來財去，後半生漸入佳境。", "正財運佳，不宜投機，勤儉致富。"]
            },
            mid: { // 3.5 - 5.0
                char: ["處事圓融，具有良好的適應力。", "性格穩重，給人可靠的安全感。", "才思敏捷，善於把握機會。"],
                career: ["職場發展順遂，易得貴人提攜。", "事業運勢平穩上升，中年可擔大任。", "適合團隊合作，能發揮協調長才。"],
                wealth: ["衣食無憂，財運穩健。", "擅長理財，能守能攻。", "正偏財皆有斬獲，生活優渥。"]
            },
            high: { // > 5.0
                char: ["氣宇軒昂，具有天生的領袖風範。", "心胸寬廣，格局遠大。", "充滿自信，勇於承擔重任。"],
                career: ["官運亨通，有機會掌權或成為業界權威。", "事業宏大，能成就一番偉業。", "名利雙收，社會地位崇高。"],
                wealth: ["一生富貴，財源廣進。", "聚寶盆之命，富澤子孫。", "財富格局大，適合大型投資。"]
            }
        };



        // --- Advanced Analysis Helper (Ten Gods + WuXing + ShenSha) ---
        function getAdvancedAnalysis(lunar) {
            // 1. Ten Gods (Shi Shen) Analysis
            const shiShenGan = lunar.getBaZiShiShenGan();
            const godsList = [shiShenGan[0], shiShenGan[1], shiShenGan[3]];

            let wealthAnalysis = "";
            let careerAnalysis = "";
            let characterAnalysis = "";

            // Wealth (Ten Gods)
            if (godsList.includes("正財")) wealthAnalysis += "命帶「正財」，正職收入穩定，適合保守理財。";
            else if (godsList.includes("偏財")) wealthAnalysis += "命帶「偏財」，具投資眼光，有獲取意外之財的潛力。";
            else wealthAnalysis += "財星隱含，需靠積累一技之長致富。";

            // Career (Ten Gods)
            if (godsList.includes("正官")) careerAnalysis += "【主管格】命帶正官，適合承擔責任，具備極佳的組織管理能力。";
            else if (godsList.includes("七殺")) careerAnalysis += "【開創格】命帶七殺，具備突破現狀的魄力，勇於面對挑戰。";
            else if (godsList.includes("傷官") || godsList.includes("食神")) careerAnalysis += "【才華格】命帶食傷，思維靈活，具備獨特的創造力與解決問題的能力。";
            else careerAnalysis += "【專業格】專注力強，能沈下心來深耕專業，追求卓越。";

            // Character (Ten Gods)
            if (godsList.includes("比肩")) characterAnalysis += "個性獨立自主，意志堅定。";
            else if (godsList.includes("劫財")) characterAnalysis += "為人豪爽，重義輕財。";

            // 2. WuXing (Five Elements) Analysis - Health & Advice
            const wuxing = lunar.getBaZiWuXing();
            const counts = { "金": 0, "木": 0, "水": 0, "火": 0, "土": 0 };
            wuxing.forEach(wx => { if (counts[wx] !== undefined) counts[wx]++; });

            const missing = Object.keys(counts).filter(k => counts[k] === 0);
            let healthAdvice = "";
            let luckyAdvice = "";

            if (missing.length > 0) {
                const m = missing[0];
                if (m === "金") { healthAdvice = "五行缺金，需注意呼吸系統與皮膚保養。"; luckyAdvice = "開運建議：多穿白色系衣物，佩戴金屬飾品。"; }
                else if (m === "木") { healthAdvice = "五行缺木，需留意肝膽功能與神經系統。"; luckyAdvice = "開運建議：多穿綠色系衣物，家中多種植綠色植物。"; }
                else if (m === "水") { healthAdvice = "五行缺水，需注意腎臟與泌尿系統循環。"; luckyAdvice = "開運建議：多穿黑色或藍色衣物，多喝水。"; }
                else if (m === "火") { healthAdvice = "五行缺火，需留意心血管與血液循環問題。"; luckyAdvice = "開運建議：多穿紅色或紫色衣物，多曬太陽。"; }
                else if (m === "土") { healthAdvice = "五行缺土，需注意脾胃消化功能。"; luckyAdvice = "開運建議：多穿黃色或大地色系衣物，佩戴玉石。"; }
            } else {
                healthAdvice = "五行俱全，體質相對平衡，保持規律作息即可。";
                luckyAdvice = "五行平衡，可依個人喜好選擇幸運色。";
            }

            // 3. ShenSha (Gods and Evils) - Highlights
            let allShenSha = [];
            // Safe ShenSha Retrieval: Try standard getShenSha() first
            if (typeof lunar.getShenSha === 'function') {
                allShenSha = allShenSha.concat(lunar.getShenSha());
            } else if (typeof lunar.getDayShenSha === 'function') {
                allShenSha = allShenSha.concat(lunar.getDayShenSha());
            } else {
                // Fallback or empty if methods are different in this version
                allShenSha = [];
            }
            // Add other potential sources if needed, but avoid crashing calls like getBaZiDayZhiShenSha unless sure

            let shenShaHighlights = [];
            if (allShenSha.includes("天乙贵人") || allShenSha.includes("天乙貴人")) shenShaHighlights.push("【天乙貴人】：命中帶貴，一生逢凶化吉，易得長輩提攜。");
            if (allShenSha.includes("文昌贵人") || allShenSha.includes("文昌貴人") || allShenSha.includes("文昌")) shenShaHighlights.push("【文昌貴人】：才思敏捷，學業事業皆有成，利於考試考證。");
            if (allShenSha.includes("桃花") || allShenSha.includes("咸池")) shenShaHighlights.push("【桃花星】：異性緣佳，人緣好，公關魅力強。");
            if (allShenSha.includes("驿马") || allShenSha.includes("驛馬")) shenShaHighlights.push("【驛馬星】：動中求財，適合出差、外派或旅遊業，越動越發。");
            if (allShenSha.includes("华盖") || allShenSha.includes("華蓋")) shenShaHighlights.push("【華蓋星】：聰明孤高，具藝術才華，對哲學宗教有慧根。");
            if (allShenSha.includes("将星") || allShenSha.includes("將星")) shenShaHighlights.push("【將星】：具備領導才能，有機會掌權，成為團隊核心。");

            return {
                wealth: wealthAnalysis,
                career: careerAnalysis,
                character: characterAnalysis,
                health: healthAdvice,
                lucky: luckyAdvice,
                shensha: shenShaHighlights
            };
        }

        function getDetails(weight, zodiac, dayMaster, lunar) {
            const zData = zodiacTraits[zodiac] || { adj: "獨特", noun: "行者", advice: "慎始敬終" };
            const dmData = dayMasterAttributes[dayMaster] || dayMasterAttributes["甲"];
            const advanced = getAdvancedAnalysis(lunar);

            // 1. Grand Strategy (30 Variations: Weight + Ten Gods Matrix)
            let strategy = "";
            const sGods = lunar.getBaZiShiShenGan();
            const sGodSet = new Set(sGods);

            // Determine Dominant Type (Priority: Power > Wealth > Output > Resource > Self)
            let sType = "Self";
            if (sGodSet.has("七殺") || sGodSet.has("正官")) sType = "Power";
            else if (sGodSet.has("偏財") || sGodSet.has("正財")) sType = "Wealth";
            else if (sGodSet.has("傷官") || sGodSet.has("食神")) sType = "Output";
            else if (sGodSet.has("偏印") || sGodSet.has("正印")) sType = "Resource";

            // Determine Weight Level (0-5)
            let sLevel = 0;
            if (weight >= 5.5) sLevel = 5;
            else if (weight >= 4.8) sLevel = 4;
            else if (weight >= 4.2) sLevel = 3;
            else if (weight >= 3.6) sLevel = 2;
            else if (weight >= 3.0) sLevel = 1;
            // < 3.0 is Level 0

            const strategies = {
                "Power": [
                    "【磨劍成鋒格】骨重雖輕但命帶官殺，象徵早年需經歷嚴格的磨練。您就像一把未開封的寶劍，職場初期的挫折是為了讓您更堅韌。建議沈住氣，從基層做起，這段經歷將是您中年掌權的底氣。",
                    "【潛龍勿用格】具備領導潛力但時機未到。策略是「潛伏」，在組織中累積威望，不要急於出頭。您的貴氣在於內斂，當能力與時運交會時，您將一飛沖天，掌握實權。",
                    "【循序漸進格】這是一個穩步上升的官貴格。您的升遷之路有跡可循，適合在大型體制內發展。建議按部就班，考取證照或爭取職位，您的權力是隨年資與貢獻疊加的，晚運極佳。",
                    "【權威建立格】骨重轉重，開始展現主管風範。您天生就有讓人信服的氣場，適合帶領團隊。策略在於「立威」與「立德」並重，打造您的核心班底，成就一番霸業。",
                    "【獨當一面格】具備高階將帥的命格，能承擔巨大的責任與壓力。您適合開疆闢土或掌管決策。建議眼光放遠，思考產業布局，您的舞台已經不只是公司，而是整個行業的領袖。",
                    "【登峰造極格】官殺與重骨相輔相成，乃社會領袖或權威人士之命。您的影響力足以撼動局勢。策略在於「濟世」，權力越大責任越大，投身公眾事務將使您的名望流芳百世。"
                ],
                "Wealth": [
                    "【積沙成塔格】財星顯現但骨重較輕，代表財富需靠點滴累積。勿貪求一夜暴富，適合穩健儲蓄與小額投資。您的勤儉是最好的聚寶盆，晚年必有積蓄，福澤子孫。",
                    "【技藝生財格】財富來自於您的一技之長。不要做投機生意，專注於提升您的專業技能。您是「越老越值錢」的類型，專業口碑就是您的印鈔機，名利雙收。",
                    "【商機浮現格】您對金錢有敏銳的嗅覺，且骨重適中，有能力捕捉稍縱即逝的機會。建議大膽嘗試副業或投資，在流動中創造財富，別讓資金閒置，錢滾錢最快。",
                    "【財源廣進格】財星高照，物資豐饒。您適合從事貿易或金流相關的行業。策略是「資源配置」，學會讓錢為您工作，建立被動收入系統，財富將如滾雪球般增長。",
                    "【點石成金格】骨重與財星皆旺，具備卓越的商業眼光。您能看見別人看不見的價值，適合創業或重整不良資產。您的決策往往能帶來倍數的獲利，是天生的生意人。",
                    "【富甲一方格】大富大貴之格，財富已非您需擔憂之事。策略在於「佈施」，金錢的流動能帶來更大的福報。投資社會企業或回饋鄉里，將使您的財富格局昇華至精神層次。"
                ],
                "Output": [
                    "【孤芳才子格】才華洋溢但骨重稍輕，早年可能感到懷才不遇。堅持您的創作或理念，不要因為世俗眼光而妥協。您的獨特性將在網路或小眾領域找到死忠知音，大器晚成。",
                    "【技藝超群格】食傷生財，靠的是真本事。您適合成為特定領域的職人或專家。將一個細節做到極致，市場自然會給您高回報，專注是您唯一的策略，切忌博而不精。",
                    "【創意無限格】此命格思維活躍，骨重適中支撐您的執行力。適合從事行銷、設計或媒體。策略是「不斷求變」，您的點子就是黃金，永遠走在潮流的前端，引領風騷。",
                    "【名聲漸起格】您的才華開始獲得大眾認可，名氣轉化為利益。建立「個人品牌」是最佳策略。珍惜您的羽毛，經營好公眾形象，名利雙收指日可待，影響力擴大。",
                    "【桃李滿門格】食傷代表付出與傳承。骨重厚實，適合從事教育、諮詢或顧問。您的智慧能啟發他人，成就學生或客戶的同時，也成就了崇高的地位，受人景仰。",
                    "【一代宗師格】才華與福德兼備，是思想或藝術領域的開創者。您的作品或理論將影響後世。策略是「立言」，著書立說，留下精神遺產，讓您的智慧超越時間的限制。"
                ],
                "Resource": [
                    "【清貴守道格】骨重輕而印星重，重視精神世界勝於物質。早年生活或許清貧，但心靈富足。建議從事學術、研究或宗教，在精神領域您將獲得極大的滿足與尊敬，不染塵埃。",
                    "【學術扎根格】印星護身，適合走升學或公職考運。您的優勢在於學習與吸收。策略是「深造」，學歷或證照是您最好的護身符，知識將改變您的命運，地位穩固。",
                    "【貴人提攜格】骨重漸增，長輩緣極佳。在職場上容易獲得上司或前輩的賞識。建議多請益、多靠近優秀的長者，站在巨人的肩膀上，您將省去十年奮鬥，平步青雲。",
                    "【學養深厚格】知識淵博，見解獨到。您是團隊中的智囊，適合幕後策劃或顧問。策略是「洞察」，用您的智慧為他人解惑，您的價值在於看透問題的本質，不可或缺。",
                    "【德高望重格】骨重優厚，印星轉化為社會聲望。您可能是學術界或行業內的泰斗。策略是「教化」，利用您的影響力導正社會風氣，成為精神領袖，受萬人敬重。",
                    "【國師之命格】極貴之格，智慧足以安邦定國。您的建議能影響決策核心。保持清明的心性，無私地貢獻您的智慧，您將是歷史上被記住的人物，名垂青史。"
                ],
                "Self": [
                    "【寒梅傲雪格】骨重輕而比劫旺，依靠親友少，全靠自己打拼。這是典型的白手起家格。策略是「獨立」，不要依賴他人，鍛鍊出強大的心志，逆境將是您最強的導師，先苦後甘。",
                    "【兄弟同心格】比劫代表平輩，骨重稍增。您適合與人合夥或加入團隊。策略是「合作」，單打獨鬥難成氣候，找對隊友，共享利益，團結力量大，共創榮景。",
                    "【廣結善緣格】四海之內皆兄弟。您的社交手腕是最大資產。策略是「人脈經營」，朋友多路好走。真誠待人，您的貴人往往就隱藏在泛泛之交中，機會無處不在。",
                    "【競爭得勝格】骨重強健，能在競爭激烈的環境中脫穎而出。適合業務、競技或高壓行業。策略是「敢衝」，狹路相逢勇者勝，您的氣魄能壓倒對手，贏得最終勝利。",
                    "【義薄雲天格】領袖氣質顯現，重情重義。您是眾人眼中的「大哥/大姐」。策略是「擔當」，照顧好追隨您的人，他們的忠誠將將您推上高位，建立深厚基業。",
                    "【萬民擁戴格】骨重極重，比劫轉化為群眾魅力。您是天生的政治家或公眾人物。策略是「順勢」，傾聽民意，順應時勢，水能載舟，匯聚民心即可成就霸業，統領一方。"
                ]
            };

            if (strategies[sType] && strategies[sType][sLevel]) {
                strategy = strategies[sType][sLevel];
            } else {
                strategy = "【順天應人格】命格獨特，難以歸類。建議您保持善良與努力，順應天時地利，福氣自然會降臨。";
            }

            // 2. Ten Gods Actionable Advice (More specific)
            const gods = lunar.getBaZiShiShenGan(); // e.g. ["比肩", "七殺", ...] (Sky stems)
            // Add Earthly Branches main qi for more depth if needed, but Stems are prominent
            let actionAdvice = "";
            let uniqueSet = new Set(gods);

            if (uniqueSet.has("七殺")) {
                actionAdvice = "命帶「七殺」，代表您骨子裡有股不服輸的衝勁。在職場上，建議您主動爭取高難度、具挑戰性的專案，因為平淡的工作無法激發您的潛能。但切記「剛過易折」，在強勢展現能力的同時，要學會適度的妥協與圓融。";
            } else if (uniqueSet.has("正官")) {
                actionAdvice = "命帶「正官」，您天生具有管理者的思維。建議您著重於「建立制度」與「組織優化」。您的強項在於讓混亂的事物變得井井有條，適合考取專業證照或爭取管理職位，按部就班便能登峰造極。";
            } else if (uniqueSet.has("傷官") || uniqueSet.has("食神")) {
                actionAdvice = "命帶「食傷」，您的創意與表達能力是最大的資產。不要把自己侷限在死板的框架中，建議嘗試需要高度創意、口才或技術展現的工作。建立「個人品牌」將是您這輩子報酬率最高的投資。";
            } else if (uniqueSet.has("偏財") || uniqueSet.has("正財")) {
                actionAdvice = "命帶「財星」，您對商業嗅覺敏銳。建議您培養「理財」與「資源配置」的眼光。若為正財，請專注本業精進；若為偏財，可嘗試多元投資。重點在於將人脈轉化為錢脈，您的社交圈就是您的提款機。";
            } else if (uniqueSet.has("偏印") || uniqueSet.has("正印")) {
                actionAdvice = "命帶「印星」，您適合走「學術」或「幕後」路線。建議您終身學習，不斷提升心靈或專業層次。您的智慧能看透他人看不見的盲點，成為團隊中的「軍師」或「顧問」是極佳的定位。";
            } else {
                // Bi Jian / Jie Cai
                actionAdvice = "命帶「比劫」，這意味著競爭與合作是您人生的主題。建議您學會「分享利益」，避免單打獨鬥。找對合夥人或加入強大的團隊，利用群體的力量來放大自己的成果，是您成功的捷徑。";
            }

            // 3. Day Master & Zodiac Specific Advice (Expanded to 12 Zodiacs)
            let specificAdvice = "";
            switch (zodiac) {
                case "子":
                    specificAdvice = "身為「子鼠」，您擁有卓越的觀察力與直覺。心性修煉上，建議您要學會「定性」，避免思緒過於發散或多疑。專注於長遠目標，不要被眼前的蠅頭小利干擾，您的機靈才能轉化為大智慧。";
                    break;
                case "丑":
                    specificAdvice = "身為「丑牛」，您的耐力與毅力無人能及。心性修煉上，建議您要學會「變通」。固執雖然能成事，但也容易讓您錯失轉型的良機。試著多聽取年輕人或不同領域的意見，讓您的穩重加上靈活，將無往不利。";
                    break;
                case "寅":
                    specificAdvice = "身為「寅虎」，您天生具有領袖魅力與行動力。心性修煉上，建議您要學會「內斂」。過於強勢或衝動容易招致不必要的樹敵。在展現霸氣的同時，多一份溫柔與傾聽，您的領導將更得人心。";
                    break;
                case "卯":
                    specificAdvice = "身為「卯兔」，您心思細膩且愛好和平。心性修煉上，建議您要學會「果斷」。過度的猶豫或想當好人，往往會讓您陷入糾結。相信您的直覺，勇敢做出決定，並學習承擔被討厭的勇氣。";
                    break;
                case "辰":
                    specificAdvice = "身為「辰龍」，您志向遠大，氣場不凡。心性修煉上，建議您要學會「落地」。夢想再大也需要執行細節來支撐。避免眼高手低，從最小的事情做起，將雲端的理想連結到地面的現實。";
                    break;
                case "巳":
                    specificAdvice = "身為「巳蛇」，您冷靜沈著且洞察力強。心性修煉上，建議您要學會「釋懷」。您敏銳的感受力容易讓您記住他人的過失。練習寬恕與放下，釋放內心的負重，您的智慧將更為清澈。";
                    break;
                case "午":
                    specificAdvice = "身為「午馬」，您熱情奔放且崇尚自由。心性修煉上，建議您要學會「堅持」。您的爆發力強但續航力稍弱，凡事容易三分鐘熱度。培養「善始善終」的習慣，是您通往成功的最後一哩路。";
                    break;
                case "未":
                    specificAdvice = "身為「未羊」，您外柔內剛，富有人情味。心性修煉上，建議您要學會「自信」。您往往過於在意他人的眼光而委屈自己。肯定自我價值，大膽表達您的需求，您會發現世界比想像中更尊重您。";
                    break;
                case "申":
                    specificAdvice = "身為「申猴」，您多才多藝且反應靈敏。心性修煉上，建議您要學會「深耕」。您的聰明讓您學什麼都快，但也容易流於表面。選定一門學問深入鑽研，將聰明轉化為專業，才不會淪為「樣樣通樣樣鬆」。";
                    break;
                case "酉":
                    specificAdvice = "身為「酉雞」，您追求完美且勤奮不懈。心性修煉上，建議您要學會「放鬆」。對細節的過度苛求會讓您與身邊的人都感到緊繃。接受世界的不完美，學會欣賞缺憾之美，您的生活將更具彈性與快樂。";
                    break;
                case "戌":
                    specificAdvice = "身為「戌狗」，您忠誠可靠且正義感強。心性修煉上，建議您要學會「信任」。您的防衛心較重，不容易輕信他人。適度地打開防護罩，給予他人信任的機會，您將獲得更深層的情感連結。";
                    break;
                case "亥":
                    specificAdvice = "身為「亥豬」，您樂觀豁達且福氣深厚。心性修煉上，建議您要學會「積極」。隨遇而安是您的優點，但也可能變成懶散的藉口。為自己設定稍微高一點的標準，激發潛在的鬥志，您的福氣將轉化為巨大的成就。";
                    break;
                default:
                    specificAdvice = "身為此生肖，建議您保持平衡的心態，發揮天賦特長。";
            }

            // 4. Annual Trend Advice (30 Symbolic Variations - One for each lunar day)
            const trendVariations = [
                "【初一・一元復始】萬象更新之際，過去的種種譬如昨日死。這是徹底歸零、重新設定人生目標的最佳時刻，您的每一個新決定都將獲得宇宙能量的加持。",
                "【初二・陰陽調和】運勢講求平衡，過剛則折，過柔則廢。這段時間請檢視生活中的失衡之處（如工作與家庭），找回中庸之道，運氣自然順遂。",
                "【初三・新芽初發】機會如雨後春筍般浮現，雖然看似微不足道，但潛力無窮。不要忽視任何一個小提議或新想法，它們可能是未來大樹的種子。",
                "【初四・蓄勢待發】目前或許還不是全力衝刺的時候，而是「蹲得越低跳得越高」的準備期。充實知識、磨練技能，耐心等待那唯一一次的完美起跳。",
                "【初五・破土而出】障礙與限制將被突破！這是一股強大的向上能量，您將有能力克服長期以來的瓶頸。勇敢地表達自己，讓世界看見您的存在。",
                "【初六・六六大順】運勢流暢無阻，諸事皆宜。這是執行力最強的時刻，想做什麼就立刻行動，不要浪費這難得的順風車。",
                "【初七・七星高照】貴人運極佳，特別是來自長輩或上司的提攜。保持謙虛受教的態度，您將獲得寶貴的經驗傳承與資源挹注。",
                "【初八・八方來財】財運亨通，投資理財皆有利。這段時間您的商業嗅覺敏銳，適合進行財務規劃或資產配置，為未來累積財富。",
                "【初九・長長久久】適合規劃長期願景。不要只看眼前的利益，將目光放遠到五年、十年後。現在建立的關係或事業，將具有極強的延續性。",
                "【初十・十全十美】追求卓越的時刻。這段時間您對品質的要求極高，適合打磨作品或提升專業度。您的精益求精將贏得極高的口碑。",
                "【十一・孤芳自賞】這是一段適合獨處與內省的時光。不要害怕孤獨，偉大的想法往往誕生於獨處之中。傾聽內心的聲音，找回最真實的自己。",
                "【十二・寒梅傲雪】環境或許嚴峻，考驗重重，但這正是展現您堅韌品質的舞台。堅持原則，不隨波逐流，您的風骨將贏得對手的尊敬。",
                "【十三・天賦異稟】您的才華將得到發揮的舞台。不要隱藏您的光芒，大膽展現您的特殊技能或創意，這將是您脫穎而出的關鍵。",
                "【十四・月盈則虧】運勢達到頂峰，需注意盛極必衰。保持謙卑，懂得急流勇退或適度讓利，才能持盈保泰，將好運延續下去。",
                "【十五・月圓人圓】圓滿之象，利於人際關係的修復與團聚。主動聯繫許久未見的朋友或化解誤會，人和將帶來意想不到的機遇。",
                "【十六・大器晚成】或許目前的進度不如預期，但別著急。您的成果需要時間的發酵，持續耕耘，時間將證明您的堅持是正確的。",
                "【十七・堅若磐石】此時您需要的是信念。外界的風雨可能會動搖您的信心，但只要心志堅定如石，任何困難都無法阻擋您前進的步伐。",
                "【十八・海納百川】在此階段，包容力是您的致勝武器。接納不同的聲音與意見，整合各方資源，您的格局決定了您的成就高度。",
                "【十九・雲遊四海】驛馬星動，適合向外發展。旅行、出差或變動居住地都能帶來好運。不要侷限在原地，移動將為您帶來新的視野與靈感。",
                "【二十・破繭成蝶】痛苦的轉變期，但這是成長必經的過程。您正在經歷脫胎換骨的蛻變，忍受暫時的不適，迎接更美麗的重生。",
                "【廿一・剛柔並濟】學習水的智慧，遇方則方，遇圓則圓。在原則與變通之間找到平衡點，您的柔軟身段將助您化解強硬的阻力。",
                "【廿二・雙喜臨門】好運接二連三，可能有意外的驚喜。保持開放與感恩的心，迎接生命中的禮物，記得與人分享您的喜悅。",
                "【廿三・眾志成城】團隊合作是關鍵。這不是單打獨鬥的時候，學會信任夥伴，分工合作。集眾人之力，無堅不摧。",
                "【廿四・靜水流深】表面平靜，實則內涵深厚。不要急於表現，充實內在涵養。您的深度與穩重，將讓人在相處中越發敬重。",
                "【廿五・天道酬勤】一分耕耘，一分收穫。這段時間沒有捷徑，只有腳踏實地的努力。上天不會虧待勤奮的人，您的付出終獲回報。",
                "【廿六・雷霆萬鈞】行動要快！機會稍縱即逝。當決策時機來臨，展現您的魄力，速戰速決，拖延將導致失敗。",
                "【廿七・大智若愚】收斂鋒芒，韜光養晦。有時裝傻也是一種智慧，避免鋒芒太露遭人嫉妒。在低調中默默佈局，等待一鳴驚人的時刻。",
                "【廿八・星月交輝】您將成為他人的指路明燈。利用您的經驗或智慧去幫助迷惘的人，助人為快樂之本，也是累積福報的最佳方式。",
                "【廿九・枯木逢春】低谷即將過去，生機正在復甦。不要放棄希望，最艱難的時刻往往是轉機的前夜。堅持下去，春天就在眼前。",
                "【三十・圓滿收官】一個階段的結束，也是新階段的開始。做好總結與反省，放下過去的包袱，輕裝上陣，準備迎接下一個精彩的循環。"
            ];
            // Map specifically to Lunar Day (1-30) -> Index (0-29)
            // lunar.getDay() returns 1-30 typically
            const trendIndex = (lunar.getDay() - 1) % 30;
            const trendAdvice = trendVariations[trendIndex];

            // Construct Advice Array (Fully Custom)
            let adviceArray = [
                `總體運勢：${strategy}`,
                `行動指引：${actionAdvice}`,
                `心性修煉：${specificAdvice}`,
                `流年趨勢：${trendAdvice}`
            ];

            // Insert Shensha highlights dynamically if potent ones usually exist
            // (Keeping it concise as per "not too many" request, focusing on the 5 points above is solid.)

            return {
                character: `${dmData.character}<br><br><span class="font-bold text-gray-700">【格局補充】</span>${advanced.character} 同時，您還帶有${zodiac}年生肖「${zData.adj}」的特質，這使您成為一位剛柔並濟的${zData.noun}。`,
                career: `${dmData.career}<br><br><span class="font-bold text-gray-700">【格局補充】</span>${advanced.career}`,
                wealth: `${dmData.wealth}<br><br><span class="font-bold text-gray-700">【格局補充】</span>${advanced.wealth} 另外，${zodiac}年出生的人，${zData.advice}，這將幫助您守住財富。`,
                love: `${dmData.love}${advanced.character.includes("桃花") ? "<br><br><span class='font-bold text-pink-600'>【桃花運】</span>命帶桃花，異性緣極佳，人緣好。" : ""}`,
                advice: adviceArray
            };
        }





        const poemLineMap = {
            // --- Male Poems (2.1 - 2.9) ---
            "短命非業謂大凶": "這句詩雖從字面看較為嚴厲，實則是對「健康」的極度重視。命格暗示先天元氣較弱，如同一盞微弱的油燈，需要倍加呵護。這是一個養生的警訊，提醒您不要透支身體，作息需規律，「惜命」是您一生的課題。",
            "身寒骨冷苦伶仃": "「寒」與「冷」形容的是早年資源的匱乏與心靈的孤單。您可能出生於清寒之家，或少時缺乏長輩的關愛。但這份孤獨也是一種淬鍊，讓您比同齡人更早學會獨立，懂得在這世情冷暖中自我取暖。",
            "此命推來骨輕輕": "「骨輕」意指根基不穩，容易受到外界環境的影響。您在做決定時可能較易動搖，或缺乏有力的靠山支持。這提醒您，凡事需腳踏實地，建立屬於自己的核心競爭力，厚植實力才能穩住陣腳。",
            "此命推來福祿無": "這句話並非斷言您一生貧窮，而是指出「福祿」不會自動掉下來。這是一種「勞碌格」，每一分收穫都需要付出相對應的汗水。別期待不勞而獲的運氣，相信雙手打拼出來的成果才最實在。",
            "此命推來祖業微": "祖上的庇蔭微薄，能留給您的有形資產不多。這象徵您是典型的「創一代」，一切都要從零開始。雖然起步艱難，但這種白手起家的成就感，將是您人生徽章上最耀眼的一枚。",
            "平生一路苦中求": "您的人生主旋律是「奮鬥」。路途或許崎嶇，充滿挑戰，但每一個「苦」字背後都藏著「求」到的智慧。這句詩鼓勵您，不要害怕吃苦，因為這些苦難都是為了磨練您的心智，讓您成為更好的人。",
            "一生做事少商量": "形容您性格較為孤僻或主觀，習慣獨來獨往，不善於與人合作。這即使是優點（果斷），也可能是盲點（固執）。建議您適度打開心扉，多聽取他人意見，集思廣益能讓您的路走得更寬。",
            "一生作事似飄蓬": "「飄蓬」象徵著漂泊不定。您可能工作頻繁變動，或居無定所，像風中的蓬草。這雖然是一種不穩定，但也代表了豐富的閱歷。在變動中尋找不變的核心，將動盪轉化為適應力，是您的轉機。",
            "初年運限未曾亨": "早年的運勢確實較為低迷，可能求學不順或初入社會頻頻碰壁。但這只是人生的序曲，並非終章。「大器晚成」往往需要早年的沉澱，請保持耐心，時間會證明您的價值。",

            // --- Male Poems (3.0 - 3.9) ---
            "勞勞碌碌苦中求": "大部分的人都在為生活奔波，您也不例外。這句詩肯定了您的勤奮，但也提醒您要注意「效率」。如果在忙亂中能找到方向，您的勞碌將不再是受苦，而是通往成功的積累。",
            "忙忙碌碌苦中求": "與上一句類似，強調了「忙」的狀態。這可能代表您身兼數職，或為了家庭生計不敢停歇。這份責任感令人敬佩，但也要學會適時放鬆，別讓忙碌吞噬了生活的品質。",
            "初年運錯事難謀": "起步時可能選錯了跑道，或時機不對，導致事倍功半。這是一種「試錯」的過程。別因為初期的失敗而否定自己，調整方向，重新出發，每一次修正都讓您離目標更近一步。",
            "早年做事事難成": "萬事起頭難，這句詩反映了執行層面可能常遇阻礙。這或許是經驗不足，也可能是缺乏貴人指點。建議您多請教前輩，借力使力，不要獨自硬闖，便能化「難成」為「晚成」。",
            "此命福氣果如何": "這是一個設問，引出後面的轉折。這句詩暗示您的福氣比較特殊，可能不在世俗的名利，而在於精神的富足。您適合在特定的領域（如技藝、宗教）尋找心靈的安頓。",
            "生平福量不周全": "人生不如意事十之八九，這句詩點出您可能在某方面（如財富、健康或感情）略有缺憾。接受這種「不完美」，學會與遺憾共處，反而能讓您更加珍惜手中所擁有的一切。",
            "不須勞碌過平生": "這是一句轉折的吉話！相較於前面的勞碌，這句詩預示著您有機會過上相對輕鬆的日子。或許是您懂得知足常樂，或者運氣開始好轉，生活壓力將逐漸減輕。",
            "此命般般事不成": "這句話聽起來很洩氣，但其實是針對「心態」的提醒。如果抱持消極的態度，自然萬事難成。這是在激將您：想要打破魔咒，就必須拿出破釜沉舟的決心，去完成一件小事，建立信心。",
            "一生骨肉最清高": "「骨肉」指親人，「清高」可能意味著疏離或不願同流合污。您可能與家族成員格格不入，或者有一種傲氣。這代表了您獨特的人格特質，不隨波逐流，堅持走自己的路。",
            "此命終身運不通": "這句詩最為嚴厲，但古書多有誇張。在現代解讀，這代表您可能是一個「懷才不遇」的典型。環境常常限制了您的發展，建議您轉換環境，或尋找非主流的賽道，別在死胡同裡打轉。",

            // --- Male Poems (4.0 - 4.9) ---
            "平生衣祿是綿長": "這是福氣綿延的象徵。雖然未必大富大貴，但「綿長」二字保證了您一輩子衣食無缺，細水長流。這種平穩安定的生活，其實是許多人求之不得的幸福。",
            "此命推來事不同": "您註定與眾不同！這句詩暗示您有獨特的才華或際遇，不適合走尋常路。您的思維模式或處事風格可能異於常人，這正是您的優勢所在，大膽發揮您的創意吧。",
            "得寬懷處且寬懷": "這是一句充滿智慧的勸世語。您的命格中可能有些糾結或放不下的事，詩句勸您「放寬心」。心寬路就寬，許多煩惱其實都是自找的，豁達的態度是您改運的鑰匙。",
            "為人心性最聰明": "天資聰穎是您最大的資產。您的反應快、學習力強，這是成功的入場券。但聰明需用在正途，且需搭配「厚道」，避免恃才傲物，您的智慧才能真正轉化為成就。",
            "來事由天莫苦求": "這句詩充滿了道家哲學。告訴您有些事情強求不來，順其自然反而更好。這不是要您放棄努力，而是要您放下對結果的執著，盡人事聽天命，心態對了，運氣自然會來。",
            "福中取貴格求真": "這是一個相當高雅的命格。您不僅有福氣，更有機會獲得社會地位（貴）。「求真」二字暗示您做人做事要腳踏實地，追求真理與誠信，這將是您通往富貴的道路。",
            "東西南北盡皆通": "四通八達，無往不利！這句詩預示您的適應力極強，無論到哪裡發展都能生存。您的格局開闊，適合跨領域、跨地域的發展，世界就是您的遊樂場。",
            "此命推來旺末年": "標準的「老來俏」命格。年輕時或許平平，但運勢會隨著年齡增長而上揚。晚年福氣旺盛，可能是財富的累積，也可能是子孫的成就，您的好戲在後頭。",
            "幼年運道未曾享": "再次確認了早年的辛苦。您可能沒有一個無憂無慮的童年，過早承擔了責任。但這份早熟讓您更懂得人情世故，這些童年的缺憾將轉化為成年後奮發向上的動力。",
            "此命推來福不輕": "開宗明義，這是一個極具福氣的命格。您的起點很高，或者即使起點平凡，運勢的推升力也極強。請惜福培福，利用這份好運去幫助更多人，您的福氣將會加倍回流。",

            // --- Male Poems (5.0 - 5.9) ---
            "為利為名終日勞": "名利是您追逐的目標，您也為此付出了巨大的努力。這句詩肯定了您的企圖心，但也提醒不要迷失其中。在終日奔波之餘，問問自己真正的快樂是什麼，別讓名利成為枷鎖。",
            "一世榮華事事通": "「通」字最妙，代表人生順暢無阻。無論事業、家庭還是人際，您似乎總能找到解決之道。這份圓融與順遂，來自於您開闊的格局與高度的智慧。",
            "一世亨通事事能": "全能型人才！您似乎什麼都會，什麼都能做。這種多才多藝讓您在職場上無可取代。「事事能」代表極強的執行力，只要您想做的事，通常沒有做不到的。",
            "此格推來氣象真": "「氣象」宏大，非同小可。這句詩形容您的格局與氣度不凡，有大將之風。您適合做大事，看長遠，不要被小利所惑，您的命運格局註定是要成就一番事業的。",
            "此命推來厚且清": "「厚」代表福澤深厚，「清」代表品格高尚。這是一個富貴雙全且名聲極佳的命格。您不僅有物質財富，更有精神潔癖，這份清貴之氣讓您受人敬重。",
            "走馬揚鞭爭名利": "畫面感極強！形容您在名利場上意氣風發，競爭力強。您是行動派，有目標就衝，像騎馬奔騰一樣。這種積極的攻擊性是您成功的關鍵，但也需注意控制節奏，避免過勞。",
            "此格推來禮儀通": "您是一個知書達禮、人情練達的人。您懂得進退應對，社交手腕高明。「禮多人不怪」，這份教養與風度是您最好的通行證，讓您在各個圈子都能左右逢源。",
            "福祿盈盈萬事全": "「盈盈」形容滿出來的樣子，「萬事全」代表沒有缺憾。這是一個接近完美的命格，五福臨門。請珍惜這份難得的幸運，多做善事回饋社會，讓這份圓滿延續下去。",
            "平生福祿自然來": "許多人求之不得的境界！您不需要刻意追求，好運似乎總是自動找上門。這可能源於您的性格討喜，或是有祖德庇蔭。這種「順流而下」的人生，是最大的福報。",
            "細推此格妙且清": "「妙」字形容命格的獨特與精巧。您可能有某種特殊的天賦或專長，無人能及。發掘並打磨這份「妙」處，它將帶給您意想不到的成功與快樂。",

            // --- Male Poems (6.0 - 7.2) ---
            "一朝金榜快題名": "傳統指科舉高中，現代則指專業上的「認證」與「成名」。您將在眾人的見證下獲得巨大的榮譽，無論是考試、升遷還是獲獎，那種「一舉成名天下知」的時刻即將到來。",
            "不做朝中金榜客": "即使不走仕途（公職），您也註定是不凡之人。這句詩暗示您如果從商，將成為鉅富（財翁）。條條大路通羅馬，您的才華無論放在哪個領域，都會是頂尖的存在。",
            "此名生來福不窮": "福氣無窮無盡，取之不竭。這是一種源源不絕的能量，不僅庇蔭自己，還能庇蔭家人朋友。您就像一個發光體，身邊的人都能感受到您的正能量。",
            "命主為官福祿長": "明確指出了「官運」。您適合在體制內發展，或擔任管理職。您的仕途長遠，且伴隨著穩定的收入（福祿）。權力在您手中是用來造福人群的，這是您的天職。",
            "此格權威不可當": "霸氣外露！您天生具有領袖氣質，說話有份量，能讓眾人信服。這種權威感不是強壓下來的，而是來自於您的實力與擔當。您是天生的領導者。",
            "細推此命福不輕": "再次強調福氣之重。這不是小確幸，而是大格局的福報。您可能肩負著重大的社會責任，您的成功將影響許多人的生計與未來，是真正的棟樑之材。",
            "此格人間一福人": "簡單而有力，您就是人間有福之人。這句話勝過千言萬語。無論遇到什麼風浪，您總能安然度過，好像有隱形的翅膀在保護。這種「天選」的感覺，是您自信的來源。",
            "此名生來福自宏": "「宏」意味著宏大。您的福氣格局很大，不拘泥於小節。您的眼界與心胸都比常人寬廣，這讓您能容納更多的財富與機遇，成就非凡的事業。",
            "富貴由天莫苦求": "這是一種境界。告訴您富貴是命中註定的，不需要您像苦行僧一樣去追求。這句話勸您放鬆心情，享受過程，因為結果早已寫好，您只需要優雅地走過去接收即可。",
            "君是人間衣祿星": "您是財神的化身！「衣祿星」代表著豐衣足食。您到哪裡，哪裡就興旺。這句詩讚美了您的招財能力，您不僅自己富足，還能帶動身邊的經濟繁榮。",
            "此命推來福不輕": "反覆出現的福不輕，代表這是一個非常穩定的高分命格。無論在哪個版本，這都是好命的認證。請懷著感恩的心，享受這份上天賜予的禮物。",
            "此名生來大不同": "卓爾不凡！您與眾不同，生來就是為了做大事。這句詩鼓勵您不要害怕「不一樣」，您的獨特性正是您改變世界的力量。勇敢做自己，您將創造歷史。",
            "此格世界罕有生": "稀世珍寶！這種命格百年難得一見。這句話給予您極高的評價，暗示您肩負著特殊的使命。您的存在本身就是一種奇蹟，請珍視並發揮您的影響力。",

            // --- Female Poems (2.1 - 2.9) ---
            "短命非業謂大空": "這句詩是對女性健康的嚴厲警語。「空」代表抓不住，暗示健康或緣分易逝。這是在提醒您要將「愛自己」放在第一位，不要為家庭或感情過度犧牲透支。保養身體，是您最重要的投資。",
            "此命孤冷有淒伶": "形容內心的孤寂感。您可能覺得無人能懂，或身邊缺乏知冷知熱的人。但這種「冷」氣質也賦予您獨特的冷靜與理智。學會享受獨處，在獨處中滋養心靈，您將不再感到淒涼。",
            "此命推來骨肉輕": "親緣較薄，六親無靠。身為女性，您可能被迫早早獨立，無法依賴娘家。這雖然辛苦，但也訓練出您堅強的生存能力。您像一株野草，雖然無人澆灌，卻能頑強生長。",
            "此命推來福祿無": "早年物質生活可能較為匱乏，需要為生計操勞。這句詩提醒您要學會理財，精打細算。雖然起步艱難，但只要勤儉持家，積少成多，一樣能改善生活境遇。",
            "此命推來八字輕": "命格較弱，容易受到環境或他人的擺佈。這提醒您要建立自信，要有主見，不要總是順從他人。學會說「不」，是您掌握自己命運的第一步。",
            "平生衣祿苦尋求": "一輩子都在為了生活打拼。這反映了傳統女性的辛勞，可能要兼顧家庭與工作。這句詩肯定了您的付出，每一分錢都是乾乾淨淨、辛苦賺來的，值得自豪。",
            "竹平做事少間量": "形容做事欠考慮，或者缺乏商量的對象。您可能習慣獨自承擔一切，雖然勇敢，但也容易吃虧。建議您多找人商量，不要一個人扛著所有壓力，適度示弱也是一種智慧。",
            "女命生來八字經": "「八字經」可能指命運多舛，經歷豐富。您的人生像一本寫滿故事的經書，酸甜苦辣都有。這些經歷讓您比別人更成熟、更有韻味，是歲月賦予您的禮物。",
            "花枝要來性情硬": "形容您外表如花，性格卻硬如枝幹。這是一種「外柔內剛」的特質。您不願服輸，性格剛烈。這能保護您不受欺負，但也可能傷人。適度柔軟，會讓您的人際關係更和諧。",

            // --- Female Poems (3.0 - 3.9) ---
            "此命推來比郎強": "女強人！您的能力、氣魄可能都勝過您的伴侶。在傳統觀點這可能有壓得住夫運之嫌，但在現代這是對您能力的極大肯定。您是家庭的頂樑柱，只要學會展現溫柔的一面，也能家庭事業雙贏。",
            "早年行運在忙碌": "年輕時就是個忙碌命，可能要幫忙家計或照顧弟妹。這份忙碌培養了您幹練的辦事能力。別抱怨早年的辛苦，那都是您現在能獨當一面的養分。",
            "時逢吉神在運中": "運氣開始轉好！雖然有挑戰，但總有「吉神」暗中保佑。逢凶化吉是您的特質。這句詩給您信心，無論遇到什麼困難，相信最後都會有好的結果。",
            "八字命來張張薄": "「張張薄」形容運勢單薄，積蓄不易。這是在提醒您要有危機意識，未雨綢繆。不要過度樂觀消費，穩健的儲蓄習慣能為您築起一道安全網。",
            "矮巴勾棗難撈枝": "這句詩用比喻形容「求而不得」的無奈。您可能有心有餘而力不足的感嘆。這是在告訴您要量力而為，設定實際的目標，不要好高騖遠，珍惜手邊能抓住的小確幸。",
            "女子走冰怕冰薄": "如履薄冰，形容處境小心翼翼。您可能身處複雜的環境，或者性格多疑敏感。這份謹慎是您的保護色，但也讓您活得較累。試著信任他人，放鬆緊繃的神經。",
            "憂愁常鎖兩眉間": "心思細膩，容易鑽牛角尖。您可能習慣把心事藏在心裡，臉上常帶憂色。這句詩勸您要「開心」一點，多笑一笑，運氣自然會變好。憂愁解決不了問題，樂觀面對才是解藥。",
            "此命來時運費多": "「運費多」意指波折多，成本高。做什麼事似乎都要比別人多費一番手腳。這不要緊，好事多磨。您的成功雖然來得慢一些，但基礎會打得更穩固。",
            "鳳鳴岐山聞四方": "大吉之兆！形容您的聲名遠播，才華洋溢。您有機會在職場或社交圈中大放異彩，像鳳凰一樣耀眼。無論走到哪裡，您都是眾人注目的焦點。",
            "此命推來運不通": "感覺運氣總是差臨門一腳，有種受困的感覺。這其實是黎明前的黑暗。不要因為暫時的「不通」而放棄，這是在考驗您的耐心。轉個彎，或許就能看見新路。",

            // --- Female Poems (4.0 - 4.9) ---
            "目上月令如運關": "運勢如同過關斬將。雖然關卡重重，但您有能力一一突破。這句詩強調了您的「闖關」能力，每一次的挑戰都讓您變得更強大。您是生活的戰士。",
            "此命推來普普通通": "平凡就是福。您可能覺得自己不出眾，但這種平實、安穩的生活，是多少人羨慕不來的。沒有大起大落，就是歲月靜好。珍惜這份平凡中的幸福。",
            "枯井破廢已多年": "這句詩形容「枯木逢春」的奇蹟。或許您曾經歷過一段很長時間的低潮或沉寂，但轉機即將來臨。乾枯的井將湧出泉水，您的生命將重新煥發光彩。",
            "推車靠涯道路趕": "形容為了生活趕路的情景，辛苦但有方向及目標。您是一個勤奮的實踐者，一步一腳印。雖然路途遙遠，但只要不停下腳步，終點就在前方。",
            "夜夢金銀醒來空": "理想豐滿，現實骨感。這句詩提醒您不要活在幻想中，要腳踏實地。雖然目前可能還未達成財富目標，但只要將美夢化為具體的行動計畫，夢想也能成真。",
            "此命終身駁雜多": "「駁雜」意味著經歷豐富但也複雜。您的人生可能涉足多個領域，或感情經歷較多。這讓您看盡世態炎涼，擁有一顆包容萬物的心。複雜不是壞事，它讓您的生命更有厚度。",
            "孤舟得水離沙灘": "困境解除的吉兆！您就像擱淺的船終於等到了潮水，可以揚帆起航了。這句詩預示著機會的來臨，請做好準備，乘風破浪，去追求您想去的地方。",
            "時來運轉吉氣發": "好運到了！壞運氣已經走完，現在是吉氣勃發的時候。之前所有的努力將在此時開花結果。請張開雙臂，迎接這遲來的正義與好運。",
            "一朵鮮花鏡中開": "鏡花水月，提醒您注意「表象」。有些東西看起來很美好，但可能不切實際。在感情或投資上，要保持理智，看清本質，不要被華麗的外表所迷惑。",
            "此命推來福不輕": "女命中難得的好命。您有福氣，且能旺夫益子。您的存在就是家庭的福星。請善用這份影響力，營造溫馨的家庭氛圍，您的幸福感將會滿溢。",

            // --- Female Poems (5.0 - 7.2) ---
            "馬氏太公不相和": "引用姜太公典故，暗示早年可能夫妻不和或時運不濟。但這也代表「大器晚成」。只要能熬過早期的磨合與困頓，後面的日子將會倒吃甘蔗，越來越甜。",
            "肥羊失群入山崗": "因禍得福之象。雖然看似迷路（失群），卻意外進入了草料豐富的山崗。這代表您在變動中反而能找到更好的資源。別害怕改變，改變往往帶來驚喜。",
            "順風行舟扯起棚": "順風順水，勢不可擋。您的運氣來了，做什麼都順利。這時候要懂得「扯起棚」（張開帆），盡全力去衝刺，讓好運發揮到極致，不要浪費這大好時光。",
            "此命相貌眉活秀": "形容您面容姣好，氣質出眾。這不僅是外表美，更代表內心的靈秀。您的美貌與氣質是您的優勢，能為您贏得良好的人緣與機遇。",
            "學問滿腹運氣強": "知識就是力量！您是一位有內涵、有智慧的女性。您的好運來自於您的學識與判斷力。這句詩鼓勵您持續學習，知識將是您永不貶值的嫁妝。",
            "吉祥平安志量高": "您志向遠大，且一生平安。這是一種很有福氣的野心。您不滿足於現狀，總是追求卓越，而命運也眷顧您，讓您在追夢的路上平安順遂。",
            "明珠書士離埃來": "珍珠出土，光華再現。形容您曾被埋沒，但終將發光。您的才華掩蓋不住，將被世人所看見。這是一個「脫穎而出」的過程，請保持自信，等待那擦亮您的時刻。",
            "游魚戲水被網驚": "虛驚一場。雖然會遇到一些驚險或波折，像魚遇到網，但最終能化險為夷（跳過龍門）。這些驚嚇是為了讓您更警覺，最終您將蛻變為龍，成就非凡。",
            "此命推來閒逛悠": "逍遙自在的貴婦命。您不需要為生活操勞，有大把時間可以「閒逛悠」。這代表經濟富足，心靈自由。這是許多人夢寐以求的生活狀態，請盡情享受。",
            "雨雪載途泥濘至": "路不好走，充滿泥濘。這是在形容創業或持家的艱辛過程。但泥濘過後必有晴天。這句詩肯定了您的堅韌不拔，您是在風雨中綻放的玫瑰，愈冷愈開花。",
            "女命八字喜氣和": "喜氣洋洋，一團和氣。您是一個樂天派，走到哪裡都帶笑聲。您的樂觀感染了身邊的人，讓所有困難都迎刃而解。這種「人和」是您最大的財富。",
            "緣木求魚事多端": "提醒您方法可能用錯了。不要在樹上找魚，要找對方向。這句詩勸您審視目前的追求是否切實際。調整策略，換個方向努力，就能避免徒勞無功。",
            "指日升高氣象新": "步步高升，氣象一新。您的運勢正在向上爬升，每天都有新的進步。無論是職位、財富還是生活品質，都在往更好的方向發展。保持這股向上的動力。",
            "五官脫運難抬頭": "這句話在現代解讀為「暫時的低潮」。可能覺得抬不起頭來，或不受重視。但運勢是流動的，「脫運」之後就是「交運」。請蟄伏等待，調整狀態，準備迎接下一次的抬頭。",
            "俊鳥曾得出籠中": "海闊憑魚躍，天高任鳥飛。您就像衝出籠子的俊鳥，終於獲得了自由。這句詩預示著您將擺脫束縛（如不工作的婚姻、糟糕的環境），展翅高飛，追尋自己的天空。",
            "時來運轉銳氣周": "氣場全開！您的銳氣與自信回來了。這代表您將掌握主導權，不再是配角。在職場或家庭中，您的意見將受到重視，展現出女王般的風範。",
            "亂絲無頭定有頭": "剪不斷理還亂，但終究會有頭緒。這句詩形容您善於處理複雜的事務。雖然目前看起來一團亂，但憑藉您的耐心與智慧，一定能抽絲剝繭，理出頭緒，解決難題。",
            "水庭明月不可撈": "水中撈月，一場空。再次提醒不要追求虛幻的東西。對於不切實際的感情或投資，要懂得放手。放下執念，腳踏實地，才能抓住真正的幸福。",
            "太公封祖不非凡": "引用歷史典故，形容家世或際遇不凡。您可能出身書香門第或有特殊背景。這份底蘊讓您氣質高雅，見識不凡，是人群中的佼佼者。",
            "此命推來喜氣新": "天天都有好事發生。這是一種心境的轉化，看什麼都順眼。當您心生喜悅，好運自然相隨。這句詩祝福您每天都活得開心，喜氣洋洋。",
            "此命推來鴻運交": "鴻運當頭！這是大吉大利的徵兆。運勢交接到了最好的時刻。現在是您人生的黃金期，想做什麼就大膽去做，全世界都會為您讓路。"
        };

        function getPoemLineExplanation(line, index) {
            // Priority 1: Check Specific Poem Line Map (1-to-1 Mapping)
            // Trim punctuation logic handled by raw key matching or simple include check
            // We use .includes to handle potential punctuation diff "，" vs ","
            for (const [key, value] of Object.entries(poemLineMap)) {
                if (line.includes(key)) {
                    return value;
                }
            }

            // Priority 2: Fallback to Context-Aware Engine + Variation System (The generated logic)
            function getVariant(str, options) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = ((hash << 5) - hash) + str.charCodeAt(i);
                    hash |= 0;
                }
                const idx = Math.abs(hash) % options.length;
                return options[idx];
            }

            if (index === 0) { // --- PHASE 1: THE ROOT (命格基調) ---
                if (line.match(/(短|災|凶|禍|厄|逆|困)/)) return getVariant(line, [
                    "此句揭示了命格中潛藏的挑戰。您生來可能體質較弱，或容易感受到生命的無常。但請記得，『命由天定，運由人造』，這份先天的警示是為了讓您更懂得惜福與養生，透過後天的修身養性，完全可以轉危為安。",
                    "詩句點出了先天體質上的弱點。這並非不可逆轉的定局，而是一個善意的提醒。注重養生，保持樂觀心態，往往能逢凶化吉，延年益壽。",
                    "命格中帶有些許波折的信號。但古人云「大德者不被命縛」，多行善積德，調整生活作息，便能增強元氣，走出屬於自己的康莊大道。"
                ]);
                if (line.match(/(寒|冷|微|無|輕|薄|孤|伶|仃|乞)/)) return getVariant(line, [
                    "這句詩暗示您的起跑點可能較為平凡。祖輩留下的基業不多，讓您從小就養成了獨立自主的性格。這份白手起家的經歷，將是您未來最寶貴的資產。",
                    "雖無豐厚的祖蔭庇佑，但這正是您展現個人能力的機會。您的每一分成就都將來自於自己的雙手，這種踏實感是任何財富都無法比擬的。",
                    "起點雖低，但後勢可期。這句詩象徵著您是一顆待磨的鑽石，早期的匱乏是為了激發您內在的潛能，預示著您具有極強的生命韌性。"
                ]);
                if (line.match(/(清高|聰|明|智|慧|文|讀|學|才|秀|巧|靈|書|儒)/)) return getVariant(line, [
                    "這是一個充滿靈氣的開局！您天生氣質出眾，資質聰穎，擁有過人的領悟力。無論從事何種行業，您的才華與智慧都將是您最亮眼的名片。",
                    "天資聰穎是您最大的優勢。您對事物有獨到的見解，不願隨波逐流。善用您的智慧，在專業領域深耕，定能獲得令人矚目的成就。",
                    "詩句讚賞您的精神世界豐富且高雅。您擁有文人雅士般的風骨，這份獨特的氣質讓您在人群中格外出眾，容易獲得他人的敬重。"
                ]);
                if (line.match(/(福|祿|財|金|榮|貴|堆|玉|厚|清|旺|真|非|凡|君|喜|吉|祥)/)) return getVariant(line, [
                    "真是令人羨慕的開局！這句詩點出您命中『帶財帶貴』，先天福報深厚。這份與生俱來的福氣，將為您的一生奠定穩固安樂的基礎。",
                    "命格基調相當優越，象徵著富貴與榮耀。您可能自帶幸運體質，在人生的關鍵時刻總能獲得資源挹注，順風順水。",
                    "此乃福澤深厚之象。無論是物質生活還是社會地位，您都有極高的起點。珍惜這份福報，並心存善念，運勢將會更加長久。"
                ]);
                if (line.match(/(飄|離|移|走|遠|外|遊|忙|碌|東|西|南|北)/)) return getVariant(line, [
                    "這句詩顯示您有著『驛馬』星動的特質。您注定不是池中之物，家鄉的舞台太小了。別害怕變動，廣闊的世界才是您真正的家。",
                    "命帶驛馬，動中求財。您的機遇往往在遠方，離開舒適圈反而能激發您的潛能。多出去走走看看，將會為您帶來意想不到的收穫。",
                    "註定要行萬里路的命格。您適合向外發展，甚至是海外求職。移動不僅能增廣見聞，更是您開啟好運的鑰匙。"
                ]);
                if (line.match(/(僧|道|佛|空|緣)/)) return getVariant(line, [
                    "這句詩帶有濃厚的宗教或哲學色彩。暗示您與佛道有緣，或者性格中有一份超脫世俗的寧靜。您對精神層面的追求往往高於物質享受。",
                    "命格中透著一份清靜與智慧。您可能對人生哲理有著比常人更深的體悟，這種超然的心境將幫助您度過人生的紛擾。",
                    "與佛法或玄學有不解之緣。這代表您擁有極強的直覺與悟性，適合從事需要高度精神專注或心靈引導的工作。"
                ]);

                return getVariant(line, [
                    "這句總綱詩為您的人生定下了基調。它顯示您擁有獨特的生命韌性，無論起點如何，您的性格中都藏著不服輸的種子。",
                    "作為命格的開篇，這句詩暗示了您不凡的潛質。這是一個需要自我探索與定義的命格，您的價值將在您認識自己的過程中逐漸展現。",
                    "這首詩揭示了您性格中的底色。無論外在環境如何變遷，保持內心的定力與初衷，將是您一生最重要的課題。"
                ]);
            }
            else if (index === 1) { // --- PHASE 2: EARLY LIFE ---
                if (line.match(/(勤|苦|勞|忙|奔|波|難|厄|折|磨|空|徒|費|憂|愁|酸|辣|煎|熬)/)) return getVariant(line, [
                    "早年運勢顯示為『勞碌』之相。年輕時的您可能為了學業或生計四處奔波，但這些早期的辛苦都是在打磨您的鋒芒，為未來的成就累積能量。",
                    "年輕時或許會感到比同齡人辛苦，凡事需親力親為。但請相信，所有的汗水都不會白流，這段經歷將培養出您堅不可摧的意志力。",
                    "這句詩暗示早年多磨練。雖然過程艱辛，但這正是老天爺在擴充您的器量。您因此而獲得的抗壓性與實戰經驗，將是未來成功的基石。"
                ]);
                if (line.match(/(成|立|名|顯|高|通|達|標|榜|升|秀|美|好|強|順)/)) return getVariant(line, [
                    "少年得志之象！您在年輕時期就有機會展露頭角，確立人生志向。早年的成功經驗將帶給您強大的自信，助您在人生賽道上領跑。",
                    "這句詩預示著您早年運勢亨通。無論是學業還是初入職場，您都能展現出色的才華，獲得長輩或上司的賞識。",
                    "起步相當順利，如同順風揚帆。您的才華在年輕時就能被看見，這是極大的優勢。請好好把握這段黃金時期，為未來打下堅實基礎。"
                ]);
                if (line.match(/(親|兄|弟|妹|無|靠|敗|散|冷|孤|單|獨|支|撐)/)) return getVariant(line, [
                    "這句詩暗示早年親情緣分較淡，或六親助力難顯。您很早就學會了『靠自己』，這種獨立的性格將讓您在社會競爭中更具優勢。",
                    "家族助力有限，一切需靠自己打拼。雖然初期會感到孤單，但這也讓您擺脫了人情的束縛，能更自由地追求自己想要的人生。",
                    "六親緣薄，反而是激勵您向上的動力。您不依賴他人，習慣獨力解決問題，這種強大的獨立性是您最寶貴的特質。"
                ]);
                if (line.match(/(吉|祥|順|和|安|平|穩|定|足|盈|全)/)) return getVariant(line, [
                    "早年運勢順遂，如同順水推舟。成長過程相對平穩，少有大風大浪。這份福氣讓您能心無旁騖地積累知識，為將來做好準備。",
                    "平穩安樂的早年。您可能在充滿愛的環境中成長，或者求學之路相當順利。這種穩定感是您性格中溫暖與自信的來源。",
                    "運勢平順，少有挫折。這讓您擁有比別人更健康的心理素質。利用這段平穩期充實自己，將是您未來最大的本錢。"
                ]);
                if (line.match(/(婚|姻|夫|妻|郎|配)/)) return getVariant(line, [
                    "早年的運勢似乎與『緣分』緊密相關。這可能暗示您早婚，或者在年輕時就經歷了深刻的情感課題，教會您如何去愛。",
                    "情竇初開較早。這句詩暗示感情生活將佔據您早年很大的比重。無論結果如何，這些經歷都將使您的心智更加成熟。",
                    "姻緣早定之象。您可能很年輕就會遇到生命中重要的人，這段關係將對您的人生軌跡產生深遠的影響。"
                ]);

                return getVariant(line, [
                    "這句詩描述了您成長過程中的點滴。或許早年有些許波折，但這正是命運在教導您如何面對世界，塑造了您現在的價值觀。",
                    "回首早年歲月，無論是苦是樂，都是您生命中不可或缺的養分。這些經歷讓您學會了珍惜，也更加懂得如何在逆境中尋找光亮。",
                    "早年的際遇深刻影響了您的性格。這段時期的探索與嘗試，雖然懵懂，卻為您後來的人生方向埋下了重要的伏筆。"
                ]);
            }
            else if (index === 2) { // --- PHASE 3: MID-LIFE ---
                if (line.match(/(三|四|中|年|轉|換|變|改|過|運|限|時|機|枯|木|花)/)) return getVariant(line, [
                    "中年是您人生的關鍵轉折點！詩句暗示在這個階段，運勢將迎來重大變化。請把握時機大膽求變，這次的轉折往往是『否極泰來』的開始。",
                    "行至中年，將迎來柳暗花明又一村的契機。過去的累積將在此時發生質變，只要勇於突破現狀，必能看見更廣闊的天空。",
                    "這是一個破繭成碟的關鍵期。或許會面臨變動與挑戰，但請不要抗拒，因為這正是命運將您推向更高峰的推手。"
                ]);
                if (line.match(/(名|利|財|發|旺|興|隆|官|職|權|威|耀|榮|華|富|貴|金|銀|勝|前)/)) return getVariant(line, [
                    "這是事業騰飛的徵兆！人到中年，過去的努力開始兌現。財源廣進，名利雙收，這句詩鼓勵您在此階段全力衝刺，收穫將超乎想像。",
                    "中年運勢如日中天，是人生收穫最豐碩的黃金時期。無論是職位晉升還是財富累積，都能達到一個新的高度。",
                    "名利雙收之象。您在專業領域的地位將在此時確立，多年的耕耘終於結出累累碩果，是值得慶祝的豐收時刻。"
                ]);
                if (line.match(/(蹉|跎|難|阻|滯|遲|未|空|夢|虛|妄|費|力|如|水|流|鏡|花)/)) return getVariant(line, [
                    "中年時期可能仍需經歷一番考驗。目前的進展可能比預期緩慢，有種『好事多磨』的感覺。調整步伐，耐心沉潛，堅持到最後一刻。",
                    "雖然看似進展停滯，實則是在蓄力。這句詩提醒您不要急躁，時機未到時宜守不宜攻，養精蓄銳等待下一次的爆發。",
                    "夢想的實現或許會遲到，但不會缺席。中年的波折是為了考驗您的決心，只要不輕言放棄，轉機往往就在下一個路口。"
                ]);
                if (line.match(/(貴|人|助|遇|逢|提|攜|合|夥|交|易)/)) return getVariant(line, [
                    "中年運勢貴人運極旺！在您打拼的過程中，將會遇到賞識您的伯樂。善用您的社交資源，多與人合作，將能突破瓶頸。",
                    "貴人來相助。這句詩強調人脈的重要性。您身邊將出現強有力的合作夥伴，藉助他人的力量，您將能達成更大的成就。",
                    "逢凶化吉，遇難呈祥。中年的運勢因「人」而貴。多廣結善緣，這些人際存摺將在關鍵時刻為您提供最大的助力。"
                ]);
                if (line.match(/(自|立|更|生|守|舊|安|然|逍|遙)/)) return getVariant(line, [
                    "中年的運勢趨向平穩，適合守成。這句詩建議您專注於本業，不宜過度冒進。在平淡中尋找確定的幸福，也是一種難得的福氣。",
                    "穩紮穩打是此階段的上策。不求大富大貴，但求心安理得。這種安然自得的生活態度，將讓您避開許多不必要的風險。",
                    "逍遙自在之象。您可能不再執著於名利的追逐，轉而追求內心的平靜。這份從容將讓您的中年生活更有品質。"
                ]);

                return getVariant(line, [
                    "這句詩點出了您中年時期的運勢走向。這是一段奮鬥與收穫並存的時光。無論目前現狀如何，都請保持積極向上的心態。",
                    "中年是人生的中流砥柱。這句詩語帶玄機，暗示著您在此階段的選擇將決定後半生的格局，務必審慎而行。",
                    "行至半途，更見心志。這段時期的經歷將主要圍繞在事業與家庭的平衡，您的智慧將引領您度過每一個關卡。"
                ]);
            }
            else { // --- PHASE 4: LATE LIFE ---
                if (line.match(/(福|壽|安|樂|休|閒|悠|泰|吉|慶|佳|美|稱|心|如|意|康|健)/)) return getVariant(line, [
                    "這是最令人嚮往的結局！詩句預示您的晚年生活將充滿福氣與安樂。勞碌半生，終於能卸下重擔，享受清閒的退休生活。",
                    "晚景優渥，身心安泰。這份寧靜與滿足，是您一生努力最好的回報。請放下牽掛，盡情享受這份歲月靜好的福份。",
                    "福壽雙全之象。晚年的您將擁有健康的身體與愉悅的心情，無病無災，是修來的好福氣。"
                ]);
                if (line.match(/(財|富|金|倉|庫|豐|足|祿|帛|源|堆|積|滿|盈|宏|隆|翁)/)) return getVariant(line, [
                    "晚景富足之象！您的倉庫將堆滿金玉。您不僅自身財富自由，更有能力庇蔭子孫。這代表您一生的理財規劃相當成功。",
                    "財星晚年高照，經濟狀況十分寬裕。您將不缺錢花，甚至能過上比年輕時更優渥的生活，是標準的富貴閒人。",
                    "積玉堆金，晚年無憂。這句詩保證了您物質生活的豐足，過去的辛勤耕耘，將化為晚年最堅實的經濟保障。"
                ]);
                if (line.match(/(子|孫|賢|孝|家|興|骨|肉|庭|眷|屬|圓|滿|聚)/)) return getVariant(line, [
                    "家族興旺的吉兆！晚年的您將享受天倫之樂，子孫賢孝有成。看著後輩成材，家庭和樂融融，這將是您晚年最大的安慰。",
                    "蘭桂騰芳，滿門俊秀。這句詩強調了家族血脈的成功傳承。您不僅傳承了財富，更傳承了良好的家風，後福無窮。",
                    "兒孫繞膝，福氣滿門。晚年的幸福來源於親情的滋潤。您將被愛包圍，享受著大家族熱鬧溫馨的氛圍。"
                ]);
                if (line.match(/(成|名|顯|達|榮|耀|皇|紫|極|品|威|聲|聞|揚)/)) return getVariant(line, [
                    "大器晚成，名留青史！即使到了晚年，您的聲望與地位依然不減。您的一生沒有白活，留下了精彩的故事與榜樣。",
                    "晚年享有極高的社會清望。這句詩意味著您的成就經得起時間考驗，將獲得後輩的敬重與景仰，榮耀滿門。",
                    "功成名就，光耀門楣。您的晚年將在眾人的掌聲與尊重中度過，這是對您一生貢獻最大的肯定。"
                ]);
                if (line.match(/(無|憂|無|慮|不|須|愁|莫|苦|求)/)) return getVariant(line, [
                    "這是一種『放下』的智慧與福氣。詩句預示您晚年將無憂無慮，不再為世俗瑣事煩心。這種心靈的自由比金錢更珍貴。",
                    "笑看風雲，安享當下。這句詩代表您心境的豁達與轉化。所有的煩惱都已隨風而去，只留下歲月沉澱後的寧靜。",
                    "莫苦求，福自來。晚年的您懂得了順其自然，這種知足常樂的心態，將讓您的日子過得比任何人都輕鬆快活。"
                ]);

                return getVariant(line, [
                    "這句壓軸詩為您的一生畫下了句點。它預示著一個平靜而有所獲的晚年，您的生命故事終將迎來一個圓滿的章節。",
                    "夕陽無限好。這句詩象徵著晚年的智慧與圓融，回首來時路，雖有風雨，但更多的是成長與釋懷。",
                    "結局是美好的。無論過程如何，這句詩保證了您最終能獲得內心的平靜，安享天倫，了無遺憾。"
                ]);
            }
        }

        // --- FOUR PILLARS PLAIN ANALYSIS ENGINE ---
        // --- COMPLEX DAY MASTER ATTRIBUTES (Source of Detailed Analysis) ---
        const dayMasterAttributes = {
            "甲": {
                name: "甲木 (參天大樹)",
                desc: "正直仁慈，棟樑之材",
                character: "您的本命元神為「甲木」，象徵參天大樹。這代表您天生具有「向上生長」的意志力，性格正直、仁慈且富責任感。您像大樹一樣不屈不撓，遇到風雨也不輕易低頭。這種特質讓您在人群中容易成為值得信賴的依靠，但有時因過於剛直，不懂變通，容易在無意間得罪人而不自知。",
                career: "甲木人具備領袖氣質與宏觀視野。您不適合機械式、重複性的工作，而是需要一個能讓您「紮根」並持續成長的舞台。您有很強的保護欲與統籌能力，適合承擔重任。之所以能成大事，是因為您能像大樹一樣，耐得住寂寞，長期耕耘直到開花結果。",
                wealth: "您的財運多來自於「正財」，即踏實工作所得。大樹成長緩慢但穩固，您的財富也往往是隨年齡增長而累積。不建議追求短線的高風險投機，因為甲木的根基一動，容易傷及元氣。只要專注本業，您的「蔭庇」能力（資產）將越來越豐厚。",
                love: "在感情中，您是像大樹一樣遮風擋雨的守護者。雖然不擅長甜言蜜語，但給予伴侶的安全感是無可取代的。您傾向於穩定的長久關係，但需注意不要過於大男人/大女人主義，適度的溫柔彎腰，會讓感情更和諧。"
            },
            "乙": {
                name: "乙木 (花草之木)",
                desc: "柔順靈活，適應力強",
                character: "您的本命元神為「乙木」，象徵蔓藤花草。主要特質為「以柔克剛」，您擁有極強的環境適應力與韌性。不同於甲木的強硬，您懂得身段柔軟，善於察言觀色與協調人際。這種細膩的心思讓您在處理複雜關係時游刃有餘，但有時也容易因過於敏感而產生依賴心或優柔寡斷。",
                career: "乙木人是天生的謀略家與協調者。您擅長「藉力使力」，就像藤蔓攀附大樹一樣，您懂得尋找強有力的合作夥伴。您的思維靈活，適合在變化快速的環境中生存。之所以能成功，往往是因為您能看見別人忽略的細節，與能在夾縫中求生存的生存智慧。",
                wealth: "您的財源非常靈活，往往有多個小的收入來源匯聚成河。您具備敏銳的市場嗅覺，能捕捉到微小的商機。不像大樹需要深根，花草隨風傳播，您的財運也帶有流動性。適合利用人脈生財，口碑與人際網絡是您最大的金礦。",
                love: "情感豐富且細膩是您的特點。您像纏繞的藤蔓，在感情中容易依賴對方，渴望被呵護。因為心思敏感，容易受到情緒波動影響。建議在感情中培養多一點獨立性，那份溫柔將成為您最迷人的武器。"
            },
            "丙": {
                name: "丙火 (太陽之火)",
                desc: "熱情豪爽，光耀照人",
                character: "您的本命元神為「丙火」，象徵天上的太陽。您天生自帶光芒，熱情、開朗、充滿正能量。您心裡藏不住事，喜怒哀樂全寫在臉上，這種真誠讓您極具感染力。您樂於助人，不求回報，就像太陽無私普照大地。但要注意有時熱情過度會變為急躁，或好面子而打腫臉充胖子。",
                career: "丙火人天生屬於舞台。您需要一份能展現自我、受到關注的工作。您的領袖魅力強大，能夠瞬間點燃團隊的熱情。之所以在職場受歡迎，是因為您從不吝嗇給予他人讚美與溫暖。切記，太陽若被烏雲遮蔽（挫折）會失去光彩，保持自信是您唯一的生存法則。",
                wealth: "您的財運通常是大進大出。因為慷慨豪爽，交際應酬開銷大，但也因此結識各路英雄好漢，帶來廣闊的財路。您的財富多與「名氣」掛鉤，名氣越大，財運越旺。建立個人品牌或信譽，是您致富的最佳捷徑。",
                love: "您的愛像正午的陽光，熱烈而直接。喜歡一個人會主動出擊，毫無保留。在感情中您坦率真誠，不喜歡猜忌。但要注意，陽光太強有時會灼傷人，給對方一點私密空間，這段關係會更舒適長久。"
            },
            "丁": {
                name: "丁火 (燈燭之火)",
                desc: "溫文儒雅，心思縝密",
                character: "您的本命元神為「丁火」，象徵夜裡的燈燭。不同於太陽的普照，您的光芒是集中且溫暖的。您外表或許溫文儒雅，內心卻蘊藏著強大的爆發力。心思縝密，洞察力極強，往往能看穿事物的本質。您有犧牲奉獻的精神，願意燃燒自己照亮他人，但若長期壓抑，內心容易積累負面情緒。",
                career: "丁火人是優秀的策劃者與幕後推手。您能在黑暗中指引方向，適合從事需要深度思考或引導他人的工作。您的價值在於「專注」，能將一件小事做到極致。之所以受人敬重，是因為您在關鍵時刻總能提出獨到的見解，或在危機中成為眾人的精神支柱。",
                wealth: "您的財運來自於專業技術或智慧財。燈火需要燃油（知識/技能）才能長明，因此投資自己是最好的理財。您的財富有積少成多的特質，雖然不像暴發戶般耀眼，但勝在細水長流，晚年財運通常優於早年。",
                love: "您的感情含蓄而深沉，像燭光晚餐般浪漫。您非常敏感，容易多愁善感。一旦愛上一個人，會把對方放在心尖上呵護。建議您多表達內心的想法，別讓對方猜謎，否則那份深情容易變成一種沉重的負擔。"
            },
            "戊": {
                name: "戊土 (城牆之土)",
                desc: "穩重厚實，誠信寬容",
                character: "您的本命元神為「戊土」，象徵厚實的城牆或高山。主要特質是「信」，您給人極大的安全感，答應的事絕不食言。性格穩重、寬容，擁有大將之風。您不容易被外界動搖，但這種堅定有時也會變成固執不知變通。您像大地一樣沉默寡言，卻默默承載著所有的責任與壓力。",
                career: "戊土人是團隊中的定海神針。您不一定是最衝鋒陷陣的，但一定是最能穩住局面的。適合在大型機構或穩定體系中發展。之所以能身居高位，是因為您的包容力能整合各種不同的人才，且在危機來臨時，您能成為大家最堅實的後盾。",
                wealth: "土主信，信生財。您的財富建立在良好的信用資產上。雖然發財速度不快，但基礎非常穩固，不易破敗。房地產或土地相關投資往往是您的幸運領域。只要守住「誠信」二字，財富自然會像山嶽一樣越堆越高。",
                love: "您的愛情像山一樣堅定。不輕易動情，一旦認定就是一輩子。您不懂花言巧語，只會用實際行動來照顧對方。您的伴侶會感到無比的踏實與安全。但要注意，偶爾製造一點浪漫與驚喜，能讓這份如岩石般的愛更具情趣。"
            },
            "己": {
                name: "己土 (田園之土)",
                desc: "內斂含蓄，多才多藝",
                character: "您的本命元神為「己土」，象徵培育萬物的田園土壤。您性格內斂、溫和，處事謹慎圓融。您多才多藝，具有極強的吸收力與轉化力，能將前人的智慧轉化為自己的養分。雖然不像高山那樣雄偉，但您擁有滋養萬物的包容心，私底下往往是朋友圈中最好的傾聽者與軍師。",
                career: "己土人是解決問題的高手。您擅長處理細節與複雜的人際關係。不像戊土那麼剛硬，您懂得用迂迴的方式達成目的。適合從事教育、培訓或服務性質的工作。之所以不可或缺，是因為所有的大樹（人才）都需要您這塊田園提供養分才能成長。",
                wealth: "您的財富來自於「耕耘」。田園需要播種、施肥才有收穫，所以您不適合投機，而適合透過長期經營來獲利。您善於理財，懂得精打細算。只要像農夫一樣勤奮，您的資產庫就會像豐收的糧倉一樣，年年有餘。",
                love: "您的感情細膩且包容。在關係中，您往往是付出較多的一方，像土壤滋養植物一樣滋養著伴侶。這是一種潤物細無聲的愛。但要小心，不要過度寵壞對方，要有自己的原則與界線，感情才能健康生長。"
            },
            "庚": {
                name: "庚金 (刀劍之金)",
                desc: "剛毅果斷，義氣干雲",
                character: "您的本命元神為「庚金」，象徵鋒利的刀劍或鋼鐵。主要特質是「剛」，您性格豪爽，愛恨分明，做事乾脆俐落，絕不拖泥帶水。您極重義氣，路見不平必拔刀相助。這種剛直的性格讓您極具魄力，但也容易因為說話太直、不懂修飾而無意傷人，就像刀劍太利容易傷手。",
                career: "庚金人是天生的開拓者與改革者。您不畏艱難，越是混亂的局面越能激發您的鬥志。適合從事軍警、司法、改革性強或需要高度執行力的工作。之所以能成大器，是因為您具備斬斷亂麻的決斷力，在關鍵時刻敢於做別人不敢做的決定。",
                wealth: "您的財運帶有「肅殺」之氣，意味著財富往往來自於變革或競爭。您有賺大錢的魄力，敢於冒險投資。金子需要火煉才能成器，所以經歷一些財務波折反而能讓您的理財觀念更成熟。適合技術生財或高競爭領域的獲利。",
                love: "您的愛是霸道總裁式的。愛就愛得轟轟烈烈，不愛就斷得乾乾淨淨。您對伴侶不僅是愛，更有一份責任與保護欲。但要注意，感情不是戰場，不需要分出勝負。學會示弱與溫柔，把百煉鋼化為繞指柔，是您感情修煉的重點。"
            },
            "辛": {
                name: "辛金 (珠寶之金)",
                desc: "高貴優雅，外柔內剛",
                character: "您的本命元神為「辛金」，象徵精緻的珠寶首飾。您天生帶有一種貴氣，重視生活品味與儀式感。心思細膩，對美有獨到的鑑賞力。表面上看起來柔和圓融，其實內心自尊心極強，亦有稜角（珠寶雖小卻堅硬）。您好面子，受不得氣，對於輕視您的人會記在心裡。",
                career: "辛金人是完美的代言人。您做事追求極致，容不下瑕疵。適合從事設計、精品、金融或任何需要精密與品味的工作。您的價值在於「質感」，能將普通的事物提升到藝術的層次。之所以能脫穎而出，是因為您那份與生俱來的高級感與對完美的執著。",
                wealth: "您的財富如同珠寶，是「藏」起來的。您不喜歡露白，但私底下可能積蓄頗豐。您有獨特的投資眼光，善於發掘潛力股。不像庚金的大開大闔，您的財運是精緻靈巧的，適合透過智取或專業技能獲取高附加價值的報酬。",
                love: "您希望擁有一段像偶像劇般完美的愛情。對伴侶的要求較高，不僅要條件好，還要有品味。在感情中您比較矜持，希望對方主動。但要記得，人無完人，放下對完美的執著，接納真實的對方，您會發現不完美的愛情更動人。"
            },
            "壬": {
                name: "壬水 (江河之水)",
                desc: "聰明奔放，海納百川",
                character: "您的本命元神為「壬水」，象徵奔騰的江河大海。主要特質是「動」，您思維活躍，反應極快，充滿智慧。您不喜歡受到束縛，嚮往自由自在的生活。您的包容力極強，像大海一樣能容納百川，大是大非面前非常有氣度。但有時情緒起伏較大，任性起來就像洪水氾濫，難以控制。",
                career: "壬水人是天生的策路家與外交官。您適應力極強，到哪裡都能生存。適合從事變動性大、需要創意與口才的工作，如貿易、媒體、或自由業。之所以能成功，是因為您的眼界寬廣，能看見別人看不見的趨勢，且懂得順勢而為，像水一樣繞過障礙奔向大海。",
                wealth: "水主智，智生財。您的財富來自於流動與智慧。靜止的水會發臭，所以您的錢必須「動」起來才能增值（如貿易、投資）。您有大開大闔的財氣，容易發橫財，但若無堤防（自制力），錢財也容易流失。學會築堤蓄水（儲蓄），是您理財的關鍵。",
                love: "您的感情像海浪一樣洶湧澎湃。多情、浪漫且充滿魅力，異性緣通常很好。您喜歡聰明有趣的伴侶，受不了沉悶。在感情中您需要很大的自由空間。但要小心，太自由容易讓對方缺乏安全感。給予承諾並落實，是讓感情停泊港灣的錨。"
            },
            "癸": {
                name: "癸水 (雨露之水)",
                desc: "溫柔細膩，潤物無聲",
                character: "您的本命元神為「癸水」，象徵滋潤萬物的晨露或雨水。您性格溫柔沉靜，外表看似平靜，內心卻情感豐富波瀾壯闊。您直覺敏銳，善解人意，是最富同理心的人。做事採取滲透戰術，無聲無息中改變局勢。雖然看起來柔弱，但滴水穿石，您的韌性往往超乎想像。",
                career: "癸水人是最佳的輔佐者與潛移默化者。您不需要在台前大呼小叫，卻能掌控全局。適合心理諮詢、研發、幕後策劃等需要細膩思維的工作。之所以強大，是因為您無孔不入，能滲透到每個人的心裡。您的力量是柔性的，卻能化解最剛硬的障礙。",
                wealth: "您的財運細水長流。雨露雖小，但積少成多。您適合賺取服務財或腦力財。您對金錢有獨特的直覺，往往能憑感覺避開風險。不像壬水的大起大落，您的財富是透過一點一滴的積累與滲透而來，最終匯聚成湖。",
                love: "您的愛情是浪漫且夢幻的。您極度渴望靈魂伴侶，對於感覺非常重視。在感情中，您溫柔體貼，願意為對方改變自己（像水適應容器）。但有時過於敏感多疑，容易情緒化。學會建立內心的安全感，不要讓情緒的雨季下得太久，愛情的花朵才能綻放。"
            }
        };

        const zodiacMap = {
            "子": "聰明機靈，善於社交，觀察力敏銳",
            "丑": "勤奮踏實，耐力極佳，但稍顯固執",
            "寅": "行動力強，充滿自信，有領袖風範",
            "卯": "溫和文靜，心思細膩，但稍顯優柔",
            "辰": "氣宇非凡，志向遠大，好勝心強",
            "巳": "神秘敏銳，冷靜沈著，處事圓融",
            "午": "熱情奔放送，性格開朗，但性急易怒",
            "未": "溫柔敦厚，富同情心，外柔內剛",
            "申": "活潑好動，多才多藝，機智過人",
            "酉": "深思熟慮，勤奮上進，追求完美",
            "戌": "忠誠可靠，直率坦白，防衛心強",
            "亥": "樂觀豁達，心地善良，不拘小節"
        };

        function renderFourPillarsAnalysis(detail, lunar) {
            // 1. Fill Text Content from Comprehensive Analysis Detail
            if (document.getElementById('analysisCharacter')) document.getElementById('analysisCharacter').innerHTML = detail.character;
            if (document.getElementById('analysisWealth')) document.getElementById('analysisWealth').innerHTML = detail.wealth;
            if (document.getElementById('analysisCareer')) document.getElementById('analysisCareer').innerHTML = detail.career;
            if (document.getElementById('analysisLove')) document.getElementById('analysisLove').innerHTML = detail.love;

            // 2. Extra Career Recommendations (from Day Master Element) - Preserving original logic
            const bazi = lunar.getBaZi();
            const dayGan = bazi[2].substring(0, 1);
            const dmElement = wuxingMap[dayGan];

            const careerExtraDiv = document.getElementById('analysisCareerExtra');
            if (careerExtraDiv) {
                careerExtraDiv.innerHTML = ""; // Clear previous

                if (dmElement && wuxingInfo[dmElement]) {
                    const careers = wuxingInfo[dmElement].careers;
                    const careerHtml = `
                                                <div class="mt-4 pt-4 border-t border-dashed border-red-100">
                                                    <h6 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                                                        <svg class="w-4 h-4 mr-1.5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                                        適合您的職業方向
                                                    </h6>
                                                    <div class="space-y-2.5">
                                                        ${careers.map(c => {
                        const parts = c.split("：");
                        const category = parts[0];
                        const details = parts[1] || "";
                        return `
                                    <div class="flex items-start">
                                        <span class="inline-flex items-center justify-center px-2.5 py-0.5 rounded text-xs font-bold bg-red-50 text-red-700 border border-red-100 mr-2 shrink-0">
                                            ${category}
                                        </span>
                                        <p class="text-xs text-gray-600 leading-5 pt-0.5">${details}</p>
                                    </div>
                                    `;
                    }).join('')}
                                                    </div>
                                                </div>
                                                `;
                    careerExtraDiv.innerHTML = careerHtml;
                }
            }
        }

        // --- FIVE ELEMENTS LOGIC ---
        const wuxingMap = {
            // Heavenly Stems
            "甲": "wood", "乙": "wood",
            "丙": "fire", "丁": "fire",
            "戊": "earth", "己": "earth",
            "庚": "metal", "辛": "metal",
            "壬": "water", "癸": "water",
            // Earthly Branches (Main Qi)
            "寅": "wood", "卯": "wood",
            "巳": "fire", "午": "fire",
            "辰": "earth", "戌": "earth", "丑": "earth", "未": "earth",
            "申": "metal", "酉": "metal",
            "亥": "water", "子": "water"
        };

        const wuxingInfo = {
            wood: {
                name: "木",
                missingReason: "五行缺木，猶如樹木無根，性格上容易缺乏仁愛與惻隱之心。行事往往欠缺條理與恆心，容易半途而廢。在人際與處事上，可能較為剛硬、缺乏彈性與包容力，難以適應環境的變化。思維上較少創新，對於未來的規劃也常感到迷茫，不易定下心來深耕單一領域。",
                crystals: [
                    { name: "綠幽靈", desc: "主正財，被譽為『事業水晶』，其綠色光芒對應心輪，能帶來工作上的好運與貴人運。它非屬橫財，而是獎勵努力工作後的正當報酬，能增強您的企圖心與執行力，為木行注入源源不絕的生機與活力。" },
                    { name: "孔雀石", desc: "具有強大的轉化與保護能量，能吸收外在負面情緒與壓力，撫平內心焦躁。它能讓您的心境回歸平和與包容，重啟木行的仁愛特質，並帶來幸運與希望。" },
                    { name: "葡萄石", desc: "溫和而具韌性的『希望之石』，能指引人生方向，增強直覺與判斷力。在您迷惘時，它能助您堅定信念，培養木行所需的恆心與毅力，堅持到底。" }
                ],
                geodeShape: { shape: "長方形 (木型)", reason: "缺木者常缺定性與持續力。長方形晶洞象徵『向上生長』的力量，能輔助您紮根穩固，增強耐心與事業開創的續航力。" },

                careers: [
                    "文教相關：教育界、文學創作、出版業、書店、培訓機構",
                    "自然與生機：園藝、農林業、木材家具、花店、中草藥、素食餐飲",
                    "設計與藝術：服裝設計、室內設計、文創產業、美術館"
                ]
            },
            fire: {
                name: "火",
                missingReason: "五行缺火，猶如寒夜無燈，性格上傾向內向、冷淡，對於周遭事物缺乏熱情與積極的動力。在人群中往往較為沈默，不善於表達情感。做事時容易虎頭蛇尾，缺乏衝勁與冒險精神，遇到困難容易退縮。思維較為悲觀，缺乏自信與領袖魅力，難以帶動團隊氣氛。",
                crystals: [
                    { name: "紅紋石", desc: "擁有『愛神小丘比特』之稱，能徹底打開被封閉的心輪，釋放負面記憶。它能讓您重拾對生命的熱情與活力，散發自信粉紅光芒，補足火行缺失的感染力與人緣。" },
                    { name: "紫水晶", desc: "兼具理性與感性的『社交之石』，能提升社交手腕，招來貴人相助。它能讓您在人群中散發自信與智慧的光芒，同時穩定情緒，改善內向冷淡的特質，激發潛在的領導力。" },
                    { name: "紅瑪瑙", desc: "象徵友善與堅毅的寶石，能激發體內的陽剛之氣，消除恐懼與猶豫。它能讓您做事更有魄力與衝勁，改善虎頭蛇尾的毛病，不僅美容養顏，更能增強行動力。" }
                ],
                geodeShape: { shape: "三角形/不規則尖頂 (火型)", reason: "缺火者易缺乏動力與熱情。三角形晶洞狀似火焰，能有效地激發您的行動力與領導魅力，點燃對生活的熱忱與積極性。" },

                careers: [
                    "光熱能源：能源產業、電力、照明、燃氣、太陽能",
                    "美與表演：演藝娛樂、美容美髮、化妝品、攝影、廣告行銷",
                    "餐飲與服務：熱食餐飲、百貨零售、酒店管理、手工藝品"
                ]
            },
            earth: {
                name: "土",
                missingReason: "五行缺土，猶如地基不穩，性格上可能較缺乏穩重感與信用，給人一種漂泊不定、難以捉摸的感覺。內心深處常缺乏安全感，導致行事反覆無常，難以堅持原則。在人際交往中，可能較為現實或缺乏包容力，難以建立深厚長久的信任關係，且容易在居住或職業上頻繁變動。",
                crystals: [
                    { name: "黃水晶", desc: "被譽為『財富之石』，其黃色光芒對應太陽輪，能大幅增強自信心與果敢的決策力。它能消除猶豫不決，為不穩定的土行帶來強大的安穩能量，同時招來意想不到的偏財運。" },
                    { name: "虎眼石", desc: "霸氣之石，擁有如老虎般銳利的眼神，能激發勇氣與執行力，貫徹始終。它能強化氣場，讓您建立威信，改善漂泊不定的心性，帶來如大地般堅定不移的行動力。" },
                    { name: "鈦晶", desc: "水晶之王，能量極為霸道強勁，兼具招財、化煞、防小人等多重功效。它能賦予您強大的氣勢與權威感，穩固您的根基與信用，適合需要做重大決策時配戴。" }
                ],
                geodeShape: { shape: "正梯形/平台 (土型)", reason: "缺土者較缺乏安全感與信賴感。平台型晶洞象徵『穩如泰山』，能為您帶來強大的靠山能量，鎮守財庫，穩定心性與基業。" },

                careers: [
                    "土地與建設：房地產、建築業、室內裝修、土木工程、物業管理",
                    "穩定與收納：倉儲物流、古董鑑定、當鋪、殯葬業",
                    "中介與諮詢：顧問諮詢、仲介服務、秘書、會計、行政管理"
                ]
            },
            metal: {
                name: "金",
                missingReason: "五行缺金，猶如刀鋒未開，性格上容易優柔寡斷，缺乏果敢的決斷力與威嚴。做事容易拖泥帶水，顧慮太多而錯失良機。在原則性問題上不夠堅持，容易隨波逐流，缺乏主見。同時也代表思維不夠犀利，缺乏條理性與執行力，難以在競爭激烈的環境中脫穎而出。",
                crystals: [
                    { name: "白水晶", desc: "具有最純淨平穩的能量。它能淨化混亂的磁場，提升專注力與記憶力，讓思緒清晰敏捷。它能幫助您屏除雜念，補足金行所需的果斷、條理與執行效率。" },
                    { name: "月光石", desc: "溫柔的能量能調和焦躁的情緒，帶來冷靜的觀察力。它能幫助您在決策時保持清醒，不被情緒左右，提升直覺與洞察力，展現出金行應有的理性與智慧。" },
                    { name: "鈦晶", desc: "水晶之王，能量極為霸道強勁，兼具招財、化煞、防小人等多重功效。它能賦予您強大的氣勢與權威感，穩固您的根基與信用，適合需要做重大決策時配戴。" }
                ],
                geodeShape: { shape: "圓形/半圓形 (金型)", reason: "缺金者決斷力較弱，行事易優柔寡斷。圓形晶洞象徵『圓滿周全』與『果斷凝聚』，能提升您的處事魄力，並帶來圓融的人際財富。" },

                careers: [
                    "金融與法治：銀行、證券、保險、律師、法官、警政人員",
                    "金屬與機械：機械製造、汽車產業、珠寶銀樓、五金工具、鐘錶",
                    "科技與決策：高科技產業、企業顧問、執行長、外科醫生"
                ]
            },
            water: {
                name: "水",
                missingReason: "五行缺水，猶如源頭乾涸，性格上可能缺乏靈動的智慧與應變能力。思維較為僵化，不善於轉彎，難以應對複雜多變的局勢。雖然終日奔波勞碌，卻往往是事倍功半，難以聚財。在性格上可能較為急躁或固執，缺乏深謀遠慮的眼光，不善於交際應酬與謀略規劃。",
                crystals: [
                    { name: "黑曜石", desc: "擁有極度強大的吸納性，能強力吸收負面能量與病氣，是最佳的護身符。它能讓浮躁的心沉澱下來，增強生命力與精神耐力，為水行補充深沉的底蘊與定性。" },
                    { name: "海藍寶", desc: "勇氣之石，對應喉輪，能大幅提升語言表達與溝通協調能力。它能幫助您思路清晰，靈活應變，補足水行所需的流動性與智慧，適合需要多方交涉的人士。" },
                    { name: "拉長石", desc: "充滿靈性的寶石，能激發深層的創造力與潛能。其多變的光暈象徵水的多變，能幫助您適應各種環境，提升洞察力與智慧，避免思維僵化。" }
                ],
                geodeShape: { shape: "波浪形/不規則彎曲 (水型)", reason: "缺水者思維容易僵化，不知變通。波浪形晶洞象徵『川流不息』的水能量，能活絡您的思維與靈感，增強應變能力，帶來源源不絕的財源。" },
                careers: [
                    "流動與交通：航運、物流、交通運輸、旅遊業、貿易進出口",
                    "資訊與智慧：網路業、軟體開發、記者、大眾傳播、心理諮詢",
                    "水利與清潔：水利工程、清潔服務、飲料店、酒吧、水族館"
                ]
            }
        };

        const zodiacGeodeMap = {
            "鼠": { name: "鼠", element: "水", shape: "波浪形 (水型)", shapeName: "波浪形", desc: "鼠之本命屬水，靈動機敏，然易隨波逐流。波浪形晶洞宛如聚寶盆中的活水，能匯聚四方財氣，將您的聰慧轉化為實質的財富。它象徵源源不絕的的人脈與機運，能大旺偏財，助您在變動的局勢中游刃有餘，財源廣進。" },
            "牛": { name: "牛", element: "土", shape: "正梯形 (土型)", shapeName: "正梯形", desc: "牛之本命屬土，敦厚沈穩，但有時過於保守。正梯形晶洞象徵『穩如泰山』的基業，能為您鎮守財庫，防止錢財流失。其厚實的能量能增強您的魄力與決斷力，讓您在穩健中求突破，步步高升，成就百年大業。" },
            "虎": { name: "虎", element: "木", shape: "長方形 (木型)", shapeName: "長方形", desc: "虎之本命屬木，氣勢威猛，正如參天大樹。長方形直聳的晶洞象徵事業『扶搖直上』，能輔助您開疆闢土，增強領導統御的權威感。它能穩固您的根基，讓你在職場上屹立不搖，招來貴人提攜，成就非凡霸業。" },
            "兔": { name: "兔", element: "木", shape: "長方形 (木型)", shapeName: "長方形", desc: "兔之本命屬木，心思細膩，如花草般柔韌。長方形晶洞能為您注入強大的『棟樑之氣』，提升您的自信與格局，不再受情緒左右。它能助您在職場上展現獨當一面的能力，將人緣轉化為實質的貴人運，名利雙收。" },
            "龍": { name: "龍", element: "土", shape: "正梯形 (土型)", shapeName: "正梯形", desc: "龍之本命屬土，貴氣逼人，如帝王降臨。方正厚實的梯形晶洞最能匹配您的氣場，象徵權勢穩固與地位崇高。它能幫助您鎮壓身邊的小人與煞氣，匯聚天地正氣，讓您的事業運勢如日中天，掌握實質大權。" },
            "龙": { name: "龍", element: "土", shape: "正梯形 (土型)", shapeName: "正梯形", desc: "龍之本命屬土，貴氣逼人，如帝王降臨。方正厚實的梯形晶洞最能匹配您的氣場，象徵權勢穩固與地位崇高。它能幫助您鎮壓身邊的小人與煞氣，匯聚天地正氣，讓您的事業運勢如日中天，掌握實質大權。" },
            "蛇": { name: "蛇", element: "火", shape: "尖形/不規則 (火型)", shapeName: "尖形", desc: "蛇之本命屬火，神祕敏銳，洞察力強。火焰狀的尖形晶洞能點燃您內心的熱情與企圖心，將潛藏的才華徹底釋放。它能增強您的名聲運與桃花運，讓您在人群中散發耀眼光芒，事業與人際皆能如火如荼，大展鴻圖。" },
            "馬": { name: "馬", element: "火", shape: "尖形/不規則 (火型)", shapeName: "尖形", desc: "馬之本命屬火，奔放自由，行動力極強。形如火焰的晶洞能與您的陽氣產生共鳴，讓您的行動更加精準有效，避免衝動行事。它象徵運勢『紅紅火火』，能助您在競爭激烈的環境中脫穎而出，快速達成目標，財運亨通。" },
            "马": { name: "馬", element: "火", shape: "尖形/不規則 (火型)", shapeName: "尖形", desc: "馬之本命屬火，奔放自由，行動力極強。形如火焰的晶洞能與您的陽氣產生共鳴，讓您的行動更加精準有效，避免衝動行事。它象徵運勢『紅紅火火』，能助您在競爭激烈的環境中脫穎而出，快速達成目標，財運亨通。" },
            "羊": { name: "羊", element: "土", shape: "正梯形 (土型)", shapeName: "正梯形", desc: "羊之本命屬土，外柔內剛，具有極強的韌性。平台形晶洞象徵廣闊大地的包容力，能安定您的心神，消除焦慮與不安。它能為您帶來家庭與事業的雙重穩定，聚氣聚財，讓您在歲月靜好中累積豐厚的資產，福氣綿長。" },
            "猴": { name: "猴", element: "金", shape: "三角形/圓形 (金型)", shapeName: "三角形/圓形", desc: "猴之本命屬金，聰慧靈巧。三角形晶洞狀似金字塔，象徵凝聚專注；圓形晶洞則代表圓滿招財。兩者皆能將您的才智轉化為強大的執行力，讓決策果斷犀利，同時廣結善緣，財源廣進。" },
            "雞": { name: "雞", element: "金", shape: "三角形/圓形 (金型)", shapeName: "三角形/圓形", desc: "雞之本命屬金，勤奮自信。三角形線條象徵突破與精準，圓形則象徵周全與圓融。這兩種形態皆能強化您的口才與表現力，助您在職場上展現大將之風，既能開拓疆土，也能守成聚財。" },
            "鸡": { name: "雞", element: "金", shape: "三角形/圓形 (金型)", shapeName: "三角形/圓形", desc: "雞之本命屬金，勤奮自信。三角形線條象徵突破與精準，圓形則象徵周全與圓融。這兩種形態皆能強化您的口才與表現力，助您在職場上展現大將之風，既能開拓疆土，也能守成聚財。" },
            "狗": { name: "狗", element: "土", shape: "正梯形 (土型)", shapeName: "正梯形", desc: "狗之本命屬土，忠誠守信，責任感強。方正穩重的晶洞最能呼應您的特質，象徵『信用即財富』。它能為您累積深厚的信譽資本，讓您在商場上無往不利，同時鎮宅安家，守護您辛苦累積的財富，基業長青。" },
            "豬": { name: "豬", element: "水", shape: "波浪形 (水型)", shapeName: "波浪形", desc: "豬之本命屬水，生性樂觀，福氣深厚。蜿蜒流暢的晶洞造型象徵福氣與財富的流轉，能增強您的貴人運與食祿。它能活絡您的思維，帶來意想不到的偏財運，讓您一生衣食無憂，財富如流水般自然匯聚，富貴安康。" },
            "猪": { name: "豬", element: "水", shape: "波浪形 (水型)", shapeName: "波浪形", desc: "豬之本命屬水，生性樂觀，福氣深厚。蜿蜒流暢的晶洞造型象徵福氣與財富的流轉，能增強您的貴人運與食祿。它能活絡您的思維，帶來意想不到的偏財運，讓您一生衣食無憂，財富如流水般自然匯聚，富貴安康。" }
        };

        function analyzeFiveElements(baziArr, lunarObj) {
            // baziArr e.g., ["甲子", "乙丑", "丙寅", "丁卯"]
            const userShengXiao = lunarObj.getYearShengXiao(); // 獲取生肖
            const counts = { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 };

            baziArr.forEach(pillar => {
                const gan = pillar.substring(0, 1);
                const zhi = pillar.substring(1, 2);

                if (wuxingMap[gan]) counts[wuxingMap[gan]]++;
                if (wuxingMap[zhi]) counts[wuxingMap[zhi]]++;
            });

            const missing = [];
            for (const [elm, count] of Object.entries(counts)) {
                if (count === 0) missing.push(elm);
            }

            // Logic Adjustment: Ensure at least one element is recommended even if none are missing
            if (missing.length === 0) {
                // Find the lowest count
                let min = Infinity;
                for (const count of Object.values(counts)) {
                    if (count < min) min = count;
                }
                // Add all elements with the lowest count to 'missing' (treating them as 'needs strengthening')
                for (const [elm, count] of Object.entries(counts)) {
                    if (count === min) {
                        missing.push(elm);
                    }
                }
            }

            // User Requirement: Select ONLY ONE element for recommendation
            if (missing.length > 1) {
                missing.length = 1; // Keep only the first one found
            }

            // Render UI
            const container = document.getElementById('fiveElementsContainer');

            // 1. Zodiac Geode Section (Always shown)
            const zInfo = zodiacGeodeMap[userShengXiao];
            const geodeHtml = `
                                                <div class="mb-8 border-b border-dashed border-gray-200 pb-8">
                                                    <!-- Geode Recommendation (Floating Label) -->
                                                    <div class="relative border border-gray-300 rounded-lg p-6 mt-4">
                                                        <h5 class="absolute -top-3 left-4 bg-white px-2 text-xs font-bold text-gray-400 tracking-widest uppercase">
                                                            晶洞五行推薦
                                                        </h5>
                                                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 items-start sm:items-center">
                                                            <div class="flex flex-col shrink-0">
                                                                <span class="text-xs bg-red-700 text-white px-3 py-1 rounded self-start mb-1 tracking-widest font-bold shadow-sm">
                                                                    ${zInfo.name}・${zInfo.element}型
                                                                </span>
                                                                <span class="text-lg font-bold text-gray-800">
                                                                    ${zInfo.shapeName}
                                                                </span>
                                                            </div>
                                                            <p class="text-xs text-gray-500 leading-relaxed text-justify sm:border-l sm:border-gray-200 sm:pl-4 mt-2 sm:mt-0">
                                                                ${zInfo.desc}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                `;

            // Render combined HTML - logic simplified to always show recommendations
            let combinedHtml = geodeHtml + `<p class="mb-6 text-center text-sm text-gray-600">您的八字五行中需補足：<span class="font-bold text-red-700 text-lg mx-2">${missing.map(m => wuxingInfo[m].name).join('、')}</span></p>`;

            missing.forEach(mKey => {
                const info = wuxingInfo[mKey];
                combinedHtml += `
                                                <div class="mb-8 last:mb-0 border-b border-dashed border-gray-200 pb-8 last:pb-0 last:border-0">
                                                    <!-- Analysis -->
                                                    <div class="mb-4">
                                                        <h5 class="font-bold text-gray-800 text-base mb-2 flex items-center">
                                                            <span class="w-1.5 h-6 bg-gray-600 mr-2 rounded-full"></span>
                                                            缺【${info.name}】的影響
                                                        </h5>
                                                        <p class="text-gray-600 text-sm leading-relaxed text-justify pl-3.5 border-l-2 border-gray-200 ml-1">
                                                            ${info.missingReason}
                                                        </p>
                                                    </div>

                                                    <!-- Crystal Recommendation Link only -->
                                                    <div class="mt-6">
                                                        <!-- Crystal Recommendation (Floating Label) -->
                                                        <div class="relative border border-gray-300 rounded-lg p-6">
                                                            <h5 class="absolute -top-3 left-4 bg-white px-2 text-xs font-bold text-gray-400 tracking-widest uppercase">
                                                                隨身開運水晶
                                                            </h5>
                                                            <ul class="space-y-4">
                                                                ${info.crystals.map(c => `
                                            <li class="group">
                                                <div class="flex items-center mb-1">
                                                    <span class="w-1.5 h-1.5 bg-red-800 rounded-sm mr-2 opacity-50 group-hover:opacity-100 transition-opacity"></span>
                                                    <span class="font-bold text-gray-900 text-sm tracking-wide group-hover:text-red-800 transition-colors">${c.name}</span>
                                                </div>
                                                <p class="text-xs text-gray-500 pl-3.5 leading-relaxed text-justify border-l border-gray-100 ml-0.5 group-hover:border-red-100 transition-colors">
                                                    ${c.desc}
                                                </p>
                                            </li>
                                        `).join('')}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                `;
            });

            container.innerHTML = combinedHtml;
        }

        // --- AI Analysis Logic ---

        // Partial Key Logic
        const API_KEY_PREFIX = "AIzaSyCrL4WxeQAX4Qjy87Hi34v7EXShq";

        function showApiKeyModal(errorMsg = '') {
            const modal = document.getElementById('apiKeyModal');
            const errorEl = document.getElementById('apiKeyError');

            modal.classList.remove('hidden');
            document.getElementById('inputApiKey').value = '';
            document.getElementById('inputApiKey').focus();

            if (errorMsg) {
                errorEl.innerText = errorMsg;
                errorEl.classList.remove('hidden');
                document.getElementById('inputApiKey').classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            } else {
                errorEl.classList.add('hidden');
                document.getElementById('inputApiKey').classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            }
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').classList.add('hidden');
        }

        function showLoading(callback) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('hidden');

            // Force a small delay to allow UI to render the loading spinner
            setTimeout(() => {
                try {
                    callback();
                } catch (e) {
                    console.error("Error during execution:", e);
                    alert("執行發生錯誤，請稍後再試。\n" + e.message);
                } finally {
                    // Always hide overlay even if error occurs
                    // Add a small delay for better UX (so spinner doesn't flash too fast)
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                    }, 500);
                }
            }, 100);
        }

        function saveApiKey() {
            const input = document.getElementById('inputApiKey');
            const suffix = input.value.trim();
            if (!suffix || suffix.length < 5) {
                showApiKeyModal('長度不足，請輸入完整的後 6 碼');
                return;
            }

            const fullKey = API_KEY_PREFIX + suffix;

            localStorage.setItem('gemini_api_key', fullKey);
            closeApiKeyModal();
            handleAIAnalysis(); // Retry immediately
        }

        window.handleAIAnalysis = async function () {
            if (!window.latestBaziData) {
                alert("請先進行八字計算！(若剛載入頁面，請先點擊「開始批算」)");
                return;
            }

            // 1. Get API Key strategy: CONFIG (dev) -> LocalStorage (prod/fallback)
            let apiKey = '';

            // Check CONFIG first (if loaded)
            if (typeof CONFIG !== 'undefined' && CONFIG.GEMINI_API_KEY && !CONFIG.GEMINI_API_KEY.includes('在此貼上')) {
                apiKey = CONFIG.GEMINI_API_KEY;
            }

            // If no valid config key, try LocalStorage
            if (!apiKey) {
                const localKey = localStorage.getItem('gemini_api_key');
                if (localKey) {
                    apiKey = localKey;
                }
            }

            // If still no key, show input modal
            if (!apiKey) {
                showApiKeyModal();
                return;
            }

            const resultArea = document.getElementById('aiResultArea');
            const loading = document.getElementById('aiLoading');
            const content = document.getElementById('aiContent');
            const aiBtn = document.getElementById('aiBtn');

            // 2. Prepare UI
            resultArea.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.innerHTML = "";
            aiBtn.disabled = true;
            aiBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // 3. Construct Prompt
            const data = window.latestBaziData;
            const carNum = document.getElementById('inputCarNumber').value.trim();
            const phoneNum = document.getElementById('inputPhoneNumber').value.trim();

            let extraInfo = "";
            if (carNum) extraInfo += `\n- 車牌號碼：${carNum}`;
            if (phoneNum) extraInfo += `\n- 電話號碼：${phoneNum}`;

            const prompt = `
                                                你是一位精通八字命理與人生哲學的大師。請根據以下命主資料，進行深度的命理分析與建議。請保持專業、白話、積極正向的語氣，並且回復時以男生或女生判斷用"你"或"妳"回復，不要用命主來稱呼，詞語上不要有太肯定的表達。

                                                【命主資料】
                                                - 性別：${data.gender === 'male' ? '男' : '女'}
                                                - 出生時間：${data.solarDate}
                                                - 八字四柱：${data.bazi.join(' ')} (年 月 日 時)
                                                - 袁天罡骨重：${data.weight}
                                                - 核心歌訣：${data.poem}${extraInfo}


                                                【請依序給出以下五點分析 (請使用 HTML 格式輸出，如 <b>, <br>)】
                                                    1. **命格總評**：(請綜合八字與骨重，給出一段深刻的總結，約 100 字，一段式)
                                                    2. **潛藏天賦**：(指出命主的潛在優勢或特殊才能，約 100 字，一段式)
                                                    3. **感情建議**：(針對命主的2026年後的感情運勢，給出具體心態與建議，約 100 字，一段式)
                                                    4. **流年運勢**：(針對命主的流年，給出屬於2026年後的運勢分析)
                                                    5. **幸運數字${(carNum || phoneNum) ? '與號碼解析' : ''}**：(請提供 1-4 個適合該八字的幸運數字並簡述原因。${(carNum || phoneNum) ? '並根據這些幸運數字，簡單分析上方提供的車牌或電話號碼之吉凶(電話號碼請忽略前兩碼09)。' : ''})

                                                    請直接輸出內容，不要有多餘的開場白。
                                                    `;

            try {
                // 4. Call Gemini API
                const analysis = await window.callGeminiAPI(apiKey, prompt);

                // 5. Render Output
                const cleanText = analysis.replace(/```html/g, '').replace(/```/g, '');
                content.innerHTML = cleanText;

            } catch (error) {
                console.error(error);

                // If invalid key (usually 400 Bad Request with specific message, but we can catch generic API failures too if they imply auth issues)
                if (error.message.includes('API key not valid') || error.message.includes('400') || error.message.includes('API request failed')) {
                    localStorage.removeItem('gemini_api_key'); // Clear invald key

                    // Reset UI State for retry
                    loading.classList.add('hidden');
                    aiBtn.disabled = false;
                    aiBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    resultArea.classList.add('hidden'); // Hide empty result area

                    showApiKeyModal("通關密語錯誤，請確認後重新輸入");
                    return;
                }

                content.innerHTML = `<span class="text-red-500">分析發生錯誤：${error.message}<br>請檢查 config.js 中的 API Key 是否正確。</span>`;
            } finally {
                loading.classList.add('hidden');
                aiBtn.disabled = false;
                aiBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };

        window.callGeminiAPI = async function (key, text) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`;
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    temperature: 0.1 // Lower variance for consistent answers
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error?.message || 'API request failed');
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }
    </script>
    </div>

    <!-- Back to Top Button -->
    <button id="backToTopBtn"
        class="fixed bottom-8 right-8 bg-red-800 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 opacity-0 translate-y-10 pointer-events-none hover:bg-red-700 hover:shadow-xl z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

    <script>
        // Back to Top Logic
        const backToTopBtn = document.getElementById('backToTopBtn');

        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                backToTopBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
                backToTopBtn.classList.add('opacity-100', 'translate-y-0');
            } else {
                backToTopBtn.classList.remove('opacity-100', 'translate-y-0');
                backToTopBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
            }
        });

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    </script>
    <!-- API Key Input Modal -->
    <div id="apiKeyModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-80 z-[200] hidden flex items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div
            class="bg-white max-w-md w-full mx-4 rounded-xl shadow-2xl p-8 relative transform scale-100 transition-transform border-t-4 border-red-800">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-serif font-bold text-gray-800 mb-2 tracking-widest">通關密語</h3>
                <p class="text-gray-500 text-sm">請輸入金鑰的<span class="text-red-700 font-bold mx-1">最後 6 碼</span>以啟動 AI</p>
            </div>

            <div class="space-y-4">
                <div>

                    <input type="text" id="inputApiKey" placeholder="請輸入最後 6 碼" maxlength="6"
                        class="w-full bg-gray-50 border border-gray-300 text-gray-800 text-lg rounded-lg focus:ring-red-800 focus:border-red-800 block p-3 text-center tracking-[0.5em] font-mono font-bold transition-colors">

                    <p id="apiKeyError" class="hidden text-red-600 text-xs font-bold mt-2 text-center animate-pulse">
                        <!-- Error Message -->
                    </p>

                    <p class="text-xs text-gray-400 mt-2 text-center">
                        驗證通過後將自動記憶，下次無需再輸入。
                    </p>
                </div>

                <div class="flex gap-3">
                    <button onclick="saveApiKey()"
                        class="flex-1 bg-red-800 hover:bg-red-900 text-white font-serif font-bold py-3 px-4 rounded-lg transition-colors tracking-widest shadow-md">
                        確認儲存
                    </button>
                    <button onclick="closeApiKeyModal()"
                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 font-serif font-bold py-3 px-4 rounded-lg transition-colors tracking-widest">
                        取消
                    </button>
                </div>


            </div>
        </div>
    </div>
</body>

</html>