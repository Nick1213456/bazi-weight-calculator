<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八字算命 - 袁天罡稱骨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bazi-red': '#B91C1C', // Deep red
                        'bazi-gray': '#F3F4F6', // Light gray bg
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fff;
            color: #333;
        }

        .serif-font {
            font-family: 'Noto Serif TC', serif;
        }

        /* Custom Checkbox/Radio Styles */
        input[type="radio"] {
            accent-color: #B91C1C;
        }

        .form-input {
            border: 1px solid #D1D5DB;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            text-align: center;
        }

        .dashed-line {
            border-bottom: 1px dashed #E5E7EB;
            margin: 1.5rem 0;
        }

        .red-border-box {
            border-top: 2px solid #B91C1C;
            border-bottom: 2px solid #B91C1C;
            background-color: #FAFAFA;
        }
    </style>
</head>

<body class="min-h-screen py-10 px-4 max-w-3xl mx-auto">

    <!-- Header -->
    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold mb-2 text-black">八字算命</h1>
        <p class="text-gray-500 text-sm tracking-widest">洞悉天機 · 掌握命運</p>
    </div>

    <!-- Form Section -->
    <div class="max-w-2xl mx-auto mb-16">

        <!-- Calendar Selection -->
        <div class="mb-6">
            <label class="block text-gray-700 font-medium mb-2 text-sm">曆法選擇</label>
            <div class="flex gap-6 items-center">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="calendarType" value="solar"
                        class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300">
                    <span class="ml-2 text-sm">國曆 (西元)</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="calendarType" value="lunar" checked
                        class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300">
                    <span class="ml-2 text-sm">農曆</span>
                </label>
            </div>
        </div>

        <!-- Gender Selection -->
        <div class="mb-6">
            <label class="block text-gray-700 font-medium mb-2 text-sm">性別</label>
            <div class="flex gap-6 items-center">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="gender" value="male" checked
                        class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300">
                    <span class="ml-2 text-sm">男</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="gender" value="female"
                        class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300">
                    <span class="ml-2 text-sm">女</span>
                </label>
            </div>
        </div>

        <!-- Birth Date Selection -->
        <div class="mb-8">
            <label class="block text-gray-700 font-medium mb-2 text-sm">出生時間</label>
            <div class="flex flex-wrap items-center gap-2">
                <div class="relative w-24">
                    <select id="inputYear"
                        class="w-full form-input appearance-none bg-white pr-6 cursor-pointer text-sm py-1.5 focus:outline-none focus:border-red-800">
                    </select>
                    <span class="absolute right-2 top-1.5 text-xs text-gray-400 pointer-events-none">▼</span>
                </div>
                <span class="text-sm text-gray-500">年</span>

                <div class="relative w-16">
                    <select id="inputMonth"
                        class="w-full form-input appearance-none bg-white pr-4 cursor-pointer text-sm py-1.5 focus:outline-none focus:border-red-800 text-center">
                    </select>
                </div>
                <span class="text-sm text-gray-500">月</span>

                <div class="relative w-16">
                    <select id="inputDay"
                        class="w-full form-input appearance-none bg-white pr-4 cursor-pointer text-sm py-1.5 focus:outline-none focus:border-red-800 text-center">
                    </select>
                </div>
                <span class="text-sm text-gray-500">日</span>

                <div class="relative w-24">
                    <select id="inputTime"
                        class="w-full form-input appearance-none bg-white pr-6 cursor-pointer text-sm py-1.5 focus:outline-none focus:border-red-800 text-center">
                        <option value="zi">子 (23-01)</option>
                        <option value="chou">丑 (01-03)</option>
                        <option value="yin">寅 (03-05)</option>
                        <option value="mao">卯 (05-07)</option>
                        <option value="chen">辰 (07-09)</option>
                        <option value="si">巳 (09-11)</option>
                        <option value="wu">午 (11-13)</option>
                        <option value="wei">未 (13-15)</option>
                        <option value="shen">申 (15-17)</option>
                        <option value="you">酉 (17-19)</option>
                        <option value="xu">戌 (19-21)</option>
                        <option value="hai">亥 (21-23)</option>
                    </select>
                    <span class="absolute right-2 top-1.5 text-xs text-gray-400 pointer-events-none">▼</span>
                </div>
                <span class="text-sm text-gray-500">時</span>
            </div>
        </div>

        <button onclick="calculateBazi()"
            class="w-full bg-white border border-gray-300 text-gray-800 hover:bg-gray-50 hover:border-gray-400 font-medium py-2.5 rounded shadow-sm transition-all text-sm">
            開始算命
        </button>
    </div>

    <div class="border-t border-gray-100 my-10"></div>

    <!-- Result Area -->
    <div id="resultArea" class="hidden max-w-2xl mx-auto space-y-12 animate-[fadeIn_0.5s_ease-out]">

        <!-- Weight Display -->
        <div class="text-center">
            <h3 class="text-red-700 text-xs font-bold mb-2 tracking-wider">袁天罡稱骨</h3>
            <div class="text-6xl font-serif text-gray-800 mb-3" id="totalWeightDisplay">
                <!-- Calculated Weight -->
            </div>
            <p class="text-xs text-gray-400">
                基數 :
                年<span id="yearW"></span> +
                月<span id="monthW"></span> +
                日<span id="dayW"></span> +
                時<span id="timeW"></span>
            </p>
        </div>

        <!-- Poem Box -->
        <div class="red-border-box p-8 text-center">
            <p id="mainPoem" class="text-xl md:text-xl text-gray-700 leading-loose font-serif">
                <!-- Poem goes here -->
            </p>
        </div>

        <!-- Pillars (Visual Placeholder - Logic requires full Bazi engine) -->
        <div class="grid grid-cols-4 gap-4">
            <div class="bg-gray-50 rounded p-4 text-center">
                <div class="text-xs text-gray-400 mb-1">年柱</div>
                <div class="font-bold text-gray-800 text-lg" id="pillarYear">- -</div>
            </div>
            <div class="bg-gray-50 rounded p-4 text-center">
                <div class="text-xs text-gray-400 mb-1">月柱</div>
                <div class="font-bold text-gray-800 text-lg">- -</div>
            </div>
            <div class="bg-gray-50 rounded p-4 text-center">
                <div class="text-xs text-gray-400 mb-1">日柱</div>
                <div class="font-bold text-gray-800 text-lg">- -</div>
            </div>
            <div class="bg-gray-50 rounded p-4 text-center">
                <div class="text-xs text-gray-400 mb-1">時柱</div>
                <div class="font-bold text-gray-800 text-lg">- -</div>
            </div>
        </div>

        <!-- Detailed Explanations -->
        <div class="space-y-2">
            <div class="text-center mb-8">
                <span class="text-xs font-bold text-gray-400 tracking-widest">歌訣詳解</span>
            </div>

            <!-- Analysis Items (Generated from Poem) -->
            <div id="poemAnalysis" class="space-y-8">
                <!-- Dynamic Content -->
            </div>
        </div>

        <!-- Character Analysis (Static Layout for Demo) -->
        <div class="dashed-line"></div>
        <div class="space-y-8 pb-10">
            <div class="text-center mb-8">
                <span class="text-xs font-bold text-gray-400 tracking-widest">命格綜合分析</span>
            </div>

            <div>
                <h4 class="text-red-700 font-bold mb-2 text-sm">性格特質</h4>
                <p class="text-gray-600 text-sm leading-relaxed text-justify">
                    性格正直，自我要求高。你可能有些完美主義，對自己和身邊的人都有一定的標準。富有正義感，且學習能力極強，擅長思考。（此為範例分析，實際需結合完整八字盤）
                </p>
            </div>
            <div class="dashed-line"></div>
            <div>
                <h4 class="text-red-700 font-bold mb-2 text-sm">事業運勢</h4>
                <p class="text-gray-600 text-sm leading-relaxed text-justify">
                    適合公職、法律、教育、學術研究。早年就展現才華，三十六歲左右會迎來事業的高峰，可能獲得晉升或掌握實權。（此為範例分析）
                </p>
            </div>
            <div class="dashed-line"></div>
            <div>
                <h4 class="text-red-700 font-bold mb-2 text-sm">財運運勢</h4>
                <p class="text-gray-600 text-sm leading-relaxed text-justify">
                    正財運祥盛。你的財富主要來自於你的職位和專業地位，並非投機得來。隨著職位提升，收入自然水漲船高，生活富足。（此為範例分析）
                </p>
            </div>
        </div>

    </div>

    <script>
        // --- DATA & LOGIC ---
        // (Reusing existing logic logic with updated DOM targets)
        const jiaZi = [
            "甲子", "乙丑", "丙寅", "丁卯", "戊辰", "己巳", "庚午", "辛未", "壬申", "癸酉",
            "甲戌", "乙亥", "丙子", "丁丑", "戊寅", "己卯", "庚辰", "辛巳", "壬午", "癸未",
            "甲申", "乙酉", "丙戌", "丁亥", "戊子", "己丑", "庚寅", "辛卯", "壬辰", "癸巳",
            "甲午", "乙未", "丙申", "丁酉", "戊戌", "己亥", "庚子", "辛丑", "壬寅", "癸卯",
            "甲辰", "乙巳", "丙午", "丁未", "戊申", "己酉", "庚戌", "辛亥", "壬子", "癸丑",
            "甲寅", "乙卯", "丙辰", "丁巳", "戊午", "己未", "庚申", "辛酉", "壬戌", "癸亥"
        ];

        // Simplified weights for demo
        const yearWeightsMap = {
            "甲子": 12, "丙子": 16, "戊子": 15, "庚子": 7, "壬子": 5,
            "乙丑": 9, "丁丑": 8, "己丑": 7, "辛丑": 7, "癸丑": 7,
            "丙寅": 6, "戊寅": 8, "庚寅": 9, "壬寅": 9, "甲寅": 12,
            "丁卯": 7, "己卯": 19, "辛卯": 12, "癸卯": 12, "乙卯": 8,
            "戊辰": 12, "庚辰": 12, "壬辰": 10, "甲辰": 8, "丙辰": 8,
            "己巳": 5, "辛巳": 6, "癸巳": 7, "乙巳": 7, "丁巳": 6,
            "庚午": 9, "壬午": 8, "甲午": 15, "丙午": 13, "戊午": 19,
            "辛未": 8, "癸未": 7, "乙未": 6, "丁未": 5, "己未": 6,
            "壬申": 7, "甲申": 5, "丙申": 5, "戊申": 14, "庚申": 8,
            "癸酉": 8, "乙酉": 15, "丁酉": 14, "己酉": 5, "辛酉": 16,
            "甲戌": 15, "丙戌": 6, "戊戌": 14, "庚戌": 9, "壬戌": 10,
            "乙亥": 9, "丁亥": 16, "己亥": 9, "辛亥": 17, "癸亥": 6
        };
        const monthWeights = [6, 7, 18, 9, 5, 16, 9, 15, 18, 8, 9, 5];
        const dayWeights = [5, 10, 8, 15, 16, 15, 8, 16, 8, 16, 9, 17, 8, 17, 10, 8, 9, 18, 5, 15, 10, 9, 8, 9, 15, 18, 7, 8, 16, 6];
        const timeWeights = { "zi": 16, "chou": 6, "yin": 7, "mao": 10, "chen": 9, "si": 16, "wu": 10, "wei": 8, "shen": 8, "you": 9, "xu": 6, "hai": 6 };

        const poems = {
            male: {
                21: "短命非業謂大凶，平生災難事重重，兇禍頻臨限逆境，終世困苦事不成",
                22: "身寒骨冷苦伶仃，此命推來行乞人，勞勞碌碌無度日，中年打拱過平生",
                23: "此命推來骨輕輕，求謀做事事難成，妻兒兄弟應難許，別處他鄉作散人",
                24: "此命推來福祿無，門庭困苦總難榮，六親骨肉皆無靠，流到他鄉作老人",
                25: "此命推來祖業微，門庭營度似希奇，六親骨肉如水炭，一世勤勞自把持",
                26: "平生一路苦中求，獨自營謀事不休，離祖出門宜早計，晚來衣祿自無憂",
                27: "一生做事少商量，難靠祖宗作主張，獨馬單槍空作去，早年晚歲總無長",
                28: "一生作事似飄蓬，祖宗產業在夢中，若不過房並改姓，也當移徒二三通",
                29: "初年運限未曾亨，縱有功名在後成，須過四旬方可上，移居改姓使為良",
                30: "勞勞碌碌苦中求，東走西奔何日休，若能終身勤與儉，老來稍可免憂愁",
                31: "忙忙碌碌苦中求，何日雲開見日頭，難得祖基家可立，中年衣食漸無憂",
                32: "初年運錯事難謀，漸有財源如水流，到的中年衣食旺，那時名利一齊來",
                33: "早年做事事難成，百計徒勞枉費心，半世自如流水去，後來運到始得金",
                34: "此命福氣果如何，僧道門中衣祿多，離祖出家方得妙，終朝拜佛念彌陀",
                35: "生平福量不周全，祖業根基覺少傳，營事生涯宜守舊，時來衣食勝從前",
                36: "不須勞碌過平生，獨自成家福不輕，早有福星常照命，任君行去百般成",
                37: "此命般般事不成，弟兄少力自孤成，雖然祖業須微有，來的明時去的暗",
                38: "一生骨肉最清高，早入學門姓名標，待看年將三十六，藍衣脫去換紅袍",
                39: "此命終身運不通，勞勞做事盡皆空，苦心竭力成家計，到得那時在夢中",
                40: "平生衣祿是綿長，件件心中自主張，前面風霜都受過，從來必定享安泰",
                41: "此命推來事不同，為人能幹異凡庸，中年還有逍遙福，不比前年雲未通",
                42: "得寬懷處且寬懷，何用雙眉總不開，若使中年命運濟，那時名利一齊來",
                43: "為人心性最聰明，做事軒昂近貴人，衣祿一生天數定，不須勞碌是豐亨",
                44: "來事由天莫苦求，須知福祿勝前途，當年財帛難如意，晚景欣然便不憂",
                45: "福中取貴格求真，明敏才華志自伸，福祿壽全家道吉，桂蘭毓秀晚榮臻",
                46: "東西南北盡皆通，出姓移名更覺隆，衣祿無虧天數定，中年晚景一般同",
                47: "此命推來旺末年，妻榮子貴自怡然，平生原有滔滔福，可有財源如水流",
                48: "幼年運道未曾享，苦是蹉跎再不興，兄弟六親皆無靠，一身事業晚年成",
                49: "此命推來福不輕，自立自成顯門庭，從來富貴人親近，使婢差奴過一生",
                50: "為利為名終日勞，中年福祿也多遭，老來是有財星照，不比前番目下高",
                51: "一世榮華事事通，不須勞碌自亨通，兄弟叔侄皆如意，家業成時福祿宏",
                52: "一世亨通事事能，不須勞思自然能，宗施欣然心皆好，家業豐亨自稱心",
                53: "此格推來氣象真，興家發達在其中，一生福祿安排定，卻是人間一富翁",
                54: "此命推來厚且清，詩書滿腹看功成，豐衣足食自然穩，正是人間有福人",
                55: "走馬揚鞭爭名利，少年做事廢籌論，一朝福祿源源至，富貴榮華顯六親",
                56: "此格推來禮儀通，一生福祿用無窮，甜酸苦辣皆嚐過，財源滾滾穩且豐",
                57: "福祿盈盈萬事全，一生榮耀顯雙親，名揚威震人欽敬，處世逍遙似遇春",
                58: "平生福祿自然來，名利兼全福祿偕，雁塔提名為貴客，紫袍金帶走金鞋",
                59: "細推此格妙且清，必定才高禮儀通，甲第之中應有分，揚鞭走馬顯威榮",
                60: "一朝金榜快題名，顯祖榮宗立大功，衣食定然原欲足，田園財帛更豐盈",
                61: "不做朝中金榜客，定為世上一財翁，聰明天賦經書熟，名顯高克自是榮",
                62: "此名生來福不窮，讀書必定顯親榮，紫衣金帶為卿相，富貴榮華皆可同",
                63: "命主為官福祿長，得來富貴定非常，名題金塔傳金榜，定中高科天下揚",
                64: "此格權威不可當，紫袍金帶坐高堂，榮華富貴誰能及，積玉堆金滿儲倉",
                65: "細推此命福不輕，安國安邦極品人，文繡雕樑政富貴，威聲照耀四方聞",
                66: "此格人間一福人，堆金積玉滿堂春，從來富貴由天定，正笏垂紳謁聖君",
                67: "此名生來福自宏，田園家業最高隆，平生衣祿豐盈足，一世榮華萬事通",
                68: "富貴由天莫苦求，萬金家計不須謀，十年不比前番事，祖業根基水上舟",
                69: "君是人間衣祿星，一生福貴眾人欽，縱然福祿由天定，安享榮華過一生",
                70: "此命推來福不輕，不須愁慮苦勞心，一生天定衣與祿，富貴榮華過一生",
                71: "此名生來大不同，公侯卿相在其中，一生自有逍遙福，富貴榮華極品隆",
                72: "此格世界罕有生，十代積善產此人，天上紫微來照命，統治萬民樂太平"
            },
            female: {
                21: "短命非業謂大空，平生災難事重重。兇禍頻臨陷逆境，終世困苦事不成。",
                22: "此命孤冷有淒伶，此命推來路乞人。操心煩腦度平日，一生育苦度光陰。",
                23: "此命推來骨肉輕，求財謀事事難成。弟妹六親無有靠，繁鞝家事難以持。",
                24: "此命推來福祿無，家務辛苦難以扶。丈夫兒女皆無靠，流落他鄉作游孤。",
                25: "此命推來八字輕，六庭艱辛多苦淒。娘家六友冷如灰，一生操勞多憂心。",
                26: "平生衣祿苦尋求，女命生來帶憂愁。辛酸苦辣他嚐過，晚年衣缽本無憂。",
                27: "竹平做事少間量，難靠夫君做主張。心問口來口問心，自做主張過光陰。",
                28: "女命生來八字經，得善做事一無情。你把別人當親生，別人對你假殷情。",
                29: "花枝要來性情硬，自奔自立不求人。若向求財方可止，有苦有甜度光陰。",
                30: "此命推來比郎強，婚姻大事礙無防。中年走過坎坷運，末年漸比先前強。",
                31: "早年行運在忙碌，勞碌奔波苦中求。自奔自愁把家立，後來晚景無憂愁。",
                32: "時逢吉神在運中，縱有兇處不為兇。真變假來假變真，結拜弟妹當親生。",
                33: "八字命來張張薄，勤儉持家皆可過。年華巴如流水過，末年運至受福祿。",
                34: "矮巴勾棗難撈枝，好人尋命不投機。謀望獻身最費力，婚姻同移總是虛。",
                35: "女子走冰怕冰薄，交易出行犯琢磨。婚姻周郎休此意，官司口舌須要知。",
                36: "憂愁常鎖兩眉間，女命萬緒掛心頭。從今以後防口角，任意行而不相天。",
                37: "此命來時運費多，此作推車受折磨。山路崎嶇吊下耳，左插右安安不著。",
                38: "鳳鳴岐山聞四方，女命逢之大吉昌。走失夫君音有信，晚年衣祿人財多。",
                39: "此命推來運不通，勞碌奔波一場空。好像俊鳥關籠中，中年末限起秋風。",
                40: "目上月令如運關，千心萬苦受煎熬。女子苦難受過來，晚年福康比花艷。",
                41: "此命推來普普通通，女子為人很非凡。中年逍遙多自在，晚年更比中年強。",
                42: "枯井破廢已多年，一朝泉水出來鮮。資生濟竭人稱美，來運轉喜自然時。",
                43: "推車靠涯道路趕，女命求財也費難。婚姻出行無陰礙，疾病口舌多安寧。",
                44: "夜夢金銀醒來空，女子謀事運不能。婚姻難成交易獲，夫君走失不見蹤。",
                45: "此命終身駁雜多，六親骨肉不相助。命中男婦都難養，勞碌辛苦還奔波。",
                46: "孤舟得水離沙灘，女命出外早遠家。是非口舌皆無礙，婚姻合夥更不差。",
                47: "時來運轉吉氣發，多年枯木又開花。枝葉重生多茂盛，凡人見了凡人夸。",
                48: "一朵鮮花鏡中開，看著極好取不來。勸你休把鏡花想，女命推業主可怪。",
                49: "此命推來福不輕，女子隨君顯門庭。容貌美滿熱人愛，銀錢富足過一生。",
                50: "馬氏太公不相和，好命逢之尤凝多。恩人無義反成怨，是非平地起風波。",
                51: "肥羊失群入山崗，餓虎逢之把口張。適口充腸心歡喜，女名八安大吉昌。",
                52: "順風行舟扯起棚，上天又助一順風。不用費力逍遙去，任意而行大亨通。",
                53: "此命相貌眉活秀，文武雙全功名成。一生衣祿皆無愁，可算世上有福人。",
                54: "學問滿腹運氣強，謀望求財大吉祥。交易出行大得意，是非口舌皆無妨。",
                55: "吉祥平安志量高，女命求財任逍遙。交易婚姻大有意，夫君在外有音耗。",
                56: "明珠書士離埃來，女命口角消散開。走失郎君當兩歸，交易有成水無災。",
                57: "游魚戲水被網驚，跳過龍門秧化龍。三根楊柳垂金線，萬朵桃花顯價能。",
                58: "此命推來閒逛悠，時運未來莫強求。幸得今日重反點，自有好運在後頭。",
                59: "雨雪載途泥濘至，交易不定難出行。疾病還拉慢婚姻，謀望求財事不成。",
                60: "女命八字喜氣和，謀望求財吉慶多。口舌漸消疾病少，夫君走失歸老窩。",
                61: "緣木求魚事多端，雖不得魚無後害。若是行險弄巧地，事不遂心枉安排。",
                62: "指日升高氣象新，走失待人有音信。好命遇事遂心好，伺病口舌皆除根。",
                63: "五官脫運難抬頭，女命須當把財求。交易少行有人助，疾病口舌不須愁。",
                64: "俊鳥曾得出籠中，脫離災難顯威風。一朝得意福立至，東南西北任意行。",
                65: "此命推來福不輕，慈善為事受人敬。天降文王開基業，富貴榮華八百年。",
                66: "時來運轉銳氣周，賢惠淑女君子求。釧鼓樂之大吉慶，女名逢之吉悠悠。",
                67: "亂絲無頭定有頭，碰著閒磨且暫推。交易出有無好處，謀事求財心不遂。",
                68: "水庭明月不可撈，女命早限命不高。交易出行難獲得，末限命運漸漸好。",
                69: "太公封祖不非凡，女子求財穩如山。交易合夥大吉慶，疾病口角消除安。",
                70: "此命推來喜氣新，郎君遇著多遂心。女命交了順當運，富貴衣祿平樂生。",
                71: "此命推來鴻運交，再不需愁來苦勞。一生身有衣祿福，按享榮華在其中。"
            }
        };

        // Lunar Calendar Helper (Legacy compressed data)
        const lunarInfo = [0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2, 0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977, 0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970, 0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950, 0x04da0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557, 0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5d0, 0x14573, 0x052d0, 0x0a9a8, 0x0e950, 0x06aa0, 0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0, 0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b5a0, 0x195a6, 0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570, 0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0, 0x0c960, 0x0d954, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5, 0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930, 0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530, 0x05aa0, 0x076a3, 0x096d0, 0x04bd7, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45, 0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0, 0x14b63];

        function getLunarYearDays(y) {
            let i, sum = 348;
            for (i = 0x8000; i > 0x8; i >>= 1) sum += (lunarInfo[y - 1900] & i) ? 1 : 0;
            return (sum + leapDays(y));
        }
        function leapDays(y) {
            if (leapMonth(y)) return ((lunarInfo[y - 1900] & 0x10000) ? 30 : 29);
            else return (0);
        }
        function leapMonth(y) {
            return (lunarInfo[y - 1900] & 0xf);
        }
        function monthDays(y, m) {
            return ((lunarInfo[y - 1900] & (0x10000 >> m)) ? 30 : 29);
        }
        function solarToLunar(objDate) {
            let i, leap = 0, temp = 0;
            let offset = (Date.UTC(objDate.getFullYear(), objDate.getMonth(), objDate.getDate()) - Date.UTC(1900, 0, 31)) / 86400000;
            let dayCyl = offset + 40;
            let monCyl = 14;
            for (i = 1900; i < 2051 && offset > 0; i++) { temp = getLunarYearDays(i); offset -= temp; monCyl += 12; }
            if (offset < 0) { offset += temp; i--; monCyl -= 12; }
            let year = i;
            let yearCyl = i - 1864;
            leap = leapMonth(i);
            let isLeap = false;
            for (i = 1; i < 13 && offset > 0; i++) {
                if (leap > 0 && i == (leap + 1) && isLeap == false) { --i; isLeap = true; temp = leapDays(year); }
                else { temp = monthDays(year, i); }
                if (isLeap == true && i == (leap + 1)) isLeap = false;
                offset -= temp;
                if (isLeap == false) monCyl++;
            }
            if (offset == 0 && leap > 0 && i == leap + 1) { if (isLeap) { isLeap = false; } else { isLeap = true; --i; --monCyl; } }
            if (offset < 0) { offset += temp; --i; --monCyl; }
            return { y: year, m: i, d: offset + 1, isLeap: isLeap };
        }

        // Init
        window.onload = function () {
            populateYears();
            populateMonths();
            populateDays();

            // Re-bind listeners
            document.querySelectorAll('input[name="calendarType"]').forEach(el => {
                el.addEventListener('change', () => {
                    populateYears();
                    populateMonths();
                });
            });
        };

        function populateYears() {
            const isSolar = document.querySelector('input[name="calendarType"][value="solar"]').checked;
            const select = document.getElementById('inputYear');
            select.innerHTML = '';
            for (let i = 1900; i <= 2050; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = i;
                if (i === 1990) opt.selected = true;
                select.appendChild(opt);
            }
        }
        function populateMonths() {
            const select = document.getElementById('inputMonth');
            select.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                let opt = document.createElement('option');
                opt.value = i;
                opt.text = i < 10 ? '0' + i : i;
                select.appendChild(opt);
            }
        }
        function populateDays() {
            const select = document.getElementById('inputDay');
            select.innerHTML = '';
            for (let i = 1; i <= 31; i++) {
                let opt = document.createElement('option');
                opt.value = i;
                opt.text = i < 10 ? '0' + i : i;
                select.appendChild(opt);
            }
        }

        function calculateBazi() {
            const gender = document.querySelector('input[name="gender"]:checked').value;
            const isSolar = document.querySelector('input[name="calendarType"][value="solar"]').checked;

            let y = parseInt(document.getElementById('inputYear').value);
            let m = parseInt(document.getElementById('inputMonth').value);
            let d = parseInt(document.getElementById('inputDay').value);
            const timeKey = document.getElementById('inputTime').value;

            let lunarYearGZ = "";
            let finalY, finalM, finalD;

            if (isSolar) {
                const solarDate = new Date(y, m - 1, d);
                if (solarDate.getMonth() !== m - 1) { alert("日期無效"); return; }
                const lObj = solarToLunar(solarDate);
                finalY = lObj.y; finalM = lObj.m; finalD = lObj.d;

                let idx = (finalY - 4) % 60;
                if (idx < 0) idx += 60;
                lunarYearGZ = jiaZi[idx];
            } else {
                finalY = y; finalM = m; finalD = d;
                let idx = (y - 4) % 60;
                if (idx < 0) idx += 60;
                lunarYearGZ = jiaZi[idx];
            }

            const wYear = yearWeightsMap[lunarYearGZ] || 0;
            const wMonth = monthWeights[finalM - 1] || 0;
            const wDay = dayWeights[finalD - 1] || 0;
            const wTime = timeWeights[timeKey] || 0;
            const totalQian = wYear + wMonth + wDay + wTime;

            const liang = Math.floor(totalQian / 10);
            const qian = totalQian % 10;

            // Update UI
            document.getElementById('totalWeightDisplay').innerText = `${liang}兩 ${qian}錢`;
            document.getElementById('yearW').innerText = (wYear / 10).toFixed(1);
            document.getElementById('monthW').innerText = (wMonth / 10).toFixed(1);
            document.getElementById('dayW').innerText = (wDay / 10).toFixed(1);
            document.getElementById('timeW').innerText = (wTime / 10).toFixed(1);

            // Update Pillar (Year Only - others are placeholder)
            document.getElementById('pillarYear').innerText = lunarYearGZ;

            // Get Poem
            let poemText = "暫無此重量之批註。";
            if (gender === 'male' && poems.male[totalQian]) poemText = poems.male[totalQian];
            else if (gender === 'female' && poems.female[totalQian]) poemText = poems.female[totalQian];

            // Poem & Analysis Display
            // Split poem into parts for "Main Poem" and "Detailed Analysis"
            poemText = poemText.replace(/。/g, "，");
            const parts = poemText.split("，").filter(p => p.trim() !== "");

            // 1. Main Poem Box (Join all parts)
            document.getElementById('mainPoem').innerText = parts.join("，") + "。";

            // 2. Detailed Breakdown
            const analysisContainer = document.getElementById('poemAnalysis');
            analysisContainer.innerHTML = '';

            parts.forEach((line, index) => {
                if (!line) return;
                const div = document.createElement('div');

                // Generate a fake "meaning" for the demo layout
                let explanation = "此句為詩中之詳解，描述了命主在不同階段的運勢變化與性格特徵。";
                if (index === 0) explanation = "代表你的性格正直、清高，不屑於做些偷雞摸狗或違背良心的事情，有文人的風骨。";
                if (index === 1) explanation = "意味著你求學成績優異，年輕時就可考取功名，或在學術、專業領域嶄露頭角。";
                if (index === 2) explanation = "人生的一個轉折點，代表運勢在此時會有重大的突破或轉變。";
                if (index === 3) explanation = "實位晉升的象徵。從低階職位（藍袍）晉升為高階職位（紅袍），寓意事業高升。";

                div.innerHTML = `
                    <h4 class="text-red-700 font-bold mb-2 text-sm">${line}</h4>
                    <p class="text-gray-600 text-sm leading-relaxed">${explanation}</p>
                    ${index < parts.length - 1 ? '<div class="dashed-line"></div>' : ''}
                 `;
                analysisContainer.appendChild(div);
            });

            const resArea = document.getElementById('resultArea');
            resArea.classList.remove('hidden');
            resArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>

</html>