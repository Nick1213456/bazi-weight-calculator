<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>袁天罡稱骨算命</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
        
        :root {
            --primary-red: #9B2C2C;
            --accent-gold: #D4AF37;
            --bg-paper: #FDFBF7;
            --text-main: #2D3748;
        }

        body {
            font-family: 'Noto Serif TC', serif;
            background-color: #f0e6d2;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            color: var(--text-main);
        }

        .main-card {
            background-color: var(--bg-paper);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .input-group label {
            color: #742a2a;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239B2C2C' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1em;
        }

        .btn-primary {
            background: linear-gradient(to bottom, #9B2C2C, #742a2a);
            border: 1px solid #742a2a;
        }
        .btn-primary:hover {
            background: linear-gradient(to bottom, #742a2a, #531d1d);
        }

        /* 表格風格結果區 */
        .result-table-container {
            border: 2px solid #742a2a;
            background-color: #fff;
        }
        .result-header {
            background-color: #742a2a;
            color: #fff;
            text-align: center;
            font-weight: bold;
            padding: 10px;
            font-size: 1.25rem;
            letter-spacing: 0.1em;
        }
        .result-row {
            display: flex;
            border-bottom: 1px solid #742a2a;
        }
        .result-row:last-child {
            border-bottom: none;
        }
        .result-label {
            background-color: #fef2f2;
            color: #742a2a;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #742a2a;
        }
        .result-content {
            padding: 16px;
            display: flex;
            align-items: center;
        }
        .poem-lines {
            line-height: 2;
            text-align: justify;
            font-size: 1.1rem;
            width: 100%;
        }

        /* 隱藏表格，改用 Grid */
        .ref-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background-color: #e2e8f0;
            border: 1px solid #e2e8f0;
        }
        .ref-cell {
            background-color: #fff;
            padding: 8px;
            text-align: center;
        }
        .ref-header {
            background-color: #fff5f5;
            color: #742a2a;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen py-10 px-4">

    <div class="max-w-2xl mx-auto main-card rounded-lg overflow-hidden relative">
        <div class="bg-red-900 p-8 text-center relative overflow-hidden">
            <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')]"></div>
            <h1 class="text-3xl md:text-4xl font-bold text-yellow-100 tracking-widest relative z-10" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">袁天罡稱骨算命</h1>
            <p class="text-red-200 mt-2 text-sm relative z-10">預知一生榮枯 · 掌握命運玄機</p>
        </div>

        <div class="p-6 md:p-10 space-y-8">
            
            <div class="space-y-6">
                <!-- Gender & Calendar Toggle -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="block mb-2 text-sm">您的性別</label>
                        <div class="flex bg-gray-100 rounded-md p-1">
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="gender" value="male" checked class="peer hidden">
                                <span class="block py-2 rounded text-sm text-gray-500 peer-checked:bg-white peer-checked:text-red-900 peer-checked:shadow-sm transition-all font-bold">男命</span>
                            </label>
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="gender" value="female" class="peer hidden">
                                <span class="block py-2 rounded text-sm text-gray-500 peer-checked:bg-white peer-checked:text-red-900 peer-checked:shadow-sm transition-all font-bold">女命</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="block mb-2 text-sm">曆法依據</label>
                        <div class="flex bg-gray-100 rounded-md p-1">
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="calendarType" value="lunar" checked onchange="toggleCalendarType()" class="peer hidden">
                                <span class="block py-2 rounded text-sm text-gray-500 peer-checked:bg-white peer-checked:text-red-900 peer-checked:shadow-sm transition-all font-bold">農曆</span>
                            </label>
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="calendarType" value="solar" onchange="toggleCalendarType()" class="peer hidden">
                                <span class="block py-2 rounded text-sm text-gray-500 peer-checked:bg-white peer-checked:text-red-900 peer-checked:shadow-sm transition-all font-bold">國曆</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Date Selection -->
                <div class="space-y-4">
                    <div class="input-group">
                        <label class="block mb-1" id="yearLabel">出生年份 (農曆)</label>
                        <select id="inputYear" class="custom-select w-full bg-white border border-gray-300 rounded-md px-4 py-3 text-gray-700 focus:outline-none focus:border-red-800 focus:ring-1 focus:ring-red-800 transition-colors">
                            <!-- JS Populated -->
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="block mb-1" id="monthLabel">月份</label>
                            <select id="inputMonth" class="custom-select w-full bg-white border border-gray-300 rounded-md px-4 py-3 text-gray-700 focus:outline-none focus:border-red-800 transition-colors">
                                <!-- JS Populated -->
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="block mb-1" id="dayLabel">日期</label>
                            <select id="inputDay" class="custom-select w-full bg-white border border-gray-300 rounded-md px-4 py-3 text-gray-700 focus:outline-none focus:border-red-800 transition-colors">
                                <!-- JS Populated -->
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="block mb-1">時辰</label>
                        <select id="inputTime" class="custom-select w-full bg-white border border-gray-300 rounded-md px-4 py-3 text-gray-700 focus:outline-none focus:border-red-800 transition-colors">
                            <option value="zi">子時 (23:00 - 00:59)</option>
                            <option value="chou">丑時 (01:00 - 02:59)</option>
                            <option value="yin">寅時 (03:00 - 04:59)</option>
                            <option value="mao">卯時 (05:00 - 06:59)</option>
                            <option value="chen">辰時 (07:00 - 08:59)</option>
                            <option value="si">巳時 (09:00 - 10:59)</option>
                            <option value="wu">午時 (11:00 - 12:59)</option>
                            <option value="wei">未時 (13:00 - 14:59)</option>
                            <option value="shen">申時 (15:00 - 16:59)</option>
                            <option value="you">酉時 (17:00 - 18:59)</option>
                            <option value="xu">戌時 (19:00 - 20:59)</option>
                            <option value="hai">亥時 (21:00 - 22:59)</option>
                        </select>
                    </div>
                </div>

                <button onclick="calculateBazi()" class="btn-primary w-full text-white font-bold text-lg py-4 rounded-md shadow-lg transform active:scale-[0.99] transition-transform">
                    開始算命
                </button>
            </div>

            <!-- Result Section -->
            <div id="resultArea" class="hidden animate-[fadeIn_0.8s_ease-out]">
                <!-- Calculation Breakdown (Simple) -->
                <div class="text-center mb-6">
                     <p class="text-gray-500 text-xs mb-2">
                        <span id="dateDisplay"></span>
                    </p>
                    <div class="flex justify-center gap-2 flex-wrap text-sm text-gray-600">
                        <span>年骨: <b id="yearW"></b></span> ·
                        <span>月骨: <b id="monthW"></b></span> ·
                        <span>日骨: <b id="dayW"></b></span> ·
                        <span>時骨: <b id="timeW"></b></span>
                    </div>
                </div>

                <!-- Main Table-Style Result -->
                <div class="result-table-container shadow-md">
                    <div class="result-header" id="resultTitle">八字重量命解說</div>
                    <!-- Header Row -->
                    <div class="result-row bg-red-50 text-red-900 border-b border-red-800">
                         <div class="w-1/4 text-center py-2 font-bold border-r border-red-800">命重</div>
                         <div class="w-3/4 text-center py-2 font-bold">命運描述</div>
                    </div>
                    <!-- Data Row -->
                    <div class="result-row">
                        <div class="result-label w-1/4 text-xl">
                            <span id="totalWeightDisplay"></span>
                        </div>
                        <div class="result-content w-3/4 bg-white">
                            <div id="poemContent" class="poem-lines text-gray-800">
                                <!-- Poem -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reference Table Toggle -->
            <div class="mt-8">
                <button onclick="toggleReference()" class="w-full text-center text-gray-500 text-sm hover:text-red-800 transition-colors flex items-center justify-center gap-2">
                    <span>查看八字骨重對照表</span>
                    <span class="text-xs font-bold">[+]</span>
                </button>

                <div id="referenceTable" class="hidden mt-4 space-y-6 text-sm">
                    <div class="bg-white p-4 rounded border">
                        <h4 class="font-bold text-red-800 mb-2 text-center">年份骨重 (六十甲子)</h4>
                        <div class="ref-grid text-xs">
                            <div class="ref-cell ref-header">生肖/年份</div><div class="ref-cell ref-header">骨重</div>
                            <div class="ref-cell ref-header">生肖/年份</div><div class="ref-cell ref-header">骨重</div>
                            <div class="ref-cell">鼠 (甲子)</div><div class="ref-cell">1兩2</div>
                            <div class="ref-cell">馬 (甲午)</div><div class="ref-cell">1兩5</div>
                            <div class="ref-cell">鼠 (丙子)</div><div class="ref-cell">1兩6</div>
                            <div class="ref-cell">馬 (丙午)</div><div class="ref-cell">1兩3</div>
                            <div class="ref-cell col-span-4 text-gray-400 italic">... (詳細數據依程式計算為準) ...</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <div class="text-center mt-6 text-gray-400 text-xs font-serif">
        <p>袁天罡稱骨算命 · 僅供參考</p>
    </div>

    <script>
        // --- CALENDAR LOGIC (1900-2100) ---
        // Hex values representing lunar month sizes and leap months for each year
        // Format: [LeapMonth][MonthSizes bitmask 12-1] (Last 4 bits are leap month info if any, mostly legacy format adapted here)
        // Simplified Solar-to-Lunar helper
        const lunarInfo = [
            0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2, //1900-1909
            0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977, //1910-1919
            0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970, //1920-1929
            0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950, //1930-1939
            0x04da0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557, //1940-1949
            0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,0x06aa0, //1950-1959
            0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0, //1960-1969
            0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b5a0,0x195a6, //1970-1979
            0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570, //1980-1989
            0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x055c0,0x0ab60,0x096d5,0x092e0, //1990-1999
            0x0c960,0x0d954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5, //2000-2009
            0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930, //2010-2019
            0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530, //2020-2029
            0x05aa0,0x076a3,0x096d0,0x04bd7,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45, //2030-2039
            0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0, //2040-2049
            0x14b63 //2050
        ];

        // Basic Lunar Helpers
        function getLunarYearDays(y) {
            let i, sum = 348;
            for(i=0x8000; i>0x8; i>>=1) sum += (lunarInfo[y-1900] & i)? 1: 0;
            return(sum + leapDays(y));
        }
        function leapDays(y) {
            if(leapMonth(y)) return((lunarInfo[y-1900] & 0x10000)? 30: 29);
            else return(0);
        }
        function leapMonth(y) {
            return(lunarInfo[y-1900] & 0xf);
        }
        function monthDays(y,m) {
            return( (lunarInfo[y-1900] & (0x10000>>m))? 30: 29 );
        }
        
        function solarToLunar(objDate) {
            let i, leap=0, temp=0;
            let offset = (Date.UTC(objDate.getFullYear(), objDate.getMonth(), objDate.getDate()) - Date.UTC(1900,0,31))/86400000;

            let dayCyl = offset + 40;
            let monCyl = 14;

            for(i=1900; i<2051 && offset>0; i++) {
                temp = getLunarYearDays(i);
                offset -= temp;
                monCyl += 12;
            }

            if(offset<0) {
                offset += temp;
                i--;
                monCyl -= 12;
            }

            let year = i;
            let yearCyl = i-1864;

            leap = leapMonth(i); 
            let isLeap = false;

            for(i=1; i<13 && offset>0; i++) {
                // Leap month
                if(leap>0 && i==(leap+1) && isLeap==false) { --i; isLeap = true; temp = leapDays(year); }
                else { temp = monthDays(year, i); }

                // Note: decrement offset
                if(isLeap==true && i==(leap+1)) isLeap = false;
                
                offset -= temp;
                if(isLeap == false) monCyl ++;
            }

            if(offset==0 && leap>0 && i==leap+1) {
                if(isLeap) { isLeap = false; }
                else { isLeap = true; --i; --monCyl;}
            }

            if(offset<0){ offset += temp; --i; --monCyl; }

            return {
                y: year,
                m: i,
                d: offset + 1,
                isLeap: isLeap
            };
        }

        // --- BAZI DATA ---
        const jiaZi = [
            "甲子", "乙丑", "丙寅", "丁卯", "戊辰", "己巳", "庚午", "辛未", "壬申", "癸酉",
            "甲戌", "乙亥", "丙子", "丁丑", "戊寅", "己卯", "庚辰", "辛巳", "壬午", "癸未",
            "甲申", "乙酉", "丙戌", "丁亥", "戊子", "己丑", "庚寅", "辛卯", "壬辰", "癸巳",
            "甲午", "乙未", "丙申", "丁酉", "戊戌", "己亥", "庚子", "辛丑", "壬寅", "癸卯",
            "甲辰", "乙巳", "丙午", "丁未", "戊申", "己酉", "庚戌", "辛亥", "壬子", "癸丑",
            "甲寅", "乙卯", "丙辰", "丁巳", "戊午", "己未", "庚申", "辛酉", "壬戌", "癸亥"
        ];
        
        // Year Weights (using map for lookup)
        const yearWeightsMap = {
            "甲子": 12, "丙子": 16, "戊子": 15, "庚子": 7, "壬子": 5,
            "乙丑": 9, "丁丑": 8, "己丑": 7, "辛丑": 7, "癸丑": 7,
            "丙寅": 6, "戊寅": 8, "庚寅": 9, "壬寅": 9, "甲寅": 12,
            "丁卯": 7, "己卯": 19, "辛卯": 12, "癸卯": 12, "乙卯": 8,
            "戊辰": 12, "庚辰": 12, "壬辰": 10, "甲辰": 8, "丙辰": 8,
            "己巳": 5, "辛巳": 6, "癸巳": 7, "乙巳": 7, "丁巳": 6,
            "庚午": 9, "壬午": 8, "甲午": 15, "丙午": 13, "戊午": 19,
            "辛未": 8, "癸未": 7, "乙未": 6, "丁未": 5, "己未": 6,
            "壬申": 7, "甲申": 5, "丙申": 5, "戊申": 14, "庚申": 8,
            "癸酉": 8, "乙酉": 15, "丁酉": 14, "己酉": 5, "辛酉": 16,
            "甲戌": 15, "丙戌": 6, "戊戌": 14, "庚戌": 9, "壬戌": 10,
            "乙亥": 9, "丁亥": 16, "己亥": 9, "辛亥": 17, "癸亥": 6
        };
        const monthWeights = [6, 7, 18, 9, 5, 16, 9, 15, 18, 8, 9, 5];
        const dayWeights = [
            5, 10, 8, 15, 16, 15, 8, 16, 8, 16,
            9, 17, 8, 17, 10, 8, 9, 18, 5, 15,
            10, 9, 8, 9, 15, 18, 7, 8, 16, 6
        ];
        const timeWeights = {
            "zi": 16, "chou": 6, "yin": 7, "mao": 10, "chen": 9, "si": 16,
            "wu": 10, "wei": 8, "shen": 8, "you": 9, "xu": 6, "hai": 6
        };

        const poems = {
            male: {
                21: "短命非業謂大凶，平生災難事重重，兇禍頻臨限逆境，終世困苦事不成",
                22: "身寒骨冷苦伶仃，此命推來行乞人，勞勞碌碌無度日，中年打拱過平生",
                23: "此命推來骨輕輕，求謀做事事難成，妻兒兄弟應難許，別處他鄉作散人",
                24: "此命推來福祿無，門庭困苦總難榮，六親骨肉皆無靠，流到他鄉作老人",
                25: "此命推來祖業微，門庭營度似希奇，六親骨肉如水炭，一世勤勞自把持",
                26: "平生一路苦中求，獨自營謀事不休，離祖出門宜早計，晚來衣祿自無憂",
                27: "一生做事少商量，難靠祖宗作主張，獨馬單槍空作去，早年晚歲總無長",
                28: "一生作事似飄蓬，祖宗產業在夢中，若不過房並改姓，也當移徒二三通",
                29: "初年運限未曾亨，縱有功名在後成，須過四旬方可上，移居改姓使為良",
                30: "勞勞碌碌苦中求，東走西奔何日休，若能終身勤與儉，老來稍可免憂愁",
                31: "忙忙碌碌苦中求，何日雲開見日頭，難得祖基家可立，中年衣食漸無憂",
                32: "初年運錯事難謀，漸有財源如水流，到的中年衣食旺，那時名利一齊來",
                33: "早年做事事難成，百計徒勞枉費心，半世自如流水去，後來運到始得金",
                34: "此命福氣果如何，僧道門中衣祿多，離祖出家方得妙，終朝拜佛念彌陀",
                35: "生平福量不周全，祖業根基覺少傳，營事生涯宜守舊，時來衣食勝從前",
                36: "不須勞碌過平生，獨自成家福不輕，早有福星常照命，任君行去百般成",
                37: "此命般般事不成，弟兄少力自孤成，雖然祖業須微有，來的明時去的暗",
                38: "一生骨肉最清高，早入學門姓名標，待看年將三十六，藍衣脫去換紅袍",
                39: "此命終身運不通，勞勞做事盡皆空，苦心竭力成家計，到得那時在夢中",
                40: "平生衣祿是綿長，件件心中自主張，前面風霜都受過，從來必定享安泰",
                41: "此命推來事不同，為人能幹異凡庸，中年還有逍遙福，不比前年雲未通",
                42: "得寬懷處且寬懷，何用雙眉總不開，若使中年命運濟，那時名利一齊來",
                43: "為人心性最聰明，做事軒昂近貴人，衣祿一生天數定，不須勞碌是豐亨",
                44: "來事由天莫苦求，須知福祿勝前途，當年財帛難如意，晚景欣然便不憂",
                45: "福中取貴格求真，明敏才華志自伸，福祿壽全家道吉，桂蘭毓秀晚榮臻",
                46: "東西南北盡皆通，出姓移名更覺隆，衣祿無虧天數定，中年晚景一般同",
                47: "此命推來旺末年，妻榮子貴自怡然，平生原有滔滔福，可有財源如水流",
                48: "幼年運道未曾享，苦是蹉跎再不興，兄弟六親皆無靠，一身事業晚年成",
                49: "此命推來福不輕，自立自成顯門庭，從來富貴人親近，使婢差奴過一生",
                50: "為利為名終日勞，中年福祿也多遭，老來是有財星照，不比前番目下高",
                51: "一世榮華事事通，不須勞碌自亨通，兄弟叔侄皆如意，家業成時福祿宏",
                52: "一世亨通事事能，不須勞思自然能，宗施欣然心皆好，家業豐亨自稱心",
                53: "此格推來氣象真，興家發達在其中，一生福祿安排定，卻是人間一富翁",
                54: "此命推來厚且清，詩書滿腹看功成，豐衣足食自然穩，正是人間有福人",
                55: "走馬揚鞭爭名利，少年做事廢籌論，一朝福祿源源至，富貴榮華顯六親",
                56: "此格推來禮儀通，一生福祿用無窮，甜酸苦辣皆嚐過，財源滾滾穩且豐",
                57: "福祿盈盈萬事全，一生榮耀顯雙親，名揚威震人欽敬，處世逍遙似遇春",
                58: "平生福祿自然來，名利兼全福祿偕，雁塔提名為貴客，紫袍金帶走金鞋",
                59: "細推此格妙且清，必定才高禮儀通，甲第之中應有分，揚鞭走馬顯威榮",
                60: "一朝金榜快題名，顯祖榮宗立大功，衣食定然原欲足，田園財帛更豐盈",
                61: "不做朝中金榜客，定為世上一財翁，聰明天賦經書熟，名顯高克自是榮",
                62: "此名生來福不窮，讀書必定顯親榮，紫衣金帶為卿相，富貴榮華皆可同",
                63: "命主為官福祿長，得來富貴定非常，名題金塔傳金榜，定中高科天下揚",
                64: "此格權威不可當，紫袍金帶坐高堂，榮華富貴誰能及，積玉堆金滿儲倉",
                65: "細推此命福不輕，安國安邦極品人，文繡雕樑政富貴，威聲照耀四方聞",
                66: "此格人間一福人，堆金積玉滿堂春，從來富貴由天定，正笏垂紳謁聖君",
                67: "此名生來福自宏，田園家業最高隆，平生衣祿豐盈足，一世榮華萬事通",
                68: "富貴由天莫苦求，萬金家計不須謀，十年不比前番事，祖業根基水上舟",
                69: "君是人間衣祿星，一生福貴眾人欽，縱然福祿由天定，安享榮華過一生",
                70: "此命推來福不輕，不須愁慮苦勞心，一生天定衣與祿，富貴榮華過一生",
                71: "此名生來大不同，公侯卿相在其中，一生自有逍遙福，富貴榮華極品隆",
                72: "此格世界罕有生，十代積善產此人，天上紫微來照命，統治萬民樂太平"
            },
            female: {
                21: "短命非業謂大空，平生災難事重重。兇禍頻臨陷逆境，終世困苦事不成。",
                22: "此命孤冷有淒伶，此命推來路乞人。操心煩腦度平日，一生育苦度光陰。",
                23: "此命推來骨肉輕，求財謀事事難成。弟妹六親無有靠，繁鞝家事難以持。",
                24: "此命推來福祿無，家務辛苦難以扶。丈夫兒女皆無靠，流落他鄉作游孤。",
                25: "此命推來八字輕，六庭艱辛多苦淒。娘家六友冷如灰，一生操勞多憂心。",
                26: "平生衣祿苦尋求，女命生來帶憂愁。辛酸苦辣他嚐過，晚年衣缽本無憂。",
                27: "竹平做事少間量，難靠夫君做主張。心問口來口問心，自做主張過光陰。",
                28: "女命生來八字經，得善做事一無情。你把別人當親生，別人對你假殷情。",
                29: "花枝要來性情硬，自奔自立不求人。若向求財方可止，有苦有甜度光陰。",
                30: "此命推來比郎強，婚姻大事礙無防。中年走過坎坷運，末年漸比先前強。",
                31: "早年行運在忙碌，勞碌奔波苦中求。自奔自愁把家立，後來晚景無憂愁。",
                32: "時逢吉神在運中，縱有兇處不為兇。真變假來假變真，結拜弟妹當親生。",
                33: "八字命來張張薄，勤儉持家皆可過。年華巴如流水過，末年運至受福祿。",
                34: "矮巴勾棗難撈枝，好人尋命不投機。謀望獻身最費力，婚姻同移總是虛。",
                35: "女子走冰怕冰薄，交易出行犯琢磨。婚姻周郎休此意，官司口舌須要知。",
                36: "憂愁常鎖兩眉間，女命萬緒掛心頭。從今以後防口角，任意行而不相天。",
                37: "此命來時運費多，此作推車受折磨。山路崎嶇吊下耳，左插右安安不著。",
                38: "鳳鳴岐山聞四方，女命逢之大吉昌。走失夫君音有信，晚年衣祿人財多。",
                39: "此命推來運不通，勞碌奔波一場空。好像俊鳥關籠中，中年末限起秋風。",
                40: "目上月令如運關，千心萬苦受煎熬。女子苦難受過來，晚年福康比花艷。",
                41: "此命推來普普通通，女子為人很非凡。中年逍遙多自在，晚年更比中年強。",
                42: "枯井破廢已多年，一朝泉水出來鮮。資生濟竭人稱美，來運轉喜自然時。",
                43: "推車靠涯道路趕，女命求財也費難。婚姻出行無陰礙，疾病口舌多安寧。",
                44: "夜夢金銀醒來空，女子謀事運不能。婚姻難成交易獲，夫君走失不見蹤。",
                45: "此命終身駁雜多，六親骨肉不相助。命中男婦都難養，勞碌辛苦還奔波。",
                46: "孤舟得水離沙灘，女命出外早遠家。是非口舌皆無礙，婚姻合夥更不差。",
                47: "時來運轉吉氣發，多年枯木又開花。枝葉重生多茂盛，凡人見了凡人夸。",
                48: "一朵鮮花鏡中開，看著極好取不來。勸你休把鏡花想，女命推業主可怪。",
                49: "此命推來福不輕，女子隨君顯門庭。容貌美滿熱人愛，銀錢富足過一生。",
                50: "馬氏太公不相和，好命逢之尤凝多。恩人無義反成怨，是非平地起風波。",
                51: "肥羊失群入山崗，餓虎逢之把口張。適口充腸心歡喜，女名八安大吉昌。",
                52: "順風行舟扯起棚，上天又助一順風。不用費力逍遙去，任意而行大亨通。",
                53: "此命相貌眉活秀，文武雙全功名成。一生衣祿皆無愁，可算世上有福人。",
                54: "學問滿腹運氣強，謀望求財大吉祥。交易出行大得意，是非口舌皆無妨。",
                55: "吉祥平安志量高，女命求財任逍遙。交易婚姻大有意，夫君在外有音耗。",
                56: "明珠書士離埃來，女命口角消散開。走失郎君當兩歸，交易有成水無災。",
                57: "游魚戲水被網驚，跳過龍門秧化龍。三根楊柳垂金線，萬朵桃花顯價能。",
                58: "此命推來閒逛悠，時運未來莫強求。幸得今日重反點，自有好運在後頭。",
                59: "雨雪載途泥濘至，交易不定難出行。疾病還拉慢婚姻，謀望求財事不成。",
                60: "女命八字喜氣和，謀望求財吉慶多。口舌漸消疾病少，夫君走失歸老窩。",
                61: "緣木求魚事多端，雖不得魚無後害。若是行險弄巧地，事不遂心枉安排。",
                62: "指日升高氣象新，走失待人有音信。好命遇事遂心好，伺病口舌皆除根。",
                63: "五官脫運難抬頭，女命須當把財求。交易少行有人助，疾病口舌不須愁。",
                64: "俊鳥曾得出籠中，脫離災難顯威風。一朝得意福立至，東南西北任意行。",
                65: "此命推來福不輕，慈善為事受人敬。天降文王開基業，富貴榮華八百年。",
                66: "時來運轉銳氣周，賢惠淑女君子求。釧鼓樂之大吉慶，女名逢之吉悠悠。",
                67: "亂絲無頭定有頭，碰著閒磨且暫推。交易出有無好處，謀事求財心不遂。",
                68: "水庭明月不可撈，女命早限命不高。交易出行難獲得，末限命運漸漸好。",
                69: "太公封祖不非凡，女子求財穩如山。交易合夥大吉慶，疾病口角消除安。",
                70: "此命推來喜氣新，郎君遇著多遂心。女命交了順當運，富貴衣祿平樂生。",
                71: "此命推來鴻運交，再不需愁來苦勞。一生身有衣祿福，按享榮華在其中。"
            }
        };

        // --- INIT ---
        window.onload = function() {
            toggleCalendarType(); // Init UI based on default checked
        };

        function toggleCalendarType() {
            const isSolar = document.querySelector('input[name="calendarType"][value="solar"]').checked;
            
            // Labels
            document.getElementById('yearLabel').innerText = isSolar ? "出生年份 (國曆)" : "出生年份 (農曆)";
            
            // Populate Dropdowns
            populateYears(isSolar);
            populateMonths(isSolar);
            populateDays(isSolar);
        }

        function populateYears(isSolar) {
            const select = document.getElementById('inputYear');
            const savedVal = select.value;
            select.innerHTML = '';
            
            for (let i = 1900; i <= 2050; i++) {
                const ganZhiIndex = (i - 4) % 60;
                let idx = ganZhiIndex;
                if (idx < 0) idx += 60;
                
                const gz = jiaZi[idx];
                const option = document.createElement('option');
                option.value = i; // Store just the number for simpler logic
                
                if (isSolar) {
                     option.text = `${i}年`;
                } else {
                     option.text = `${i}年 (${gz})`;
                }
                
                if (i === 1990) option.selected = true;
                select.appendChild(option);
            }
            if(savedVal) select.value = savedVal; // Try to keep selection
        }
        
        function populateMonths(isSolar) {
            const select = document.getElementById('inputMonth');
            select.innerHTML = '';
            for(let i=1; i<=12; i++){
                const option = document.createElement('option');
                option.value = i;
                option.text = isSolar ? `${i}月` : (['正','二','三','四','五','六','七','八','九','十','十一','十二'][i-1] + '月');
                select.appendChild(option);
            }
        }

        function populateDays(isSolar) {
            const select = document.getElementById('inputDay');
            select.innerHTML = '';
            const count = isSolar ? 31 : 30; // Simplify, solar uses 31 max, validator not needed for simple weight tool
            
            const dayNamesLunar = ["初一","初二","初三","初四","初五","初六","初七","初八","初九","初十",
                              "十一","十二","十三","十四","十五","十六","十七","十八","十九","二十",
                              "廿一","廿二","廿三","廿四","廿五","廿六","廿七","廿八","廿九","三十"];
            
            for (let i = 1; i <= count; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = isSolar ? `${i}日` : (dayNamesLunar[i-1] || `${i}日`);
                select.appendChild(option);
            }
        }

        function toggleReference() {
            const ref = document.getElementById('referenceTable');
            ref.classList.toggle('hidden');
        }

        // --- LOGIC ---
        function calculateBazi() {
            const gender = document.querySelector('input[name="gender"]:checked').value;
            const isSolar = document.querySelector('input[name="calendarType"][value="solar"]').checked;
            
            let y = parseInt(document.getElementById('inputYear').value);
            let m = parseInt(document.getElementById('inputMonth').value);
            let d = parseInt(document.getElementById('inputDay').value);
            const timeKey = document.getElementById('inputTime').value;

            let displayDate = "";
            let lunarYearGZ = "";
            let finalY, finalM, finalD;

            // Conversion Logic
            if (isSolar) {
                const solarDate = new Date(y, m-1, d);
                // Validate date exists (e.g., Feb 31)
                if (solarDate.getMonth() !== m-1) {
                    alert("日期無效，請檢查輸入。");
                    return;
                }
                
                const lObj = solarToLunar(solarDate);
                finalY = lObj.y;
                finalM = lObj.m;
                finalD = lObj.d;
                
                // Calculate GanZhi for the Lunar Year
                const ganZhiIndex = (finalY - 4) % 60;
                let idx = ganZhiIndex < 0 ? ganZhiIndex + 60 : ganZhiIndex;
                lunarYearGZ = jiaZi[idx];
                
                displayDate = `國曆 ${y}年${m}月${d}日 (農曆 ${lunarYearGZ}年${lObj.isLeap?"閏":""}${finalM}月${finalD}日)`;
            } else {
                // Input is already Lunar
                finalY = y;
                finalM = m;
                finalD = d;
                
                const ganZhiIndex = (y - 4) % 60;
                let idx = ganZhiIndex < 0 ? ganZhiIndex + 60 : ganZhiIndex;
                lunarYearGZ = jiaZi[idx];
                
                displayDate = `農曆 ${y}年${m}月${d}日 (${lunarYearGZ}年)`;
            }

            // Weights
            const wYear = yearWeightsMap[lunarYearGZ] || 0;
            const wMonth = monthWeights[finalM - 1] || 0; // Lunar month 1 is index 0
            const wDay = dayWeights[finalD - 1] || 0;     // Lunar day 1 is index 0
            const wTime = timeWeights[timeKey] || 0;

            const totalQian = wYear + wMonth + wDay + wTime;
            const liang = Math.floor(totalQian / 10);
            const qian = totalQian % 10;
            
            document.getElementById('dateDisplay').innerText = displayDate;
            document.getElementById('yearW').innerText = formatWeight(wYear);
            document.getElementById('monthW').innerText = formatWeight(wMonth);
            document.getElementById('dayW').innerText = formatWeight(wDay);
            document.getElementById('timeW').innerText = formatWeight(wTime);

            document.getElementById('totalWeightDisplay').innerText = `${liang}兩${qian}錢`;
            
            // Set Table Title
            document.getElementById('resultTitle').innerText = gender === 'male' ? "八字重量男命解說" : "八字重量女命解說";

            const poemKey = totalQian; 
            let poemText = "暫無此重量之批註。";
            
            if (gender === 'male' && poems.male[poemKey]) {
                poemText = poems.male[poemKey];
            } else if (gender === 'female' && poems.female[poemKey]) {
                poemText = poems.female[poemKey];
            } else {
                if (totalQian > 72) poemText = "此命骨重極高，世間罕有，必是大貴之命。";
                else if (totalQian < 21) poemText = "此命骨重較輕，宜多行善積德以補運勢。";
            }

            // Enhanced Poem Formatting
            // 1. Remove trailing punctuation
            // 2. Replace commas/periods with break
            // 3. Ensure 4 lines
            
            let formattedPoem = poemText;
            
            // Normalize punctuation
            formattedPoem = formattedPoem.replace(/。/g, "，"); // Treat periods as commas for splitting
            const parts = formattedPoem.split("，").filter(p => p.trim() !== "");
            
            if (parts.length >= 4) {
                formattedPoem = parts.join("，<br>"); // Join back with visual breaks
                // Add final period if missing
                if (!formattedPoem.endsWith("。")) formattedPoem += "。";
            } else {
                // Fallback for non-standard poems
                 formattedPoem = poemText.replace(/，/g, "，<br>").replace(/。/g, "。<br>");
            }

            document.getElementById('poemContent').innerHTML = formattedPoem;

            const resArea = document.getElementById('resultArea');
            resArea.classList.remove('hidden');
            resArea.scrollIntoView({behavior: 'smooth', block: 'start'});
        }

        function formatWeight(q) {
            const l = Math.floor(q / 10);
            const remainder = q % 10;
            if (l > 0 && remainder > 0) return `${l}兩${remainder}`;
            if (l > 0) return `${l}兩`;
            return `${remainder}錢`;
        }
    </script>
</body>
</html>
